%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
\chapter{\emph{Abjad}: a model of notation}
\label{chap:a-model-of-notation}
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%

\begin{markdown}

Abjad models notation.

# The illustration protocol

-   print()
-   repr() and __repr__()
-   str() and __str__()
-   format() and __format__()
-   show() and __illustrate__()
-   graph() and __graph__()

# Components, indicators & spanners

Abjad models notated musical scores as a *tree* consisting of *components*,
*indicators* and *spanners*.

Components make up the *nodes* of the score tree, treating the score as an
acyclic directed rooted graph, or *arborescence*, rooted on a single component.

All components inherit from Abjad's `Component` class, which encapsulates logic
crucial to maintaining the correctness of the score tree, and affords behaviors
common to all component subclasses. MORE.

Abjad divides score components into *containers* -- those components which may
contain other other components, such as staves, voices, tuplets, measures and
so forth -- and *leaves* -- those components which may contain no other
components, such as notes, chords and rests, as well as LilyPond's
multi-measure rests and non-printing typographic *skips*.

Abjad's containers implement Python's *mutable sequence protocol*, allowing
them to be used transparently as though they were lists. Components can be
appended, extended, or inserted into a container just like lists. Likewise,
containers can be indexed, measured for length and iterated over.

Note that Abjad's `Chord` class aggregates multiple *note heads* rather than
notes. Likewise Abjad's `Note` class aggregates a single note head. While
chords implement containment in terms of note heads, delegating to a dedicated
note head inventory, they are not themselves "containers" in the same sense
that a voice, measure or tuplet are containers.

-   describe and demonstrate instantiation and simple aggregation

Abjad's *inspector* exposes a component's *inspection interface*, a
collection of methods for accessing information about that component, many of
which depend on that components position within the score hierarchy, such as
its parentage and duration.

-   list some behaviors, introduce inspect_()
-   why inspect? many accessors depend on the *context* of a component in the
    tree

Every components may have one and no more than one parent container in the
score tree. Any component whose parent is null is necessarily the root of its
tree. Furthermore, no component may appear in its own *proper parentage* -- the
sequence of components comprising the unique path from a given component to the
root of its tree, excepting the component itself -- as this would induce
reference cycles within the score tree.

-   demonstrate simple parentage inspection

Abjad object-models the concept of parentage explicitly as a `Parentage`
*selection* class, accessible via Abjad's *inspector*.

Every component may be expressed in terms of their duration, offset and
timespan.

The duration of each leaf derives from the product of its *written duration*
-- a duration representing the actual glyphs used in the score as represented
by some combination of note heads, stems, beams and dots -- and their
*prolation* -- the cumulative product of all of the duration multipliers of the
containers in a component's proper parentage.

-   demonstrate prolation property of parentage

\end{markdown}

Written durations must be \emph{assignable}. Assignability describes the set of
durations describable in Western common practice notation solely through
combining a single note head, its flags and dots, without recourse to ties or
tuplets. Any rational duration $\sfrac{n}{d}$ is considered assignable when and only
when it adheres to the form

\begin{equation}
{ 2^k * (2^u - j) \over 2^v }
\end{equation}

\noindent where $u$, $v$ and $k$ are nonnegative integers, $j \leq
u$ and $j$ is either 1 or 0.

Assignability guarantees that a duration's denominator is always a positive
power-of-two integer, such as 1, 2, 4, 8, 16 and so forth, and therefore
precludes durations such as $\sfrac{1}{3}$ or $\sfrac{2}{5}$. Likewise,
assignability permits numerators such as 1, 2, 3, 4, 6, 7, 8, 12, 14 and 15 but
forbids 5, 9, 10, 13 and 17, as they imply ties.

\begin{markdown}

The duration of each container then derives from the product of its prolation
and its *contents duration* -- the sum of the durations of its children.
Ultimately, all scores derive their durations from the durations of their
leaves, prolated as necessary by any tuplets.

Every component may be named.

## Components

-   components, leaves, containers (and contexts)
-   components are formattable and illustrable 
-   components are mutable, while indicators are generally not
    -   likewise, durations and pitches are immutable
    
-   count-time components
    -   note, chord, rest, skip, container, tuplet, measure
-   non-count-time (contexts)
    -   voice, staff, staff group, score

-   leaves do not contain anything else
    -   chord do *not* contain notes
    -   chords and notes contain note heads
    -   chord and notes share a single stem
    -   this must be disambiguated from note columns

-   all containers derive their duration from their contents (with some
    exceptions, but even there a mismatch is an error)
-   written duration, prolated duration, pre-prolated duration, contents
    duration

-   One, and only one, parent per component. They *cannot* be in more than one
    container. This is both confusing, and liable to cause reference problems.
-   score hierarchy is not fixed: any node is the root, if it has no parent

-   contexts are assumed to last from the beginning to the end of the total
    timespan of the score, but in practice they may be intermittent
-   contexts may be named, allowing concatenation

-   Leaves reside at the "bottom" of the score hierarchy.

### Inspection

Work aspects of this into appropriate sections

-   inspect_()
-   not *inspect()*, as that would cause a name conflict with Python's inspect
    module
-   inspect(...).get_parentage()
-   inspect_(...).get_duration()
    -   in_seconds=True
-   inspect_(...).get_timespan()
    -   in_seconds=True

## Indicators

Indicators attach to individual components

-   some have notational reality
-   some have context scope
-   but they can be totally arbitrary

-   attach(x, y, scope=..., is_annotation=..., name=...)

-   Articulation
-   BarLine
-   Clef
-   Dynamic
-   KeySignature
-   Markup
-   Tempo
-   TimeSignature

-   What is scope?
-   Default scope
-   Explicit scope

-   Idiomatic indicators, used by other processes:
    -   BowContactPoint
    -   IsAtSoundingPitch
    -   IsUnpitched
    -   StringContactPoint
    -   StringTuning
    -   etc.
-   Annotation
-   attach(x, y, is_annotation=True)

-   inspect_(...).get_indicator()
-   inspect_(...).has_indicator()
-   inspect_(...).get_effective()
-   inspect_(...).has_effective_indicator()

## Spanners

Spanners *span* across different levels of hierarchy.

-   logical voices
-   attach to  

-   graph cyclicity
-   Beam
-   Glissando
-   Hairpin
-   Slur
-   Trill
-   Tie

-   typographic overrides

# Typographic overrides

-   On components
    - \\override & \\revert
-   On spanners

# Modeling time

-   Duration
-   Offset
-   Multiplier
-   Timespan
-   Prolation
-   Pre-prolated durations
-   Contents duration

# Modeling pitch

## Pitch representations

-   The most important distinction is between *named* and *numbered* pitch
    objects.
-   All pitched score components (notes and chords) rely on *named*
    representations of pitch, not numbered
-   *Named* pitch objects are enharmonically explicit
-   *Numbered* pitch objects require some interpretation
-   Abjad has provided one interpretation, but that is for sufficiency
-   Abjad does *not* make smart guesses about converting numbered to named
    pitches

-   NamedPitch
-   NumberedPitch
-   NamedPitchClass
-   NumberedPitchClass

-   NamedInterval
-   NumberedInterval
-   NamedIntervalClass
-   NumberedIntervalClass
-   NamedInversionEquivalentIntervalClass
-   NumberedInversionEquivalentIntervalClass

## Pitch collections

-   Set, Segment, Vector
-   Pitch, PitchClass, Interval, IntervalClass

-   PitchSegment
-   PitchClassSegment

## Pitch operators

## Other pitch modeling concepts

-   Accidental
-   Octave
-   PitchRange
-   StaffPosition

## Inspecting leaf pitches

-   Note("c'4").written_pitch
-   Note("c'4").note_head.written_pitch
-   Chord("<c' e' g'>4").written_pitches
-   inspect_(note).get_sounding_pitch()
-   inspect_(note).get_sounding_pitches()

# Navigating through score

## Indexing

-   By name
-   By index
-   By slice

## Selection

-   select()
-   Selection class
-   Container.select_leaves()
    -   allow_discontiguous_leaves=True
-   inspect_(...).get_logical_tie()
-   LogicalTie
    -   head
    -   tail
    -   timespan
    -   trivial logical ties

## Iteration

-   By __iter__()
-   By iterate(...)by_...()
    -   by_class()
    -   by_logical_tie()
    -   by_run()
    -   by_timeline()
    -   by_vertical_moment()
    -   depth_first()

## Selectors

-   Demonstrate a gallery of selectors.
    -   by duration
    -   by leaves
    -   by length
    -   by logical tie
    -   by counts (with negative counts too)

# Notation factories

-   rhythm-makers
-   score templates
-   parsers
    -   LilyPond parser
    -   PLY
    -   SchemeParser
    -   RhythmTreeParser
    -   ReducedLyParser

\end{markdown}

\section{Examples}

\begin{comment}
<abjad>
upper_voice = Voice(name='Upper Voice')
upper_staff = Staff([upper_voice], name='Upper Staff')
lower_voice_a = Voice(name='Lower Voice A')
lower_voice_b = Voice(name='Lower Voice B')
lower_staff = Staff([lower_voice_a, lower_voice_b], name='Lower Staff')
piano_staff = StaffGroup([upper_staff, lower_staff], context_name='PianoStaff')
</abjad>
\end{comment}

\begin{abjadbookoutput}
\begin{singlespacing}
\vspace{-0.5\baselineskip}
\begin{lstlisting}
>>> upper_voice = Voice(name='Upper Voice')
>>> upper_staff = Staff([upper_voice], name='Upper Staff')
>>> lower_voice_a = Voice(name='Lower Voice A')
>>> lower_voice_b = Voice(name='Lower Voice B')
>>> lower_staff = Staff([lower_voice_a, lower_voice_b], name='Lower Staff')
>>> piano_staff = StaffGroup([upper_staff, lower_staff], context_name='PianoStaff')
\end{lstlisting}
\end{singlespacing}
\end{abjadbookoutput}

\begin{comment}
<abjad>
note = Note("fs'4.")
show(note)
</abjad>
\end{comment}

\begin{abjadbookoutput}
\begin{singlespacing}
\vspace{-0.5\baselineskip}
\begin{lstlisting}
>>> note = Note("fs'4.")
>>> show(note)
\end{lstlisting}
\noindent\includegraphics[max width=\textwidth,]{assets/lilypond-3899aee7438e42c8270d14ffdc03cb30.pdf}
\end{singlespacing}
\end{abjadbookoutput}

\begin{comment}
<abjad>
note = Note(6, (3, 8))
show(note)
</abjad>
\end{comment}

\begin{abjadbookoutput}
\begin{singlespacing}
\vspace{-0.5\baselineskip}
\begin{lstlisting}
>>> note = Note(6, (3, 8))
>>> show(note)
\end{lstlisting}
\noindent\includegraphics[max width=\textwidth,]{assets/lilypond-3899aee7438e42c8270d14ffdc03cb30.pdf}
\end{singlespacing}
\end{abjadbookoutput}

\begin{comment}
<abjad>
chord = Chord("<c'' ef'' g''>2")
show(chord)
</abjad>
\end{comment}

\begin{abjadbookoutput}
\begin{singlespacing}
\vspace{-0.5\baselineskip}
\begin{lstlisting}
>>> chord = Chord("<c'' ef'' g''>2")
>>> show(chord)
\end{lstlisting}
\noindent\includegraphics[max width=\textwidth,]{assets/lilypond-82ef35ebb9d559540a877d9291a02ca8.pdf}
\end{singlespacing}
\end{abjadbookoutput}

\begin{comment}
<abjad>
chord = Chord((12, 15, 19), (1, 2))
show(chord)
</abjad>
\end{comment}

\begin{abjadbookoutput}
\begin{singlespacing}
\vspace{-0.5\baselineskip}
\begin{lstlisting}
>>> chord = Chord((12, 15, 19), (1, 2))
>>> show(chord)
\end{lstlisting}
\noindent\includegraphics[max width=\textwidth,]{assets/lilypond-82ef35ebb9d559540a877d9291a02ca8.pdf}
\end{singlespacing}
\end{abjadbookoutput}

\begin{comment}
<abjad>
rest = Rest("r4")
show(rest)
</abjad>
\end{comment}

\begin{abjadbookoutput}
\begin{singlespacing}
\vspace{-0.5\baselineskip}
\begin{lstlisting}
>>> rest = Rest("r4")
>>> show(rest)
\end{lstlisting}
\noindent\includegraphics[max width=\textwidth,]{assets/lilypond-78f6872e9c498f4e522a51716ff458dd.pdf}
\end{singlespacing}
\end{abjadbookoutput}

\begin{comment}
<abjad>
rest = Rest((1, 4))
show(rest)
</abjad>
\end{comment}

\begin{abjadbookoutput}
\begin{singlespacing}
\vspace{-0.5\baselineskip}
\begin{lstlisting}
>>> rest = Rest((1, 4))
>>> show(rest)
\end{lstlisting}
\noindent\includegraphics[max width=\textwidth,]{assets/lilypond-78f6872e9c498f4e522a51716ff458dd.pdf}
\end{singlespacing}
\end{abjadbookoutput}

\begin{comment}
<abjad>
multimeasure_rest = scoretools.MultimeasureRest(1)
show(multimeasure_rest)
</abjad>
\end{comment}

\begin{abjadbookoutput}
\begin{singlespacing}
\vspace{-0.5\baselineskip}
\begin{lstlisting}
>>> multimeasure_rest = scoretools.MultimeasureRest(1)
>>> show(multimeasure_rest)
\end{lstlisting}
\noindent\includegraphics[max width=\textwidth,]{assets/lilypond-099f7141431afa5ae3a046415764f35b.pdf}
\end{singlespacing}
\end{abjadbookoutput}

\begin{comment}
<abjad>
skip = scoretools.Skip(1)
show(skip)
</abjad>
\end{comment}

\begin{abjadbookoutput}
\begin{singlespacing}
\vspace{-0.5\baselineskip}
\begin{lstlisting}
>>> skip = scoretools.Skip(1)
>>> show(skip)
\end{lstlisting}
\noindent\includegraphics[max width=\textwidth,]{assets/lilypond-23f5992f0758dbf9cdee4ac0a923bc09.pdf}
\end{singlespacing}
\end{abjadbookoutput}

\begin{comment}
<abjad>
note.note_head
note.note_head.is_cautionary = True
show(note)
</abjad>
\end{comment}

\begin{abjadbookoutput}
\begin{singlespacing}
\vspace{-0.5\baselineskip}
\begin{lstlisting}
>>> note.note_head
NoteHead("fs'")
\end{lstlisting}
\begin{lstlisting}
>>> note.note_head.is_cautionary = True
>>> show(note)
\end{lstlisting}
\noindent\includegraphics[max width=\textwidth,]{assets/lilypond-cb1badca7eef4417a7ce0afba8009a29.pdf}
\end{singlespacing}
\end{abjadbookoutput}

\begin{comment}
<abjad>
for note_head in chord.note_heads:
    note_head

chord.note_heads.append("a'")
show(chord)
</abjad>
\end{comment}

\begin{abjadbookoutput}
\begin{singlespacing}
\vspace{-0.5\baselineskip}
\begin{lstlisting}
>>> for note_head in chord.note_heads:
...     note_head
...
NoteHead("c''")
NoteHead("ef''")
NoteHead("g''")
\end{lstlisting}
\begin{lstlisting}
>>> chord.note_heads.append("a'")
>>> show(chord)
\end{lstlisting}
\noindent\includegraphics[max width=\textwidth,]{assets/lilypond-f6ffc8242c578f619b7b053e9eab2333.pdf}
\end{singlespacing}
\end{abjadbookoutput}

\begin{comment}
<abjad>
show(multimeasure_rest)
attach(Multiplier(4), multimeasure_rest)
show(multimeasure_rest)
</abjad>
\end{comment}

\begin{abjadbookoutput}
\begin{singlespacing}
\vspace{-0.5\baselineskip}
\begin{lstlisting}
>>> show(multimeasure_rest)
\end{lstlisting}
\noindent\includegraphics[max width=\textwidth,]{assets/lilypond-099f7141431afa5ae3a046415764f35b.pdf}
\begin{lstlisting}
>>> attach(Multiplier(4), multimeasure_rest)
>>> show(multimeasure_rest)
\end{lstlisting}
\noindent\includegraphics[max width=\textwidth,]{assets/lilypond-a8fdc5cae1a0a9fb72680a5d18862c4e.pdf}
\end{singlespacing}
\end{abjadbookoutput}

\begin{comment}
<abjad>
pitch_segment = pitchtools.PitchSegment("c' ef' b' bf' f' e' b a")
show(pitch_segment)
</abjad>
\end{comment}

\begin{abjadbookoutput}
\begin{singlespacing}
\vspace{-0.5\baselineskip}
\begin{lstlisting}
>>> pitch_segment = pitchtools.PitchSegment("c' ef' b' bf' f' e' b a")
>>> show(pitch_segment)
\end{lstlisting}
\noindent\includegraphics[max width=\textwidth,]{assets/lilypond-98c254b3bf3525db1108455a9eb836a7.pdf}
\end{singlespacing}
\end{abjadbookoutput}

\begin{comment}
<abjad>
transposition = pitchtools.Transposition(1)
show(transposition(pitch_segment))
</abjad>
\end{comment}

\begin{abjadbookoutput}
\begin{singlespacing}
\vspace{-0.5\baselineskip}
\begin{lstlisting}
>>> transposition = pitchtools.Transposition(1)
>>> show(transposition(pitch_segment))
\end{lstlisting}
\noindent\includegraphics[max width=\textwidth,]{assets/lilypond-749c176dfaf42985bd3b0d224300b46a.pdf}
\end{singlespacing}
\end{abjadbookoutput}

\begin{comment}
<abjad>
inversion = pitchtools.Inversion()
show(inversion(pitch_segment))
inversion_with_axis = pitchtools.Inversion(axis=NamedPitch("d'"))
show(inversion_with_axis(pitch_segment))
</abjad>
\end{comment}

\begin{abjadbookoutput}
\begin{singlespacing}
\vspace{-0.5\baselineskip}
\begin{lstlisting}
>>> inversion = pitchtools.Inversion()
>>> show(inversion(pitch_segment))
\end{lstlisting}
\noindent\includegraphics[max width=\textwidth,]{assets/lilypond-f5dccecbacdc176c5636cb8662091fbd.pdf}
\begin{lstlisting}
>>> inversion_with_axis = pitchtools.Inversion(axis=NamedPitch("d'"))
>>> show(inversion_with_axis(pitch_segment))
\end{lstlisting}
\noindent\includegraphics[max width=\textwidth,]{assets/lilypond-3788337f7ed0f9f5205ea317fef25ba7.pdf}
\end{singlespacing}
\end{abjadbookoutput}

\begin{comment}
<abjad>
retrogression = pitchtools.Retrogression()
show(retrogression(pitch_segment))
</abjad>
\end{comment}

\begin{abjadbookoutput}
\begin{singlespacing}
\vspace{-0.5\baselineskip}
\begin{lstlisting}
>>> retrogression = pitchtools.Retrogression()
>>> show(retrogression(pitch_segment))
\end{lstlisting}
\noindent\includegraphics[max width=\textwidth,]{assets/lilypond-deb23384afe7501bded563186defeabd.pdf}
\end{singlespacing}
\end{abjadbookoutput}

\begin{comment}
<abjad>
untransposing_rotation = pitchtools.Rotation(-1, transpose=False)
show(untransposing_rotation(pitch_segment))
transposing_rotation = pitchtools.Rotation(-1, transpose=True)
show(transposing_rotation(pitch_segment))
</abjad>
\end{comment}

\begin{abjadbookoutput}
\begin{singlespacing}
\vspace{-0.5\baselineskip}
\begin{lstlisting}
>>> untransposing_rotation = pitchtools.Rotation(-1, transpose=False)
>>> show(untransposing_rotation(pitch_segment))
\end{lstlisting}
\noindent\includegraphics[max width=\textwidth,]{assets/lilypond-a64fe671be8f551e1d653f00a83a2e07.pdf}
\begin{lstlisting}
>>> transposing_rotation = pitchtools.Rotation(-1, transpose=True)
>>> show(transposing_rotation(pitch_segment))
\end{lstlisting}
\noindent\includegraphics[max width=\textwidth,]{assets/lilypond-7bd7aa6d7685f24919cad726cee57c04.pdf}
\end{singlespacing}
\end{abjadbookoutput}

\begin{comment}
<abjad>
multiplication = pitchtools.Multiplication(3)
show(multiplication(pitch_segment))
</abjad>
\end{comment}

\begin{abjadbookoutput}
\begin{singlespacing}
\vspace{-0.5\baselineskip}
\begin{lstlisting}
>>> multiplication = pitchtools.Multiplication(3)
>>> show(multiplication(pitch_segment))
\end{lstlisting}
\noindent\includegraphics[max width=\textwidth,]{assets/lilypond-ea43de43da8ed2236bf38e48fab7ca25.pdf}
\end{singlespacing}
\end{abjadbookoutput}

\begin{comment}
<abjad>
pitch_operation = pitchtools.PitchOperation(
    operators=(
        pitchtools.Rotation(1),
        pitchtools.Transposition(2),
        ),
    )
show(pitch_operation(pitch_segment))
</abjad>
\end{comment}

\begin{abjadbookoutput}
\begin{singlespacing}
\vspace{-0.5\baselineskip}
\begin{lstlisting}
>>> pitch_operation = pitchtools.PitchOperation(
...     operators=(
...         pitchtools.Rotation(1),
...         pitchtools.Transposition(2),
...         ),
...     )
>>> show(pitch_operation(pitch_segment))
\end{lstlisting}
\noindent\includegraphics[max width=\textwidth,]{assets/lilypond-0adc9e231ee227673c0a09c603241ec2.pdf}
\end{singlespacing}
\end{abjadbookoutput}