%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
\chapter{\emph{Consort}: a model of composition}
\label{chap:a-model-of-composition}
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%

\begin{comment}
<abjad>[hide=true]
import collections
import consort
</abjad>
\end{comment}

\begin{comment}
\begin{markdown}
-   Materials
-   Configuration
-   Templating
-   Layers
-   Coarse to fine
-   Rhythm first
-   What is specification? What is a specifier? What is configuration and
    aggregation?
-   What should happen musically, where should it happen?
-   What is material?
-   What is music?
-   Rhythm is interpreted first, as all other parameters depend on it.
-   Rhythm is interpreted from "coarse" to "fine": from the level of phrase
    boundaries to the level of individual notes, rests, tuplets and ties.
-   This discussion only focuses on notation, nothing related to aesthetic
    experience, physical modeling or anything else. This is a tool for a
    specific composer to create scores, not a discussion explicitly of why they
    would work this way (although that should be discussed in the conclusion).
-   Specification and interpretation conceive of the score as a single, hugely
    complex expression.
-   Templating as variation.
-   Define what composition means here: laying out symbols on the page.
-   This way of thinking and working does not attempt to define or even model
    concepts like "melody" or even "phrase". They're too vague. If we use that
    terminology at all, it is only in the most incredibly constrained way.
\end{markdown}
\end{comment}

Consort, a Python library written as an extension to Abjad, models the
composition of notated musical score as a repeated cycle containing three
distinct stages: \emph{specification}, \emph{interpretation} and
\emph{visualization}.

What follows is a detailed analysis of the various algorithms and subroutines
employed during Consort's specification and interpretation stages.

\section{Specification}
\label{sec:specification}

\emph{Specification} describes how \emph{out-of-time materials} -- both
concrete and programmatic -- should be deployed \emph{in-time} in a
\emph{segment} of musical score as notation. Materials encompass abstractions
-- such as pitch sets or collections of performance technique indications --,
concrete fragments of \emph{music} -- narrowly defined here as any contiguous
selection of score components --, and procedures for producing, altering or
embellishing music such as rhythm-makers or attachment-handlers. Score segments
comprise any contiguous passage of music, demarcating an area of compositional
concern. Consort treats scores as comprised of at least one segment, but
potentially many more concatenated together. Any segment may of course contain
arbitrarily complex inner structuring. Separation of scores into distinct
segments acts then mainly as an aid for the composer, both by simplifying the
complexity of the current specification under consideration, and by allowing
the typesetting engine -- LilyPond -- to display more manageable amounts of
notation than the full score, thus speeding up the cycle of specifying,
interpreting and visualizing.

\subsection{Segment-makers}
\label{ssec:segment-makers}

\begin{markdown}
-   Permitted time signatures
-   Tempo
-   Desired duration
-   Score template
    -   LilyPond will automatically concatenate scores with identical
        context hierarchies. All contexts need to be present in every
        concatenated segment, otherwise LilyPond will concatenate
        incorrectly. However, we can use various typographic overrides to
        make it appear that a context has disappeared.
    -   Consort's ScoreTemplateManager helps create regularized score
        templates.
-   Music settings
\end{markdown}

Composers specify segments by creating and progressively configuring
\emph{segment-makers}, classes which conceptually mirror the rhythm- and
timespan-makers described in \autoref{chap:time-tools}, but on a much larger
scale. Such configuration parameters include score template, tempo, permitted
meters, and desired duration. Most importantly, segment-makers may be
configured with any number of \emph{music settings}, which aggregate a
timespan-maker, a target timespan and any number of \emph{music specifiers} --
bundles of materials which describe how phrases of music should be produced
within a single voice. 

\subsection{Music settings}
\label{ssec:music-settings}

\begin{markdown}
-   What kind of music, laid out in what pattern, in which general
    time frame, for which voices, in what layer?
-   A timespan-maker
-   A target timespan
    -   A timespan.
    -   A timespan inventory.
    -   A ratio/parts expression.
        -   Demonstrate. Check.
-   Voice abbreviation / music specifier pairs
    -   Why abbreviate? It's because of Python's key=value syntax for
        keyword arguments.
    -   How do we convert abbreviation to an actual context name?
        -   Score templates need to define a mapping.
        -   Demonstrate. Check.
    -   What is the context name for?
        -   Name-wise indexing in an actual score.
        -   Demonstrate. Check.
    -   Also, composite music specifiers: when two contexts need to be
        discussed as a single unit.
        -   Composite music specifiers need to convert one abbreviation into
            two more abbreviations, each mapped to an actual context name.
        -   Consort's ScoreTemplateManager takes care of calculating and
            caching the appropriate names and abbreviations.
-   Layer is implicit, derived from the order of setting definitions.
    -   Recall the discussion of timespan layer from earlier chapters.
\end{markdown}

Music settings object-model both \emph{when} and in
\emph{which} voices musical materials should be deployed. The order in which
composers configure segment-makers with music settings defines each music
setting's \emph{layer} -- the first setting defined being layer 0, the second
layer 1 and so forth, with each higher layer number indicating higher
precedence or \enquote{foregroundness} --, determining how overlapping events
in a single voice will mask one another. Score materials, including music
settings, music specifiers, timespan-makers and any other class pertinent to
score creation -- potentially even other segment-makers, may be defined from
scratch in the same code module as the segment-maker currently being
configured, templated from another material, or simply imported into the
segment definition's namespace.

\subsection{Music specifiers}
\label{ssec:music-specifiers}

Music specifiers bundle all of the information necessary for a segment-maker to
generate notation for a sequence of divisions, grouped as a phrase.

a rhythm-maker, grace-handler, pitch-handler and attachment-handler, as well as
a variety of other properties.

As demonstrated in \autoref{ssec:dependent-timespan-makers}, dependent
timespan-makers can be configured to create timespans according to the
disposition of performed timespans associated with specific voices.

Dependent timespan-makers can also be configured to select depended-upon
timespans based on the \texttt{label} property of those performed timespans'
music specifiers.

This helps model the situation of creating a pedal voice mirroring not simply a
pianist's left- and right-hand events, but only those that actually depress
keys, ignoring guero events or other off-the-key percussive techniques for
which no pedaling is desired.

\begin{markdown}
-   A bundle of descriptors for what kind of music should fill a series of
    1 or more timespans.
-   All of the descriptors are optional.
-   Rhythm-makers
-   Grace-handlers
-   Pitch-handlers
-   Attachment-handlers
-   Labels
    -   This works in tandem with DependentTimespanMaker.
    -   Example? Piano music with two hands and pedaling. The
        hand-performed music might involve key presses, or it might involve
        percussive techniques. All of the techniques that require pedaling
        should be labeled 'pedaled'. A DependentTimespanMaker for the pedal
        context can then be configured to look at timespans for both the LH
        and RH of the piano, but only those timespans configured with a
        music specifier labeled 'pedaled'.
    -   Demonstrate.
-   minimum phrase duration
    -   (should this be hoisted into PerformedTimespan?
-   seed
-   Composite music specifiers
\end{markdown}

A music specifier's \texttt{seed} property

A music specifier's \texttt{minimum\_phrase\_duration} property

\section{Interpretation}
\label{sec:interpretation}

At any point during specification, a segment-maker may be interpreted to
produce an illustration. Score interpretation proceeds conceptually much like
compilation in classical computing, where a compiler parses an instruction set
written in some source language into an intermediate representation and then
transforms that same intermediate representation into instructions executable
on a target platform. In Consort's interpretation stage, the compiler is the
segment-maker itself, and the source instruction set its configuration -- its
tempo, permitted meters, music settings and so forth. Timespan inventories
produced by each music setting's timespan-maker, populated with timespans
annotated with music specifiers perform the role of the intermediate
representation. This intermediate representation acts as a \emph{maquette},
blocking out where in the resulting score segment various materials should be
deployed. The target of score interpretation is, unsurprisingly, a fully-fledge
score aggregated from Abjad score components. Interpretation takes place in two
broad stages -- rhythmic interpretation, followed by non-rhythmic
interpretation -- with the first stage producing a score populated solely with
rhythmic information, and the second stage applying grace notes, pitches,
indicators, spanners and various typographic overrides to the
previously-constructed rhythmic skeleton.

\section{Rhythmic interpretation}
\label{sec:rhythmic-interpretation}

Seen from a high level, rhythmic interpretation proceeds from coarse- to
fine-grained. The segment-maker creates a *maquette* -- a model of the locations
of musical materials in the score -- by calling each of its
music-settings in turn to populate a timespan inventory. It then resolves
overlap conflicts within that inventory, fits meters against the resolved
inventory's offsets, splits and prunes the contents of the inventory according
to its fitted metrical structure, and finally converts the finished timespan
maquette into an actual score. This process, like interpretation overall, can
be roughly divided into work flows of \emph{maquette creation} and \emph{music
creation}, although in practice the two flows are interleaved significantly as
they actually influence one another. When creating the maquette, music settings
with \emph{independent} timespan-makers -- those which do not depend on the
contents of a previously created timespan inventory, specifically flooded and
talea timespan-makers -- are called in a first pass, and those with {dependent}
timespan-makers in a second. These two passes only differ significantly in that
meters are fitted against the segment's timespan maquette during the
independent timespan-maker pass, but not during the dependent.

\subsection{Populating the maquette}
\label{ssec:populating-the-maquette}

To populate the maquette, the segment-maker calls each of its music settings to
produce timespans according to their configured timespan-makers,
\emph{timespan-identifiers} -- optional specifications of which portion of the
segment's overall timespan to operate within -- and voice-associated music
specifiers. Timespan identifiers may include timespans, inventories of
timespans, or even expressions callable against the segment-makers own timespan
which evaluate to an inventory of timespans. 

Music settings exist without any reference to a segment-maker, its desired
duration -- and therefore desired timespan --, or its score template. In order
to know which target timespan or timespans a music setting's timespan-maker
should operate within -- in the case of procedural timespan identifiers such as
\emph{ratio-parts expressions} which must be called against a preexisting
timespan in order to determine what part or parts of that timespan to use --
the music setting must resolve its timespan identifier against the segment's
desired duration. Target timespan resolution must also take into account offset
quantization, as the target timespans resulting from the evaluation of a
ratio-parts expression may not align against a power-of-two-denominator offset
grid such as 1/8, 1/16 or 1/32. Because timespan-makers produce their output
relative to the start-offset of their target timespan, a misaligned target
timespan -- starting at an offset like 1/3 or 15/7 rather than 1/4 or 0 -- will
cause all generated timespans to be misaligned.

Music setting's associate their music specifiers with strings containing
voice-name abbreviations. These abbreviations are always underscore-delimited
strings such as \texttt{violin\_1} or \texttt{piano\_lh} -- necessitated by
Python's keyword argument syntax so that they can be used as keys during class
instantiation -- which represent voices in a score, without having established
a concrete reference to those voice contexts. In order to match its music
specifiers against actual voice contexts in a score, the music setting must
resolve its voice-name abbreviations against a score template, looking up each
abbreviation on the template and returning the real name of the associated
context. This lookup process allows music settings to construct well-formed
voice-name-to-music-specifier mappings, implemented as ordered dictionaries and
ordered by the actual *score index* -- effectively, the vertical location -- of
each looked-up context in the segment-maker's under-construction score. As
demonstrated in \autoref{sec:timespan-makers}, timespan-makers require these
mappings to produce their output. Additionally, voice-name resolution
guarantees that the values in the resolved voice-name-to-music-specifier
mapping are always either a \texttt{MusicSpecifierSequence} or
\texttt{CompositeMusicSpecifier} instance via coercion, where any composite
music-specifier's primary and secondary music specifiers are themselves coerced
into music specifier sequences. This coercion ensures that all arguments to the
music setting's timespan-maker are in a well-formed and predictable state.
\footnote{Timespan-makers actually delegate the creation of performed and
silent timespans to music specifier sequences. While not demonstrated
explicitly in \autoref{sec:timespan-makers}, this delegation allows
timespan-makers to use both music specifier sequences and composite music
specifiers interchangeably, with the former creating timespans associated with
one voice and the later with two. When the values of a timespan-maker's input
voice-name-to-music-specifier mapping are neither music specifier sequences nor
composite music specifiers -- as was the case in all of the examples in
\autoref{sec:timespan-makers} -- they implicitly coerce those values into music
specifier sequences.}

Once resolved, each music setting can call its timespan-maker to create
timespans with the appropriate voice-name-to-music-specifier mapping, target
timespans and layer, adding the contents of the resulting inventory to the
growing maquette of performed and silent timespans produced by previous music
settings. The populating process repeats until no more music settings remain.

\subsection{Finding meters, revisited}
\label{ssec:finding-meters-revisited}

Consort's segment-maker implements a variation on the meter-fitting algorithm
described in \autoref{sec:finding-meters}. Each segment-maker may be configured
with an inventory of permitted meters, as well as maximum meter run length, in
order to drive the meter fitting algorithm. When counting offsets,
segment-makers include the offsets found on the performed timespans in their
maquette but discard those from silent timespans, removing any influence from
timespans created solely for silencing other timespans. The start offset of
each performed timespan is weighed twice as much as their stop offset. This
imbalance helps emphasize simultaneous phrase starts across different voices.
Additionally, segment-maker's weight their own desired stop offset at a much
higher value than any count derived from the offsets in their maquette. This
attempts to influence the meter fitting process into selecting a series of
meters which end as close to their desired stop offset as possible. After
fitting meters, the segment-maker caches both the fitted meters and their
boundaries as properties on its instance, affording later retrieval by other
subroutines.

\subsection{Resolving cascading overlap}
\label{ssec:resolving-cascading-overlap}

\subsection{Splitting, pruning \& consolidation}
\label{ssec:splitting-pruning-and-consolidation}

Split at meter boundaries

Performed timespans may be configured with a \texttt{minimum\_duration}
property.

Timespan-makers and timespan specifiers

Why prune?

When notated with certain rhythm-makers, overly short divisions -- especially
those of 1/16-duration and smaller -- may give undesirable results.

Note that silent timespans have no configurable version of the same property.
Their \texttt{minimum\_duration} always returns 0. They maintain this dummy
property so that the segment-maker's timespan-pruning algorithms can treat
silent and performed timespans identically.

Prune malformed timespans, as a precaution

Consolidate contiguous performed timespans with identical music specifiers,
caching the durations of the consolidated timespans in a new timespan's
\texttt{divisions} property. The new timespan outlines the start and stop
offset of the consolidated group.

If the music specifier was configured with a minimum phrase duration, and the
consolidated timespan falls under that threshold, it is discarded.

\subsection{Inscription}
\label{ssec:inscription}

\begin{markdown}
-   Divisions
-   Get rhythm maker (under what circumstances?)
-   Make simple music
-   Consolidate rests
-   Rhythmic post-processing
    -   attaching a GeneralizedBeam
    -   attaching the scoped music specifier
-   Reconfigure the timespan with the created music, but without the divisions
\end{markdown}

\subsection{Meter pruning}
\label{ssec:meter-pruning}

After the timespan pruning outlined in
\autoref{ssec:splitting-pruning-and-consolidation}, and the possibility of gaps
introduced due to rest consolidation as outlined in \autoref{ssec:inscription},
the overall stop offset of the maquette -- not the stop offset derived from the
segment-maker's desired duration -- may have shifted earlier.

Depending on the degree of shift, timespans in the maquette may no longer occur
during one or more of the implicit timespans of the previously fitted meters.

Segment-makers may be configured to discard these silences via their
\texttt{discard\_final\_silence} property.

\subsection{Populating dependent timespans}
\label{ssec:populating-dependent-timespans}

The previous few passages, from \autoref{ssec:populating-the-maquette} through
\autoref*{ssec:meter-pruning}, describe the process of populating a
segment-makers's timespan maquette with the products of its *independent* music
settings -- those music settings whose timespan makers are independent, notably
flooded and talea timespan-makers.

With the maquette partially populated, those music settings with dependent
timespan-makers -- timespan-makers which generate timespans based on the
contents of a preexisting timespan inventory -- may finally be called to
provide their contributions to the maquette.

Dependent population proceeds almost identically to independent population with
a few notable differences.

\begin{markdown}
-   this occurs almost identically as with independent timespans,
    but without any meter finding
-   populate demultiplexed timespans
-   demultiplex
-   split at meter boundaries
-   consolidate
-   inscribe
\end{markdown}

\subsection{Populating silent timespans}
\label{ssec:populating-silent-timespans}

\begin{markdown}
-   creates timespans, splits and inscribes in one pass
-   there are no more layers to create, so no need to resolve overlap
    conflicts
\end{markdown}

\subsection{Rewriting meters}
\label{ssec:rewriting-meters}

\begin{markdown}
-   Meter timespans
-   Multi-measure rests
-   Staff line spanners for broken score appearance
-   Cleaning up logical ties
\end{markdown}

\subsection{Populating the score}
\label{ssec:populating-the-score}

Iterates through the maquette and unpopulated score in parallel, extracting the
inscribed music from each timespan in the maquette and inserting those phrases
into the score in the appropriate voice.

Additionally, a time-signature context is created and inserted at the top
of the score if the score does not already contain such a context.

The segment-maker populates this time-signature context with measures filled
with typographic spacer-skips, to create the appearance of floating
time-signature indications.

\subsection{Collecting attack points}

Many of the handlers used during non-rhythmic interpretation rely on
information about each pitched logical tie in the score.

Including the position of the logical tie's head in the score regardless of
voice -- its first leaf, and effectively its attack point -- as well as that
head's index both within the division it occurs within, as well as which
division within its phrase it occurs within.

\section{Non-rhythmic interpretation}

\subsection{Score traversal}

The various handlers which iterate through the score during non-rhythmic
interpretation use one of two techniques.

*Voice-wise* iterations iterates through all voice contexts in the score, then
iterates through the top-level containers in those voices. These top-level
containers are the same containers reference by each performed timespan's
\texttt{music} property, and represent each phrase in the maquette.

*Attack-point* iteration iterates through all logical ties in the score in
*time order* according to their start offset in the score, regardless of their
vertical position within the score. Logical ties with identical start offsets
-- those appearing at simultaneities across voices -- are then sorted by their
*score order*. This results in an iteration which moves first forward in time
and the top-of-score to bottom.

\subsection{Grace handlers}

Grace handlers attach *grace containers* to logical ties within a score in a
patterned way.

Abjad implements grace notes as normal leaves -- notes, chords and rests --
within special components which act both as Abjad \texttt{Container} classes as
well as attachable indicators. That is to say, grace notes must be placed
within one of these grace containers which is then attached to another leaf in
the score much like any other indicator, such as dynamics or articulations.

Grace-handlers traverse the score by logical tie in time-order, by iterating
over the previously cached ordered dictionary of attack-points, generated at
the end of rhythmic interpretation.

Discuss sub-optimal grace-note spacing in proportional notation?

\subsection{Pitch-handlers}
\label{ssec:pitch-handlers}

Pitch-handlers manage the process of applying pitch material to logical ties
within a score in a patterned way.

Pitch material may be semantic or non-semantic.

\begin{markdown}
-   Applies pitches to logical ties in a patterned way.
-   Applies pitches to grace notes associated with a logical tie.
-   Applies logical-tie-expressions which can convert logical ties from
    notes into chords, key-clusters or harmonics.
-   Processes the score time-wise by logical tie.
    -   The goal is to limit pitch class repetition both vertically and
        horizontally, but *only* with regard to phrases in the score scoped
        by each music specifier. Other phrases are not considered.
-   Application rate: by logical tie, division, phrase
    -   This requires the SeedSession class for keeping track of many
        seeds, each advancing at a potentially different rate.
    -   This also requires the AttackPointSignature class, which caches
        information about each logical tie's position in its parent
        division, phrase and overall segment.
-   MusicSpecifier: pitches are non-semantic (is this even used?)
-   Maps different patterns of pitches and different patterns of operations
    across the timeline.
    -   PitchHandler: `get_pitch_choice_timespans()`
    -   Demonstrate.
-   Can act on absolute pitches, or registered pitch classes.
-   Other formulations are possible: selecting from vertical sonorities
    based on register curves. (This is not currently implemented, but maybe
    for Ersilia.)
-   Demonstrate simple PitchHandler examples.
-   Additionally:
    -   SeedSession
    -   Pitch operations
    -   Logical tie expressions
    -   Pitch application rate
    -   Pitch specifier
    -   Grace expressions
\end{markdown}

\subsection{Attachment-handlers}
\label{ssec:attachment-handlers}

Attachment-handlers manage the process of attaching indicators and spanners to
selections of components within a score. They may also evaluate *component
expressions* against selections of components, much like the logical tie
expressions outlined in \autoref{ssec:pitch-handlers}.

Attachment-handlers aggregate *attachment expressions* by associating those
expressions with underscore-delimited string keys. This mechanism, nearly
identical to that employed by music settings, allows attachment expressions --
which may have an arbitrary number of such associations -- to be reconfigured
through templating to add new attachment expressions or overwrite or nullify
specific existing expressions.\footnote{The principle employed by both music
settings and attachment handlers is crucial: named references beat positional
references.}

Attachment expressions pair a *component selector* -- as described in
\autoref{ssec:selectors} -- and an iterable of attachments -- indicators and
spanners -- or component expressions.

Attachment-handlers provide various niceties for instantiation.

\begin{markdown}
-   Attaches things to the score.
-   Aggregates AttachmentExpression instances together.
    -   A bundle of a selector and an iterable of attachments or
        expressions.
    -   Reprise discussion of selectors.
-   Processes the score by voice, then by *phrase*.
    -   Unlike the other handlers, attachment handlers require the entire
        phrase to operate on, and selectors should be designed with that in
        mind.
\end{markdown}

\subsection{Expressive attachments}
\label{ssec:expressive-attachments}

\begin{markdown}
-   Idiomatic indicators
-   DynamicExpression
-   BowContactSpanner
-   StringContactSpanner
-   Indicators attached as annotations
-   Spanners as a kind of clever post-processing
\end{markdown}

\subsection{Post-processing}
\label{ssec:post-processing}

Score configuration.

Adding a time signature context, as described in
\autoref{ssec:score-post-processing}.

Consort also allows for inserting a LilyPond \texttt{\\include} statement at
the top of any LilyPond file constructed through interpretation which points to
a stylesheet located relative to a path defined on the segment-maker.

By subclasses Consort's segment-maker, individual score packages can cause
their own segment-makers to automatically locate the appropriate stylesheet
file relative to the package where that segment-maker subclass was defined.

\begin{markdown}
-   Score configuration
    -   Time signature context
        -   Adding time signatures
        -   Rehearsal marks
        -   Repeat signs
-   LilyPond configuration
    -   Style-sheets
\end{markdown}

\subsection{Voice copying}
\label{ssec:voice-copying}

For reasons related solely to how LilyPond handles various typographic
constructs during typesetting, it may prove necessary to copy certain voices in
the score, maintaining all rhythmic information therein, but changing their
context name and filtering out various spanners and indicators so that only a
specific subset of typographic commands remain.

My score \emph{Invisible Cities (ii): Armilla} employs this voice-copying
technique to create the desired typography.

This is achieved by subclassing Consort's segment-maker.

Voice-copying treats the output of interpretation as \enquote{semantic}, but
not necessarily fully-ready for typesetting.

\section{Persistence \& visualization}

Once interpreted, a segment-maker's illustration may be persisted to disk as
LilyPond syntax for inclusion in other LilyPond files, rendered as a PDF for
viewing, or even serialized for other purposes. Composers study the results of
interpretation, make changes to each segment's specification, and re-interpret
as necessary, a large-scale re-enactment of interactive programming's pervasive
\emph{read-eval-print} loop paradigm.

\section{Examples}

\begin{comment}
<abjad>
music_setting = consort.MusicSetting(
    timespan_identifier=consort.RatioPartsExpression(
        parts=(0, 2),
        ratio=(1, 3, 2),
        ),
    timespan_maker=consort.FloodedTimespanMaker(),
    violin_2='A',
    viola=('B', 'C', 'D'),
    )
</abjad>
\end{comment}

%%% ABJADBOOK START %%%
\begin{singlespacing}
\vspace{-0.5\baselineskip}
\begin{lstlisting}
>>> music_setting = consort.MusicSetting(
...     timespan_identifier=consort.RatioPartsExpression(
...         parts=(0, 2),
...         ratio=(1, 3, 2),
...         ),
...     timespan_maker=consort.FloodedTimespanMaker(),
...     violin_2='A',
...     viola=('B', 'C', 'D'),
...     )
\end{lstlisting}
\end{singlespacing}
%%% ABJADBOOK END %%%

\begin{comment}
D<abjad>
score_template = consort.StringQuartetScoreTemplate()
result = music_setting.resolve_music_specifiers(score_template)
for voice_name, music_specifier_sequence in result.items():
    print('VOICE:', voice_name)
    print(format(music_specifier_sequence))

</abjad>
\end{comment}

%%% ABJADBOOK START %%%
\begin{singlespacing}
\vspace{-0.5\baselineskip}
\begin{lstlisting}
>>> score_template = consort.StringQuartetScoreTemplate()
>>> result = music_setting.resolve_music_specifiers(score_template)
>>> for voice_name, music_specifier_sequence in result.items():
...     print('VOICE:', voice_name)
...     print(format(music_specifier_sequence))
...
('VOICE:', 'Violin 2 Performer Group')
consort.tools.MusicSpecifierSequence(
    music_specifiers=datastructuretools.CyclicTuple(
        ['A']
        ),
    )
('VOICE:', 'Viola Performer Group')
consort.tools.MusicSpecifierSequence(
    music_specifiers=datastructuretools.CyclicTuple(
        ['B', 'C', 'D']
        ),
    )
\end{lstlisting}
\end{singlespacing}
%%% ABJADBOOK END %%%

\begin{comment}
<abjad>
segment_timespan = timespantools.Timespan(0, 8)
show(segment_timespan)
target_timespans = music_setting.resolve_target_timespans(segment_timespan)
show(target_timespans, range_=(0, 8))
</abjad>
\end{comment}

%%% ABJADBOOK START %%%
\begin{singlespacing}
\vspace{-0.5\baselineskip}
\begin{lstlisting}
>>> segment_timespan = timespantools.Timespan(0, 8)
>>> show(segment_timespan)
\end{lstlisting}
\noindent\includegraphics[max width=\textwidth,]{assets/lilypond-a34adb1cfbda637e38739ddd84494442.pdf}
\begin{lstlisting}
>>> target_timespans = music_setting.resolve_target_timespans(segment_timespan)
>>> show(target_timespans, range_=(0, 8))
\end{lstlisting}
\noindent\includegraphics[max width=\textwidth,]{assets/lilypond-102acd696ed0eb0ce3e2668275527bd3.pdf}
\end{singlespacing}
%%% ABJADBOOK END %%%

\begin{comment}
<abjad>
target_timespans = music_setting.resolve_target_timespans(
    segment_timespan,
    timespan_quantization=Duration(1, 16),
    )
show(target_timespans, range_=(0, 8))
</abjad>
\end{comment}

%%% ABJADBOOK START %%%
\begin{singlespacing}
\vspace{-0.5\baselineskip}
\begin{lstlisting}
>>> target_timespans = music_setting.resolve_target_timespans(
...     segment_timespan,
...     timespan_quantization=Duration(1, 16),
...     )
>>> show(target_timespans, range_=(0, 8))
\end{lstlisting}
\noindent\includegraphics[max width=\textwidth,]{assets/lilypond-fdd1e78affa1ee5ba3e3e9b80feee1b2.pdf}
\end{singlespacing}
%%% ABJADBOOK END %%%

\begin{comment}
<abjad>
music_setting = new(
    music_setting,
    timespan_identifier__mask_timespan=timespantools.Timespan(
        start_offset=(1, 2),
        stop_offset=7,
        ),
    )
target_timespans = music_setting.resolve_target_timespans(segment_timespan)
show(target_timespans, range_=(0, 8))
</abjad>
\end{comment}

%%% ABJADBOOK START %%%
\begin{singlespacing}
\vspace{-0.5\baselineskip}
\begin{lstlisting}
>>> music_setting = new(
...     music_setting,
...     timespan_identifier__mask_timespan=timespantools.Timespan(
...         start_offset=(1, 2),
...         stop_offset=7,
...         ),
...     )
>>> target_timespans = music_setting.resolve_target_timespans(segment_timespan)
>>> show(target_timespans, range_=(0, 8))
\end{lstlisting}
\noindent\includegraphics[max width=\textwidth,]{assets/lilypond-435c344c6fe3e22cf86e856a0fe98c16.pdf}
\end{singlespacing}
%%% ABJADBOOK END %%%

\subsection{Segment-maker examples}

\begin{comment}
<abjad>
segment_maker = consort.SegmentMaker(
    desired_duration_in_seconds=9,
    omit_stylesheets=True,
    permitted_time_signatures=[(3, 4)],
    score_template=templatetools.GroupedRhythmicStavesScoreTemplate(
        staff_count=2,
        with_clefs=True,
        ),
    tempo=indicatortools.Tempo((1, 4), 60),
    )
</abjad>
\end{comment}

%%% ABJADBOOK START %%%
\begin{singlespacing}
\vspace{-0.5\baselineskip}
\begin{lstlisting}
>>> segment_maker = consort.SegmentMaker(
...     desired_duration_in_seconds=9,
...     omit_stylesheets=True,
...     permitted_time_signatures=[(3, 4)],
...     score_template=templatetools.GroupedRhythmicStavesScoreTemplate(
...         staff_count=2,
...         with_clefs=True,
...         ),
...     tempo=indicatortools.Tempo((1, 4), 60),
...     )
\end{lstlisting}
\end{singlespacing}
%%% ABJADBOOK END %%%

\begin{comment}
<abjad>[stylesheet=../consort.ily]
show(segment_maker, verbose=False)
</abjad>
\end{comment}

%%% ABJADBOOK START %%%
\begin{singlespacing}
\vspace{-0.5\baselineskip}
\begin{lstlisting}
>>> show(segment_maker, verbose=False)
\end{lstlisting}
\noindent\includegraphics[max width=\textwidth,]{assets/lilypond-5551103a6156a0c950aaf871d1206d96.pdf}
\end{singlespacing}
%%% ABJADBOOK END %%%

\begin{comment}
<abjad>[stylesheet=../consort.ily]
faster_segment_maker = new(
    segment_maker,
    tempo=indicatortools.Tempo((1, 4), 20),
    )
show(faster_segment_maker, verbose=False)
</abjad>
\end{comment}

%%% ABJADBOOK START %%%
\begin{singlespacing}
\vspace{-0.5\baselineskip}
\begin{lstlisting}
>>> faster_segment_maker = new(
...     segment_maker,
...     tempo=indicatortools.Tempo((1, 4), 20),
...     )
>>> show(faster_segment_maker, verbose=False)
\end{lstlisting}
\noindent\includegraphics[max width=\textwidth,]{assets/lilypond-dac8ffa35eb4dae93ba418fbf1eaf390.pdf}
\end{singlespacing}
%%% ABJADBOOK END %%%

\subsection{Score template and abbreviation examples}

\begin{comment}
<abjad>
import armilla
armilla_score_template = armilla.makers.ArmillaScoreTemplate()
armilla_score = armilla_score_template()
print(format(armilla_score))
for item in armilla_score_template.context_name_abbreviations.items():
    abbreviation, context_name = item
    print(abbreviation, context_name)

for item in armilla_score_template.composite_context_pairs.items():
    grouping_abbreviation, grouped_abbreviations = item
    print(grouping_abbreviation, grouped_abbreviations)

</abjad>
\end{comment}

%%% ABJADBOOK START %%%
\begin{singlespacing}
\vspace{-0.5\baselineskip}
\begin{lstlisting}
>>> import armilla
>>> armilla_score_template = armilla.makers.ArmillaScoreTemplate()
>>> armilla_score = armilla_score_template()
>>> print(format(armilla_score))
\context Score = "Armilla Score" <<
    \tag #'time
    \context TimeSignatureContext = "TimeSignatureContext" {
    }
    \tag #'viola-1
    \context StringPerformerGroup = "Viola 1 Performer Group" \with {
        instrumentName = \markup {
            \hcenter-in
                #10
                "Viola 1"
            }
        shortInstrumentName = \markup {
            \hcenter-in
                #10
                "Va. 1"
            }
    } <<
        \context BowingStaff = "Viola 1 Bowing Staff" {
            \clef "percussion"
            \context Voice = "Viola 1 Bowing Voice" {
            }
        }
        \context FingeringStaff = "Viola 1 Fingering Staff" {
            \clef "alto"
            \context Voice = "Viola 1 Fingering Voice" {
            }
        }
    >>
    \tag #'viola-2
    \context StringPerformerGroup = "Viola 2 Performer Group" \with {
        instrumentName = \markup {
            \hcenter-in
                #10
                "Viola 2"
            }
        shortInstrumentName = \markup {
            \hcenter-in
                #10
                "Va. 2"
            }
    } <<
        \context BowingStaff = "Viola 2 Bowing Staff" {
            \clef "percussion"
            \context Voice = "Viola 2 Bowing Voice" {
            }
        }
        \context FingeringStaff = "Viola 2 Fingering Staff" {
            \clef "alto"
            \context Voice = "Viola 2 Fingering Voice" {
            }
        }
    >>
>>
\end{lstlisting}
\begin{lstlisting}
>>> for item in armilla_score_template.context_name_abbreviations.items():
...     abbreviation, context_name = item
...     print(abbreviation, context_name)
...
('viola_1', 'Viola 1 Performer Group')
('viola_1_rh', 'Viola 1 Bowing Voice')
('viola_1_lh', 'Viola 1 Fingering Voice')
('viola_2', 'Viola 2 Performer Group')
('viola_2_rh', 'Viola 2 Bowing Voice')
('viola_2_lh', 'Viola 2 Fingering Voice')
\end{lstlisting}
\begin{lstlisting}
>>> for item in armilla_score_template.composite_context_pairs.items():
...     grouping_abbreviation, grouped_abbreviations = item
...     print(grouping_abbreviation, grouped_abbreviations)
...
('viola_1', ('viola_1_rh', 'viola_1_lh'))
('viola_2', ('viola_2_rh', 'viola_2_lh'))
\end{lstlisting}
\end{singlespacing}
%%% ABJADBOOK END %%%

\begin{comment}
<abjad>
armilla_score['Viola 1 Fingering Voice']
</abjad>
\end{comment}

%%% ABJADBOOK START %%%
\begin{singlespacing}
\vspace{-0.5\baselineskip}
\begin{lstlisting}
>>> armilla_score['Viola 1 Fingering Voice']
Voice()
\end{lstlisting}
\end{singlespacing}
%%% ABJADBOOK END %%%

\subsection{Music specifier label examples}

\begin{comment}
<abjad>
unlabeled_music_specifier = consort.MusicSpecifier()
labeled_music_specifier = consort.MusicSpecifier(labels=['labeled'])
timespan_inventory = timespantools.TimespanInventory([
    consort.PerformedTimespan(
        layer=1,
        start_offset=0,
        stop_offset=4,
        music_specifier=labeled_music_specifier,
        voice_name='Voice 1',
        ),
    consort.PerformedTimespan(
        layer=1,
        start_offset=2,
        stop_offset=7,
        music_specifier=labeled_music_specifier,
        voice_name='Voice 2',
        ),
    consort.PerformedTimespan(
        layer=2,
        start_offset=6,
        stop_offset=8,
        music_specifier=unlabeled_music_specifier,
        voice_name='Voice 1',
        ),
    consort.PerformedTimespan(
        layer=2,
        start_offset=10,
        stop_offset=(25, 2),
        music_specifier=unlabeled_music_specifier,
        voice_name='Voice 2',
        ),
    consort.PerformedTimespan(
        layer=1,
        start_offset=11,
        stop_offset=14,
        music_specifier=labeled_music_specifier,
        voice_name='Voice 1',
        ),
    consort.PerformedTimespan(
        layer=1,
        start_offset=14,
        stop_offset=16,
        music_specifier=labeled_music_specifier,
        voice_name='Voice 1',
        ),
    consort.PerformedTimespan(
        layer=1,
        start_offset=15,
        stop_offset=16,
        music_specifier=labeled_music_specifier,
        voice_name='Voice 2',
        ),
    ])
show(timespan_inventory, key='voice_name')
</abjad>
\end{comment}

%%% ABJADBOOK START %%%
\begin{singlespacing}
\vspace{-0.5\baselineskip}
\begin{lstlisting}
>>> unlabeled_music_specifier = consort.MusicSpecifier()
>>> labeled_music_specifier = consort.MusicSpecifier(labels=['labeled'])
>>> timespan_inventory = timespantools.TimespanInventory([
...     consort.PerformedTimespan(
...         layer=1,
...         start_offset=0,
...         stop_offset=4,
...         music_specifier=labeled_music_specifier,
...         voice_name='Voice 1',
...         ),
...     consort.PerformedTimespan(
...         layer=1,
...         start_offset=2,
...         stop_offset=7,
...         music_specifier=labeled_music_specifier,
...         voice_name='Voice 2',
...         ),
...     consort.PerformedTimespan(
...         layer=2,
...         start_offset=6,
...         stop_offset=8,
...         music_specifier=unlabeled_music_specifier,
...         voice_name='Voice 1',
...         ),
...     consort.PerformedTimespan(
...         layer=2,
...         start_offset=10,
...         stop_offset=(25, 2),
...         music_specifier=unlabeled_music_specifier,
...         voice_name='Voice 2',
...         ),
...     consort.PerformedTimespan(
...         layer=1,
...         start_offset=11,
...         stop_offset=14,
...         music_specifier=labeled_music_specifier,
...         voice_name='Voice 1',
...         ),
...     consort.PerformedTimespan(
...         layer=1,
...         start_offset=14,
...         stop_offset=16,
...         music_specifier=labeled_music_specifier,
...         voice_name='Voice 1',
...         ),
...     consort.PerformedTimespan(
...         layer=1,
...         start_offset=15,
...         stop_offset=16,
...         music_specifier=labeled_music_specifier,
...         voice_name='Voice 2',
...         ),
...     ])
>>> show(timespan_inventory, key='voice_name')
\end{lstlisting}
\noindent\includegraphics[max width=\textwidth,]{assets/lilypond-8ff4b7fe83d5db8fb0d01627be42da4b.pdf}
\end{singlespacing}
%%% ABJADBOOK END %%%

\begin{comment}
<abjad>
dependent_timespan_maker = consort.DependentTimespanMaker(
    include_inner_starts=True,
    voice_names=('Voice 1', 'Voice 2'),
    )
result = dependent_timespan_maker(
    layer=3,
    music_specifiers={'Voice 3': None},
    timespan_inventory=timespan_inventory[:],
    )
show(result, key='voice_name')
</abjad>
\end{comment}

%%% ABJADBOOK START %%%
\begin{singlespacing}
\vspace{-0.5\baselineskip}
\begin{lstlisting}
>>> dependent_timespan_maker = consort.DependentTimespanMaker(
...     include_inner_starts=True,
...     voice_names=('Voice 1', 'Voice 2'),
...     )
>>> result = dependent_timespan_maker(
...     layer=3,
...     music_specifiers={'Voice 3': None},
...     timespan_inventory=timespan_inventory[:],
...     )
>>> show(result, key='voice_name')
\end{lstlisting}
\noindent\includegraphics[max width=\textwidth,]{assets/lilypond-cacf84e69a9aeb754e2908597bc776a2.pdf}
\end{singlespacing}
%%% ABJADBOOK END %%%

\begin{comment}
<abjad>
dependent_timespan_maker = new(
    dependent_timespan_maker,
    labels=['labeled'],
    )
result = dependent_timespan_maker(
    layer=3,
    music_specifiers={'Voice 3': None},
    timespan_inventory=timespan_inventory[:],
    )
show(result, key='voice_name')
</abjad>
\end{comment}

%%% ABJADBOOK START %%%
\begin{singlespacing}
\vspace{-0.5\baselineskip}
\begin{lstlisting}
>>> dependent_timespan_maker = new(
...     dependent_timespan_maker,
...     labels=['labeled'],
...     )
>>> result = dependent_timespan_maker(
...     layer=3,
...     music_specifiers={'Voice 3': None},
...     timespan_inventory=timespan_inventory[:],
...     )
>>> show(result, key='voice_name')
\end{lstlisting}
\noindent\includegraphics[max width=\textwidth,]{assets/lilypond-9382d23b443fa753fb33e78d0e7a805f.pdf}
\end{singlespacing}
%%% ABJADBOOK END %%%

\subsection{Timespan resolution examples}

\begin{comment}
<abjad>
layer_1_timespan_maker = consort.FloodedTimespanMaker()
layer_1_target_timespan = timespantools.Timespan(0, (19, 4))
layer_1_music_specifiers = collections.OrderedDict([
    ('Voice 2', None),
    ('Voice 3', None),
    ])
layer_1 = layer_1_timespan_maker(
    layer=1,
    music_specifiers=layer_1_music_specifiers,
    target_timespan=layer_1_target_timespan,
    )
show(layer_1, key='voice_name', range_=(0, (21, 4)))
</abjad>
\end{comment}

%%% ABJADBOOK START %%%
\begin{singlespacing}
\vspace{-0.5\baselineskip}
\begin{lstlisting}
>>> layer_1_timespan_maker = consort.FloodedTimespanMaker()
>>> layer_1_target_timespan = timespantools.Timespan(0, (19, 4))
>>> layer_1_music_specifiers = collections.OrderedDict([
...     ('Voice 2', None),
...     ('Voice 3', None),
...     ])
>>> layer_1 = layer_1_timespan_maker(
...     layer=1,
...     music_specifiers=layer_1_music_specifiers,
...     target_timespan=layer_1_target_timespan,
...     )
>>> show(layer_1, key='voice_name', range_=(0, (21, 4)))
\end{lstlisting}
\noindent\includegraphics[max width=\textwidth,]{assets/lilypond-f86c3ef83d7c5ffbef9e47999bb478a9.pdf}
\end{singlespacing}
%%% ABJADBOOK END %%%

\begin{comment}
<abjad>
layer_2_timespan_maker = consort.TaleaTimespanMaker(
    initial_silence_talea=rhythmmakertools.Talea(
        counts=(0, 1, 3),
        denominator=8,
        ),
    playing_groupings=(1, 2),
    playing_talea=rhythmmakertools.Talea(
        counts=(1, 2, 3, 4),
        denominator=4,
        ),
    silence_talea=rhythmmakertools.Talea(
        counts=(5, 3, 1),
        denominator=8,
        ),
    )
layer_2_target_timespan = timespantools.Timespan((3, 4), (19, 4))
layer_2_music_specifiers = collections.OrderedDict([
    ('Voice 1', None),
    ('Voice 2', None),
    ('Voice 3', None),
    ('Voice 4', None),
    ])
layer_2 = layer_2_timespan_maker(
    layer=2,
    music_specifiers=layer_2_music_specifiers,
    target_timespan=layer_2_target_timespan,
    )
show(layer_2, key='voice_name', range_=(0, (21, 4)))
</abjad>
\end{comment}

%%% ABJADBOOK START %%%
\begin{singlespacing}
\vspace{-0.5\baselineskip}
\begin{lstlisting}
>>> layer_2_timespan_maker = consort.TaleaTimespanMaker(
...     initial_silence_talea=rhythmmakertools.Talea(
...         counts=(0, 1, 3),
...         denominator=8,
...         ),
...     playing_groupings=(1, 2),
...     playing_talea=rhythmmakertools.Talea(
...         counts=(1, 2, 3, 4),
...         denominator=4,
...         ),
...     silence_talea=rhythmmakertools.Talea(
...         counts=(5, 3, 1),
...         denominator=8,
...         ),
...     )
>>> layer_2_target_timespan = timespantools.Timespan((3, 4), (19, 4))
>>> layer_2_music_specifiers = collections.OrderedDict([
...     ('Voice 1', None),
...     ('Voice 2', None),
...     ('Voice 3', None),
...     ('Voice 4', None),
...     ])
>>> layer_2 = layer_2_timespan_maker(
...     layer=2,
...     music_specifiers=layer_2_music_specifiers,
...     target_timespan=layer_2_target_timespan,
...     )
>>> show(layer_2, key='voice_name', range_=(0, (21, 4)))
\end{lstlisting}
\noindent\includegraphics[max width=\textwidth,]{assets/lilypond-e49b088ae657fd66299d7b78da251b1a.pdf}
\end{singlespacing}
%%% ABJADBOOK END %%%

\begin{comment}
<abjad>
layer_3_timespan_maker = consort.TaleaTimespanMaker(
    initial_silence_talea=rhythmmakertools.Talea(
        counts=(0, 0, 0, 1),
        denominator=8,
        ),
    padding=Duration(1, 4),
    playing_talea=rhythmmakertools.Talea(
        counts=(2, 3, 4),
        denominator=8,
        ),
    silence_talea=rhythmmakertools.Talea(
        counts=(6,),
        denominator=4,
        ),
    synchronize_step=True,
    )
layer_3_target_timespan = timespantools.Timespan((6, 4), (21, 4))
layer_3_music_specifiers = collections.OrderedDict([
    ('Voice 1', None),
    ('Voice 3', None),
    ('Voice 4', None),
    ])
layer_3 = layer_3_timespan_maker(
    layer=3,
    music_specifiers=layer_3_music_specifiers,
    target_timespan=layer_3_target_timespan,
    )
show(layer_3, key='voice_name', range_=(0, (21, 4)))
</abjad>
\end{comment}

%%% ABJADBOOK START %%%
\begin{singlespacing}
\vspace{-0.5\baselineskip}
\begin{lstlisting}
>>> layer_3_timespan_maker = consort.TaleaTimespanMaker(
...     initial_silence_talea=rhythmmakertools.Talea(
...         counts=(0, 0, 0, 1),
...         denominator=8,
...         ),
...     padding=Duration(1, 4),
...     playing_talea=rhythmmakertools.Talea(
...         counts=(2, 3, 4),
...         denominator=8,
...         ),
...     silence_talea=rhythmmakertools.Talea(
...         counts=(6,),
...         denominator=4,
...         ),
...     synchronize_step=True,
...     )
>>> layer_3_target_timespan = timespantools.Timespan((6, 4), (21, 4))
>>> layer_3_music_specifiers = collections.OrderedDict([
...     ('Voice 1', None),
...     ('Voice 3', None),
...     ('Voice 4', None),
...     ])
>>> layer_3 = layer_3_timespan_maker(
...     layer=3,
...     music_specifiers=layer_3_music_specifiers,
...     target_timespan=layer_3_target_timespan,
...     )
>>> show(layer_3, key='voice_name', range_=(0, (21, 4)))
\end{lstlisting}
\noindent\includegraphics[max width=\textwidth,]{assets/lilypond-941b5746ac1f0adcadef1f907d8ffb78.pdf}
\end{singlespacing}
%%% ABJADBOOK END %%%

\begin{comment}
<abjad>
timespan_makers = (
    layer_1_timespan_maker,
    layer_2_timespan_maker,
    layer_3_timespan_maker,
    )
music_specifiers = (
    layer_1_music_specifiers,
    layer_2_music_specifiers,
    layer_3_music_specifiers,
    )
target_timespans = (
    layer_1_target_timespan,
    layer_2_target_timespan,
    layer_3_target_timespan,
    )
triples = zip(timespan_makers, music_specifiers, target_timespans)
timespan_inventory = timespantools.TimespanInventory()
for layer, triple in enumerate(triples, 1):
    timespan_inventory = triple[0](
        layer=layer,
        music_specifiers=triple[1],
        target_timespan=triple[2],
        timespan_inventory=timespan_inventory,
        )

show(timespan_inventory, key='voice_name', range_=(0, (21, 4)))
</abjad>
\end{comment}

%%% ABJADBOOK START %%%
\begin{singlespacing}
\vspace{-0.5\baselineskip}
\begin{lstlisting}
>>> timespan_makers = (
...     layer_1_timespan_maker,
...     layer_2_timespan_maker,
...     layer_3_timespan_maker,
...     )
>>> music_specifiers = (
...     layer_1_music_specifiers,
...     layer_2_music_specifiers,
...     layer_3_music_specifiers,
...     )
>>> target_timespans = (
...     layer_1_target_timespan,
...     layer_2_target_timespan,
...     layer_3_target_timespan,
...     )
>>> triples = zip(timespan_makers, music_specifiers, target_timespans)
>>> timespan_inventory = timespantools.TimespanInventory()
>>> for layer, triple in enumerate(triples, 1):
...     timespan_inventory = triple[0](
...         layer=layer,
...         music_specifiers=triple[1],
...         target_timespan=triple[2],
...         timespan_inventory=timespan_inventory,
...         )
...
>>> show(timespan_inventory, key='voice_name', range_=(0, (21, 4)))
\end{lstlisting}
\noindent\includegraphics[max width=\textwidth,]{assets/lilypond-cd13e1c03522127ffbfba2623f59a7fb.pdf}
\end{singlespacing}
%%% ABJADBOOK END %%%

\begin{comment}
<abjad>
show(timespan_inventory, range_=(0, (21, 4)))
</abjad>
\end{comment}

%%% ABJADBOOK START %%%
\begin{singlespacing}
\vspace{-0.5\baselineskip}
\begin{lstlisting}
>>> show(timespan_inventory, range_=(0, (21, 4)))
\end{lstlisting}
\noindent\includegraphics[max width=\textwidth,]{assets/lilypond-39bc7fc954dbcc692b2517c8195b821e.pdf}
\end{singlespacing}
%%% ABJADBOOK END %%%

\begin{comment}
<abjad>
demultiplexed_timespans = consort.SegmentMaker.demultiplex_timespans(
    timespan_inventory,
    )
show(demultiplexed_timespans, range_=(0, (21, 4)))
</abjad>
\end{comment}

%%% ABJADBOOK START %%%
\begin{singlespacing}
\vspace{-0.5\baselineskip}
\begin{lstlisting}
>>> demultiplexed_timespans = consort.SegmentMaker.demultiplex_timespans(
...     timespan_inventory,
...     )
>>> show(demultiplexed_timespans, range_=(0, (21, 4)))
\end{lstlisting}
\noindent\includegraphics[max width=\textwidth,]{assets/lilypond-8d7921006d6bce021d9a284d12ed2e90.pdf}
\end{singlespacing}
%%% ABJADBOOK END %%%

\subsection{Rest consolidation examples}

\begin{comment}
<abjad>
parseable = r'''
\new Voice {
    {
        {
            \time 4/4
            r4
            c4
        }
        {
            \times 2/3 {
                c4
                r8
            }
            r4
        }
        {
            \time 4/4
            r4
            c4.
            r8
        }
        {
            r4
            \break
        }
        {
            \time 3/4
            r4
        }
        {
            c8
            c4.
        }
        \times 2/3 {
            \time 2/4
            r4
            c4
            c4
        }
        {
            \time 4/4
            c4.
            r8
        }
        {
            r8
            c4
            r8
        }
    }
}
'''
unconsolidated_staff = Staff(parseable, context_name='RhythmicStaff')
consort.annotate(unconsolidated_staff)
show(unconsolidated_staff)
</abjad>
\end{comment}

%%% ABJADBOOK START %%%
\begin{singlespacing}
\vspace{-0.5\baselineskip}
\begin{lstlisting}
>>> parseable = r'''
... \new Voice {
...     {
...         {
...             \time 4/4
...             r4
...             c4
...         }
...         {
...             \times 2/3 {
...                 c4
...                 r8
...             }
...             r4
...         }
...         {
...             \time 4/4
...             r4
...             c4.
...             r8
...         }
...         {
...             r4
...             \break
...         }
...         {
...             \time 3/4
...             r4
...         }
...         {
...             c8
...             c4.
...         }
...         \times 2/3 {
...             \time 2/4
...             r4
...             c4
...             c4
...         }
...         {
...             \time 4/4
...             c4.
...             r8
...         }
...         {
...             r8
...             c4
...             r8
...         }
...     }
... }
... '''
>>> unconsolidated_staff = Staff(parseable, context_name='RhythmicStaff')
>>> consort.annotate(unconsolidated_staff)
>>> show(unconsolidated_staff)
\end{lstlisting}
\noindent\includegraphics[max width=\textwidth,]{assets/lilypond-8a213398dc0a03a0c9fcf4af26637767.pdf}
\end{singlespacing}
%%% ABJADBOOK END %%%

\begin{comment}
<abjad>
consolidated_staff = Staff(parseable, context_name='RhythmicStaff')
for voice in consolidated_staff:
    for phrase in voice:
        phrase = consort.SegmentMaker.consolidate_rests(phrase)

consort.annotate(consolidated_staff)
staff_group = StaffGroup([unconsolidated_staff, consolidated_staff])
show(staff_group)
</abjad>
\end{comment}

%%% ABJADBOOK START %%%
\begin{singlespacing}
\vspace{-0.5\baselineskip}
\begin{lstlisting}
>>> consolidated_staff = Staff(parseable, context_name='RhythmicStaff')
>>> for voice in consolidated_staff:
...     for phrase in voice:
...         phrase = consort.SegmentMaker.consolidate_rests(phrase)
...
>>> consort.annotate(consolidated_staff)
>>> staff_group = StaffGroup([unconsolidated_staff, consolidated_staff])
>>> show(staff_group)
\end{lstlisting}
\noindent\includegraphics[max width=\textwidth,]{assets/lilypond-1ef1a4031465a364425aef4e059efda0.pdf}
\end{singlespacing}
%%% ABJADBOOK END %%%

\subsection{Pitch handler examples}

\begin{comment}
<abjad>[stylesheet=../consort.ily]
segment_maker = consort.SegmentMaker(
    desired_duration_in_seconds=9,
    omit_stylesheets=True,
    permitted_time_signatures=[(3, 4)],
    score_template=templatetools.GroupedStavesScoreTemplate(
        staff_count=2,
        ),
    tempo=indicatortools.Tempo((1, 4), 60),
    )
music_specifier = consort.MusicSpecifier(
    rhythm_maker=rhythmmakertools.TaleaRhythmMaker(
        talea=rhythmmakertools.Talea([1], 16),
        ),
    )
timespan_maker = consort.TaleaTimespanMaker(
    initial_silence_talea=rhythmmakertools.Talea([0, 1], 4),
    playing_talea=rhythmmakertools.Talea([1], 8),
    playing_groupings=[3],
    silence_talea=rhythmmakertools.Talea([1], 8),
    )
segment_maker.add_setting(
    timespan_maker=timespan_maker,
    v1=music_specifier,
    v2=music_specifier,
    )
show(segment_maker, verbose=False)
</abjad>
\end{comment}

%%% ABJADBOOK START %%%
\begin{singlespacing}
\vspace{-0.5\baselineskip}
\begin{lstlisting}
>>> segment_maker = consort.SegmentMaker(
...     desired_duration_in_seconds=9,
...     omit_stylesheets=True,
...     permitted_time_signatures=[(3, 4)],
...     score_template=templatetools.GroupedStavesScoreTemplate(
...         staff_count=2,
...         ),
...     tempo=indicatortools.Tempo((1, 4), 60),
...     )
>>> music_specifier = consort.MusicSpecifier(
...     rhythm_maker=rhythmmakertools.TaleaRhythmMaker(
...         talea=rhythmmakertools.Talea([1], 16),
...         ),
...     )
>>> timespan_maker = consort.TaleaTimespanMaker(
...     initial_silence_talea=rhythmmakertools.Talea([0, 1], 4),
...     playing_talea=rhythmmakertools.Talea([1], 8),
...     playing_groupings=[3],
...     silence_talea=rhythmmakertools.Talea([1], 8),
...     )
>>> segment_maker.add_setting(
...     timespan_maker=timespan_maker,
...     v1=music_specifier,
...     v2=music_specifier,
...     )
>>> show(segment_maker, verbose=False)
\end{lstlisting}
\noindent\includegraphics[max width=\textwidth,]{assets/lilypond-394f358f60132ecf989d89a8a9e62012.pdf}
\end{singlespacing}
%%% ABJADBOOK END %%%

\begin{comment}
<abjad>[stylesheet=../consort.ily]
music_specifier = new(
    music_specifier,
    pitch_handler=consort.AbsolutePitchHandler(
        pitch_specifier="c' d' e' f' g' a' b' c''",
        ),
    )
music_setting = consort.MusicSetting(
    timespan_maker=timespan_maker,
    v1=music_specifier,
    v2=music_specifier,
    )
segment_maker = new(segment_maker, settings=[music_setting])
show(segment_maker, verbose=False)
</abjad>
\end{comment}

%%% ABJADBOOK START %%%
\begin{singlespacing}
\vspace{-0.5\baselineskip}
\begin{lstlisting}
>>> music_specifier = new(
...     music_specifier,
...     pitch_handler=consort.AbsolutePitchHandler(
...         pitch_specifier="c' d' e' f' g' a' b' c''",
...         ),
...     )
>>> music_setting = consort.MusicSetting(
...     timespan_maker=timespan_maker,
...     v1=music_specifier,
...     v2=music_specifier,
...     )
>>> segment_maker = new(segment_maker, settings=[music_setting])
>>> show(segment_maker, verbose=False)
\end{lstlisting}
\noindent\includegraphics[max width=\textwidth,]{assets/lilypond-104b2b0b061ac0a12d87191eadfae379.pdf}
\end{singlespacing}
%%% ABJADBOOK END %%%

\begin{comment}
<abjad>[stylesheet=../consort.ily]
music_specifier = new(
    music_specifier,
    rhythm_maker__talea__counts=[1, 2, 3, 4],
    )
music_setting = consort.MusicSetting(
    timespan_maker=timespan_maker,
    v1=music_specifier,
    v2=music_specifier,
    )
segment_maker = new(segment_maker, settings=[music_setting])
show(segment_maker, verbose=False)
</abjad>
\end{comment}

%%% ABJADBOOK START %%%
\begin{singlespacing}
\vspace{-0.5\baselineskip}
\begin{lstlisting}
>>> music_specifier = new(
...     music_specifier,
...     rhythm_maker__talea__counts=[1, 2, 3, 4],
...     )
>>> music_setting = consort.MusicSetting(
...     timespan_maker=timespan_maker,
...     v1=music_specifier,
...     v2=music_specifier,
...     )
>>> segment_maker = new(segment_maker, settings=[music_setting])
>>> show(segment_maker, verbose=False)
\end{lstlisting}
\noindent\includegraphics[max width=\textwidth,]{assets/lilypond-1548051ace14e831b1685f04ffc9bf04.pdf}
\end{singlespacing}
%%% ABJADBOOK END %%%

\begin{comment}
<abjad>[stylesheet=../consort.ily]
other_music_specifier = consort.MusicSpecifier(
    pitch_handler=consort.AbsolutePitchHandler(pitch_specifier='g fs e f'),
    rhythm_maker=rhythmmakertools.EvenDivisionRhythmMaker(
        denominators=[8],
        extra_counts_per_division=(1,),
        ),
    )
other_music_setting = consort.MusicSetting(
    timespan_maker=consort.TaleaTimespanMaker(
        initial_silence_talea=rhythmmakertools.Talea([1], 2),
        silence_talea=rhythmmakertools.Talea([1], 2),
        ),
    v1=other_music_specifier,
    v2=other_music_specifier,
    )
segment_maker = new(
    segment_maker,
    settings=[music_setting, other_music_setting],
    )
show(segment_maker, verbose=False)
</abjad>
\end{comment}

%%% ABJADBOOK START %%%
\begin{singlespacing}
\vspace{-0.5\baselineskip}
\begin{lstlisting}
>>> other_music_specifier = consort.MusicSpecifier(
...     pitch_handler=consort.AbsolutePitchHandler(pitch_specifier='g fs e f'),
...     rhythm_maker=rhythmmakertools.EvenDivisionRhythmMaker(
...         denominators=[8],
...         extra_counts_per_division=(1,),
...         ),
...     )
>>> other_music_setting = consort.MusicSetting(
...     timespan_maker=consort.TaleaTimespanMaker(
...         initial_silence_talea=rhythmmakertools.Talea([1], 2),
...         silence_talea=rhythmmakertools.Talea([1], 2),
...         ),
...     v1=other_music_specifier,
...     v2=other_music_specifier,
...     )
>>> segment_maker = new(
...     segment_maker,
...     settings=[music_setting, other_music_setting],
...     )
>>> show(segment_maker, verbose=False)
\end{lstlisting}
\noindent\includegraphics[max width=\textwidth,]{assets/lilypond-e6f73fdc68fe0c974a8ca8492d683bdb.pdf}
\end{singlespacing}
%%% ABJADBOOK END %%%

\begin{comment}
<abjad>[stylesheet=../consort.ily]
music_specifier = new(
    music_specifier,
    pitch_handler__pitch_specifier=consort.PitchSpecifier(
        pitch_segments=(
            "c' e' g'",
            "fs' g' a'",
            "b d'",
            ),
        ratio=(1, 2, 3),
        ),
    )
music_setting = consort.MusicSetting(
    timespan_maker=timespan_maker,
    v1=music_specifier,
    v2=music_specifier,
    )
segment_maker = new(segment_maker, settings=[music_setting])
show(segment_maker, verbose=False)
</abjad>
\end{comment}

%%% ABJADBOOK START %%%
\begin{singlespacing}
\vspace{-0.5\baselineskip}
\begin{lstlisting}
>>> music_specifier = new(
...     music_specifier,
...     pitch_handler__pitch_specifier=consort.PitchSpecifier(
...         pitch_segments=(
...             "c' e' g'",
...             "fs' g' a'",
...             "b d'",
...             ),
...         ratio=(1, 2, 3),
...         ),
...     )
>>> music_setting = consort.MusicSetting(
...     timespan_maker=timespan_maker,
...     v1=music_specifier,
...     v2=music_specifier,
...     )
>>> segment_maker = new(segment_maker, settings=[music_setting])
>>> show(segment_maker, verbose=False)
\end{lstlisting}
\noindent\includegraphics[max width=\textwidth,]{assets/lilypond-f863612768a505f3f1a27901d8908c01.pdf}
\end{singlespacing}
%%% ABJADBOOK END %%%

\begin{comment}
<abjad>[stylesheet=../consort.ily]
music_specifier = new(
    music_specifier,
    pitch_handler__pitch_operation_specifier=consort.PitchOperationSpecifier(
        pitch_operations=(
            pitchtools.PitchOperation((
                pitchtools.Inversion(),
                )),
            None,
            pitchtools.PitchOperation((
                pitchtools.Rotation(-1),
                pitchtools.Transposition(-1),
                ))
            ),
        ratio=(1, 2, 1),
        ),
    )
music_setting = consort.MusicSetting(
    timespan_maker=timespan_maker,
    v1=music_specifier,
    v2=music_specifier,
    )
segment_maker = new(segment_maker, settings=[music_setting])
show(segment_maker, verbose=False)
</abjad>
\end{comment}

%%% ABJADBOOK START %%%
\begin{singlespacing}
\vspace{-0.5\baselineskip}
\begin{lstlisting}
>>> music_specifier = new(
...     music_specifier,
...     pitch_handler__pitch_operation_specifier=consort.PitchOperationSpecifier(
...         pitch_operations=(
...             pitchtools.PitchOperation((
...                 pitchtools.Inversion(),
...                 )),
...             None,
...             pitchtools.PitchOperation((
...                 pitchtools.Rotation(-1),
...                 pitchtools.Transposition(-1),
...                 ))
...             ),
...         ratio=(1, 2, 1),
...         ),
...     )
>>> music_setting = consort.MusicSetting(
...     timespan_maker=timespan_maker,
...     v1=music_specifier,
...     v2=music_specifier,
...     )
>>> segment_maker = new(segment_maker, settings=[music_setting])
>>> show(segment_maker, verbose=False)
\end{lstlisting}
\noindent\includegraphics[max width=\textwidth,]{assets/lilypond-8353cb721ae26e66270945a62cbb8a67.pdf}
\end{singlespacing}
%%% ABJADBOOK END %%%

\begin{comment}
<abjad>[stylesheet=../consort.ily]
music_specifier = new(
    music_specifier,
    pitch_handler__forbid_repetitions=True,
    )
music_setting = consort.MusicSetting(
    timespan_maker=timespan_maker,
    v1=music_specifier,
    v2=music_specifier,
    )
segment_maker = new(segment_maker, settings=[music_setting])
show(segment_maker, verbose=False)
</abjad>
\end{comment}

%%% ABJADBOOK START %%%
\begin{singlespacing}
\vspace{-0.5\baselineskip}
\begin{lstlisting}
>>> music_specifier = new(
...     music_specifier,
...     pitch_handler__forbid_repetitions=True,
...     )
>>> music_setting = consort.MusicSetting(
...     timespan_maker=timespan_maker,
...     v1=music_specifier,
...     v2=music_specifier,
...     )
>>> segment_maker = new(segment_maker, settings=[music_setting])
>>> show(segment_maker, verbose=False)
\end{lstlisting}
\noindent\includegraphics[max width=\textwidth,]{assets/lilypond-e8337085639c633444a1e65214aa5493.pdf}
\end{singlespacing}
%%% ABJADBOOK END %%%

\begin{comment}
<abjad>[stylesheet=../consort.ily]
music_specifier = new(
    music_specifier,
    pitch_handler__logical_tie_expressions=(
        consort.ChordExpression(chord_expr=(-2, 0, 2)),
        consort.ChordExpression(chord_expr=(-7, 0, 7)),
        None,
        ),
    )
music_setting = consort.MusicSetting(
    timespan_maker=timespan_maker,
    v1=music_specifier,
    v2=music_specifier,
    )
segment_maker = new(segment_maker, settings=[music_setting])
show(segment_maker, verbose=False)
</abjad>
\end{comment}

%%% ABJADBOOK START %%%
\begin{singlespacing}
\vspace{-0.5\baselineskip}
\begin{lstlisting}
>>> music_specifier = new(
...     music_specifier,
...     pitch_handler__logical_tie_expressions=(
...         consort.ChordExpression(chord_expr=(-2, 0, 2)),
...         consort.ChordExpression(chord_expr=(-7, 0, 7)),
...         None,
...         ),
...     )
>>> music_setting = consort.MusicSetting(
...     timespan_maker=timespan_maker,
...     v1=music_specifier,
...     v2=music_specifier,
...     )
>>> segment_maker = new(segment_maker, settings=[music_setting])
>>> show(segment_maker, verbose=False)
\end{lstlisting}
\noindent\includegraphics[max width=\textwidth,]{assets/lilypond-1faec952a7b45f54cee2ed62c44d50bc.pdf}
\end{singlespacing}
%%% ABJADBOOK END %%%

\begin{comment}
<abjad>[stylesheet=../consort.ily]
segment_maker = new(
    segment_maker,
    settings=[music_setting, other_music_setting],
    )
show(segment_maker, verbose=False)
</abjad>
\end{comment}

%%% ABJADBOOK START %%%
\begin{singlespacing}
\vspace{-0.5\baselineskip}
\begin{lstlisting}
>>> segment_maker = new(
...     segment_maker,
...     settings=[music_setting, other_music_setting],
...     )
>>> show(segment_maker, verbose=False)
\end{lstlisting}
\noindent\includegraphics[max width=\textwidth,]{assets/lilypond-9b48c7c7d8ec2ca4e86b9da611fdef17.pdf}
\end{singlespacing}
%%% ABJADBOOK END %%%

\begin{comment}
<abjad>[stylesheet=../consort.ily]
music_specifier = consort.MusicSpecifier(
    pitch_handler=consort.AbsolutePitchHandler(
        pitch_application_rate='division',
        pitch_specifier="c' d' e' f' g' a' b' c''",
        ),
    rhythm_maker=rhythmmakertools.EvenDivisionRhythmMaker(denominators=[16]),
    )
music_setting = consort.MusicSetting(
    timespan_maker=timespan_maker,
    v1=music_specifier,
    v2=music_specifier,
    )
segment_maker = new(segment_maker, settings=[music_setting])
lilypond_file = segment_maker(verbose=False)
consort.annotate(lilypond_file.score)
show(lilypond_file)
</abjad>
\end{comment}

%%% ABJADBOOK START %%%
\begin{singlespacing}
\vspace{-0.5\baselineskip}
\begin{lstlisting}
>>> music_specifier = consort.MusicSpecifier(
...     pitch_handler=consort.AbsolutePitchHandler(
...         pitch_application_rate='division',
...         pitch_specifier="c' d' e' f' g' a' b' c''",
...         ),
...     rhythm_maker=rhythmmakertools.EvenDivisionRhythmMaker(denominators=[16]),
...     )
>>> music_setting = consort.MusicSetting(
...     timespan_maker=timespan_maker,
...     v1=music_specifier,
...     v2=music_specifier,
...     )
>>> segment_maker = new(segment_maker, settings=[music_setting])
>>> lilypond_file = segment_maker(verbose=False)
>>> consort.annotate(lilypond_file.score)
>>> show(lilypond_file)
\end{lstlisting}
\noindent\includegraphics[max width=\textwidth,]{assets/lilypond-76acdc0bda9feecdd70997204aa7c9c8.pdf}
\end{singlespacing}
%%% ABJADBOOK END %%%

\begin{comment}
<abjad>[stylesheet=../consort.ily]
music_specifier = new(
    music_specifier,
    pitch_handler__pitch_application_rate='phrase',
    )
music_setting = consort.MusicSetting(
    timespan_maker=timespan_maker,
    v1=music_specifier,
    v2=music_specifier,
    )
segment_maker = new(segment_maker, settings=[music_setting])
lilypond_file = segment_maker(verbose=False)
consort.annotate(lilypond_file.score)
show(lilypond_file)
</abjad>
\end{comment}

%%% ABJADBOOK START %%%
\begin{singlespacing}
\vspace{-0.5\baselineskip}
\begin{lstlisting}
>>> music_specifier = new(
...     music_specifier,
...     pitch_handler__pitch_application_rate='phrase',
...     )
>>> music_setting = consort.MusicSetting(
...     timespan_maker=timespan_maker,
...     v1=music_specifier,
...     v2=music_specifier,
...     )
>>> segment_maker = new(segment_maker, settings=[music_setting])
>>> lilypond_file = segment_maker(verbose=False)
>>> consort.annotate(lilypond_file.score)
>>> show(lilypond_file)
\end{lstlisting}
\noindent\includegraphics[max width=\textwidth,]{assets/lilypond-89244abdb768aa23fa5a7425fab9e539.pdf}
\end{singlespacing}
%%% ABJADBOOK END %%%

\begin{comment}
<abjad>[stylesheet=../consort.ily]
music_specifier = new(
    music_specifier,
    pitch_handler__deviations=(0, 0, '-m2', '+m2'),
    )
music_setting = consort.MusicSetting(
    timespan_maker=timespan_maker,
    v1=music_specifier,
    v2=music_specifier,
    )
segment_maker = new(segment_maker, settings=[music_setting])
lilypond_file = segment_maker(verbose=False)
consort.annotate(lilypond_file.score)
show(lilypond_file)
</abjad>
\end{comment}

%%% ABJADBOOK START %%%
\begin{singlespacing}
\vspace{-0.5\baselineskip}
\begin{lstlisting}
>>> music_specifier = new(
...     music_specifier,
...     pitch_handler__deviations=(0, 0, '-m2', '+m2'),
...     )
>>> music_setting = consort.MusicSetting(
...     timespan_maker=timespan_maker,
...     v1=music_specifier,
...     v2=music_specifier,
...     )
>>> segment_maker = new(segment_maker, settings=[music_setting])
>>> lilypond_file = segment_maker(verbose=False)
>>> consort.annotate(lilypond_file.score)
>>> show(lilypond_file)
\end{lstlisting}
\noindent\includegraphics[max width=\textwidth,]{assets/lilypond-ff0b1c46ddbd29c5a690fe7c182da0aa.pdf}
\end{singlespacing}
%%% ABJADBOOK END %%%

\subsection{Attachment handler examples}

\begin{comment}
<abjad>[stylesheet=../consort.ily]
music_specifier = consort.MusicSpecifier(
    attachment_handler=consort.AttachmentHandler(),
    rhythm_maker=rhythmmakertools.TaleaRhythmMaker(
        extra_counts_per_division=(0, 1),
        talea=rhythmmakertools.Talea([1, 2, 3, 1, 4], 16),
        ),
    )
timespan_maker = consort.TaleaTimespanMaker(
    initial_silence_talea=rhythmmakertools.Talea([0, 1], 4),
    playing_groupings=(1, 2, 2),
    playing_talea=rhythmmakertools.Talea([2, 3], 8),
    silence_talea=rhythmmakertools.Talea([1, 2, 3, 4], 8),
    )
music_setting = consort.MusicSetting(
    timespan_maker=timespan_maker,
    v1=music_specifier,
    v2=music_specifier,
    )
segment_maker = consort.SegmentMaker(
    desired_duration_in_seconds=8,
    discard_final_silence=True,
    omit_stylesheets=True,
    permitted_time_signatures=[(2, 4), (5, 16), (3, 4)],
    score_template=templatetools.GroupedRhythmicStavesScoreTemplate(
        staff_count=2,
        with_clefs=True,
        ),
    settings=[music_setting],
    tempo=indicatortools.Tempo((1, 4), 72),
    )
show(segment_maker, verbose=False)
</abjad>
\end{comment}

%%% ABJADBOOK START %%%
\begin{singlespacing}
\vspace{-0.5\baselineskip}
\begin{lstlisting}
>>> music_specifier = consort.MusicSpecifier(
...     attachment_handler=consort.AttachmentHandler(),
...     rhythm_maker=rhythmmakertools.TaleaRhythmMaker(
...         extra_counts_per_division=(0, 1),
...         talea=rhythmmakertools.Talea([1, 2, 3, 1, 4], 16),
...         ),
...     )
>>> timespan_maker = consort.TaleaTimespanMaker(
...     initial_silence_talea=rhythmmakertools.Talea([0, 1], 4),
...     playing_groupings=(1, 2, 2),
...     playing_talea=rhythmmakertools.Talea([2, 3], 8),
...     silence_talea=rhythmmakertools.Talea([1, 2, 3, 4], 8),
...     )
>>> music_setting = consort.MusicSetting(
...     timespan_maker=timespan_maker,
...     v1=music_specifier,
...     v2=music_specifier,
...     )
>>> segment_maker = consort.SegmentMaker(
...     desired_duration_in_seconds=8,
...     discard_final_silence=True,
...     omit_stylesheets=True,
...     permitted_time_signatures=[(2, 4), (5, 16), (3, 4)],
...     score_template=templatetools.GroupedRhythmicStavesScoreTemplate(
...         staff_count=2,
...         with_clefs=True,
...         ),
...     settings=[music_setting],
...     tempo=indicatortools.Tempo((1, 4), 72),
...     )
>>> show(segment_maker, verbose=False)
\end{lstlisting}
\noindent\includegraphics[max width=\textwidth,]{assets/lilypond-31ad7eaab600ca94fc940e6c050a8651.pdf}
\end{singlespacing}
%%% ABJADBOOK END %%%

\begin{comment}
<abjad>[stylesheet=../consort.ily]
music_specifier = new(
    music_specifier,
    attachment_handler__accents=consort.AttachmentExpression(
        attachments=Articulation('accent'),
        selector=selectortools.Selector().by_leaves()[0],
        ),
    )
music_setting = new(
    music_setting,
    v1=music_specifier,
    v2=music_specifier,
    )
segment_maker = new(segment_maker, settings=[music_setting])
show(segment_maker,verbose=False)
</abjad>
\end{comment}

%%% ABJADBOOK START %%%
\begin{singlespacing}
\vspace{-0.5\baselineskip}
\begin{lstlisting}
>>> music_specifier = new(
...     music_specifier,
...     attachment_handler__accents=consort.AttachmentExpression(
...         attachments=Articulation('accent'),
...         selector=selectortools.Selector().by_leaves()[0],
...         ),
...     )
>>> music_setting = new(
...     music_setting,
...     v1=music_specifier,
...     v2=music_specifier,
...     )
>>> segment_maker = new(segment_maker, settings=[music_setting])
>>> show(segment_maker,verbose=False)
\end{lstlisting}
\noindent\includegraphics[max width=\textwidth,]{assets/lilypond-5845a137b0839d77edd44e425c040cdb.pdf}
\end{singlespacing}
%%% ABJADBOOK END %%%

\begin{comment}
<abjad>[stylesheet=../consort.ily]
music_specifier = new(
    music_specifier,
    attachment_handler__tenuti=consort.AttachmentExpression(
        attachments=Articulation('tenuto'),
        selector=selectortools.Selector()
            .by_leaves()[1:]
            .by_logical_tie(pitched=True)[0],
        ),
    )
music_setting = new(
    music_setting,
    v1=music_specifier,
    v2=music_specifier,
    )
segment_maker = new(segment_maker, settings=[music_setting])
show(segment_maker, verbose=False)
</abjad>
\end{comment}

%%% ABJADBOOK START %%%
\begin{singlespacing}
\vspace{-0.5\baselineskip}
\begin{lstlisting}
>>> music_specifier = new(
...     music_specifier,
...     attachment_handler__tenuti=consort.AttachmentExpression(
...         attachments=Articulation('tenuto'),
...         selector=selectortools.Selector()
...             .by_leaves()[1:]
...             .by_logical_tie(pitched=True)[0],
...         ),
...     )
>>> music_setting = new(
...     music_setting,
...     v1=music_specifier,
...     v2=music_specifier,
...     )
>>> segment_maker = new(segment_maker, settings=[music_setting])
>>> show(segment_maker, verbose=False)
\end{lstlisting}
\noindent\includegraphics[max width=\textwidth,]{assets/lilypond-254b71b1dd161525523b2dfc96ee5b18.pdf}
\end{singlespacing}
%%% ABJADBOOK END %%%

\begin{comment}
<abjad>[stylesheet=../consort.ily]
music_specifier = new(
    music_specifier,
    attachment_handler__slurs=Slur()
    )
music_setting = new(
    music_setting,
    v1=music_specifier,
    v2=music_specifier,
    )
segment_maker = new(segment_maker, settings=[music_setting])
show(segment_maker, verbose=False)
</abjad>
\end{comment}

%%% ABJADBOOK START %%%
\begin{singlespacing}
\vspace{-0.5\baselineskip}
\begin{lstlisting}
>>> music_specifier = new(
...     music_specifier,
...     attachment_handler__slurs=Slur()
...     )
>>> music_setting = new(
...     music_setting,
...     v1=music_specifier,
...     v2=music_specifier,
...     )
>>> segment_maker = new(segment_maker, settings=[music_setting])
>>> show(segment_maker, verbose=False)
\end{lstlisting}
\noindent\includegraphics[max width=\textwidth,]{assets/lilypond-f0e62c688147028c121f9b53bb698a65.pdf}
\end{singlespacing}
%%% ABJADBOOK END %%%

\begin{comment}
<abjad>[stylesheet=../consort.ily]
music_specifier = new(
    music_specifier,
    attachment_handler__dynamics=consort.DynamicExpression(['f', 'p'])
    )
music_setting = new(
    music_setting,
    v1=music_specifier,
    v2=music_specifier,
    )
segment_maker = new(segment_maker, settings=[music_setting])
show(segment_maker, verbose=False)
</abjad>
\end{comment}

%%% ABJADBOOK START %%%
\begin{singlespacing}
\vspace{-0.5\baselineskip}
\begin{lstlisting}
>>> music_specifier = new(
...     music_specifier,
...     attachment_handler__dynamics=consort.DynamicExpression(['f', 'p'])
...     )
>>> music_setting = new(
...     music_setting,
...     v1=music_specifier,
...     v2=music_specifier,
...     )
>>> segment_maker = new(segment_maker, settings=[music_setting])
>>> show(segment_maker, verbose=False)
\end{lstlisting}
\noindent\includegraphics[max width=\textwidth,]{assets/lilypond-5134d656fed6cee151678103491f4f07.pdf}
\end{singlespacing}
%%% ABJADBOOK END %%%

\begin{comment}
<abjad>[stylesheet=../consort.ily]
lilypond_file = segment_maker(verbose=False)
consort.annotate(lilypond_file.score)
show(lilypond_file)
</abjad>
\end{comment}

%%% ABJADBOOK START %%%
\begin{singlespacing}
\vspace{-0.5\baselineskip}
\begin{lstlisting}
>>> lilypond_file = segment_maker(verbose=False)
>>> consort.annotate(lilypond_file.score)
>>> show(lilypond_file)
\end{lstlisting}
\noindent\includegraphics[max width=\textwidth,]{assets/lilypond-6e9d587e5ee37ad6583f5197bed09814.pdf}
\end{singlespacing}
%%% ABJADBOOK END %%%