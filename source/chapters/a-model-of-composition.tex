%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
\chapter{\emph{Consort}: a model of composition}
\label{chap:a-model-of-composition}
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%

\begin{comment}
<abjad>[hide=true]
import collections
import consort
</abjad>
\end{comment}

\begin{markdown}
#   Specification & Interpretation
-   Materials
-   Configuration
-   Templating
-   Layers
-   Coarse to fine
-   Rhythm first
-   What is specification? What is a specifier? What is configuration and
    aggregation?
-   What should happen musically, where should it happen?
-   What is material?
-   What is music?
-   Rhythm is interpreted first, as all other parameters depend on it.
-   Rhythm is interpreted from "coarse" to "fine": from the level of phrase
    boundaries to the level of individual notes, rests, tuplets and ties.
-   This discussion only focuses on notation, nothing related to aesthetic
    experience, physical modeling or anything else. This is a tool for a
    specific composer to create scores, not a discussion explicitly of why they
    would work this way (although that should be discussed in the conclusion).
-   Specification and interpretation conceive of the score as a single, hugely
    complex expression.
-   Templating as variation.
-   Define what composition means here: laying out symbols on the page.
-   This way of thinking and working does not attempt to define or even model
    concepts like "melody" or even "phrase". They're too vague. If we use that
    terminology at all, it is only in the most incredibly constrained way.
\end{markdown}

\begin{markdown}
#   Analysis Overview
-   Specification
    -   Materials
        -   Defining timespan makers
        -   Defining target timespans
        -   Defining music specifiers
    -   Segment specification
    -   Making music settings
-   Interpretation
    - Rhythmic interpretation
        -   Populating independent timespans
            -   Iterating music settings
            -   Resolving music specifiers
            -   Resolving timespans
            -   Finding meters
            -   Consolidating timespans
            -   Inscribing timespans
        -   Populating dependent timespans
            -   Recapitulate the above
        -   Populating silent timespans
        -   Validating timespans
        -   Rewriting meter
        -   Populating the score
        -   Collecting attack points
    - Non-rhythmic interpretation
        -   Grace handling
        -   Pitch handling
        -   Attachment handling
        -   Post-processing
-   Persistence
\end{markdown}

\begin{markdown}

Working with Consort falls into two distinct phases: *specification* and
*interpretation*.

Specification involves the process of specifying the structure and contents of
a *segment* of score by creating and progressively configuring an instance of a
*segment-maker*. Such configuration parameters include score template,
tempo, permitted meters, and desired duration. Most importantly, segment-makers
may be configured with any number of *music settings*, which aggregate a
timespan-maker, a target timespan and any number of music specifiers. Music
settings object-model both *when* and in *which* voices musical materials
should be deployed. The order in which composers configure segment-makers with
music settings defines each music setting's *layer*, determining how
overlapping events mask one another. Score *materials*, including music
settings, music specifiers, timespan-makers and any other class pertinent to
score creation, may be defined from scratch in the same code module as the
segment-maker, templated from another material, or simply imported into the
segment definition's namespace.

At any point during specification, a segment-maker may be interpreted to
produce an illustration. Score interpretation proceeds conceptually much like
compilation in classical computing, where a compiler parses an instruction set
written in some source language into an intermediate representation and then
transforms that same intermediate representation into instructions executable
on a target platform. In score interpretation, the compiler is the
segment-maker itself, and the source instruction set its configuration -- its
tempo, permitted meters, music settings and so forth. Timespan inventories
populated with annotated timespans perform the role of intermediate
representation. The target of score interpretation is, unsurprisingly, a
fully-fledge score aggregated from Abjad score components.

Interpretation takes place in two broad stages -- rhythmic interpretation,
followed by non-rhythmic interpretation -- with the first stage producing a
score populated solely with rhythmic information, and the second stage applying
grace notes, pitches, indicators, spanners and various typographic overrides to
the previously-constructed rhythmic skeleton.

During rhythmic interpretation, 

During non-rhythmic interpretation,

Once interpreted, a segment-maker's illustration may be persisted to disk as
LilyPond syntax for inclusion in other LilyPond files, rendered as a PDF for
viewing, or even serialized for other purposes. Composers study the results of
interpretation, make changes to each segment's specification, and re-interpret
as necessary, a large-scale re-enactment of interactive programming's pervasive
*read-eval-print* loop paradigm.

\end{markdown}

\begin{markdown}
#   Segment-makers
-   Permitted time signatures
-   Tempo
-   Desired duration
-   Score template
    -   LilyPond will automatically concatenate scores with identical
        context hierarchies. All contexts need to be present in every
        concatenated segment, otherwise LilyPond will concatenate
        incorrectly. However, we can use various typographic overrides to
        make it appear that a context has disappeared.
    -   Consort's ScoreTemplateManager helps create regularized score
        templates.
-   Music settings
\end{markdown}

\subsection{Segment-maker examples}

\begin{comment}
<abjad>
segment_maker = consort.SegmentMaker(
    desired_duration_in_seconds=9,
    omit_stylesheets=True,
    permitted_time_signatures=[(3, 4)],
    score_template=templatetools.GroupedRhythmicStavesScoreTemplate(
        staff_count=2,
        with_clefs=True,
        ),
    tempo=indicatortools.Tempo((1, 4), 60),
    )
</abjad>
\end{comment}

%%% ABJADBOOK START %%%
\begin{singlespacing}
\vspace{-0.5\baselineskip}
\begin{lstlisting}
>>> segment_maker = consort.SegmentMaker(
...     desired_duration_in_seconds=9,
...     omit_stylesheets=True,
...     permitted_time_signatures=[(3, 4)],
...     score_template=templatetools.GroupedRhythmicStavesScoreTemplate(
...         staff_count=2,
...         with_clefs=True,
...         ),
...     tempo=indicatortools.Tempo((1, 4), 60),
...     )
\end{lstlisting}
\end{singlespacing}
%%% ABJADBOOK END %%%

\begin{comment}
<abjad>[stylesheet=../consort.ily]
show(segment_maker, verbose=False)
</abjad>
\end{comment}

%%% ABJADBOOK START %%%
\begin{singlespacing}
\vspace{-0.5\baselineskip}
\begin{lstlisting}
>>> show(segment_maker, verbose=False)
\end{lstlisting}
\noindent\includegraphics[max width=\textwidth,]{assets/lilypond-5551103a6156a0c950aaf871d1206d96.pdf}
\end{singlespacing}
%%% ABJADBOOK END %%%

\begin{comment}
<abjad>[stylesheet=../consort.ily]
faster_segment_maker = new(
    segment_maker,
    tempo=indicatortools.Tempo((1, 4), 120),
    )
show(faster_segment_maker, verbose=False)
</abjad>
\end{comment}

%%% ABJADBOOK START %%%
\begin{singlespacing}
\vspace{-0.5\baselineskip}
\begin{lstlisting}
>>> faster_segment_maker = new(
...     segment_maker,
...     tempo=indicatortools.Tempo((1, 4), 120),
...     )
>>> show(faster_segment_maker, verbose=False)
\end{lstlisting}
\noindent\includegraphics[max width=\textwidth,]{assets/lilypond-88bcdb27b1ad17661a645e4df9a41e96.pdf}
\end{singlespacing}
%%% ABJADBOOK END %%%

\begin{markdown}
#   Music settings
-   What kind of music, laid out in what pattern, in which general
    time frame, for which voices, in what layer?
-   A timespan-maker
-   A target timespan
    -   A timespan.
    -   A timespan inventory.
    -   A ratio/parts expression.
        -   Demonstrate. Check.
-   Voice abbreviation / music specifier pairs
    -   Why abbreviate? It's because of Python's key=value syntax for
        keyword arguments.
    -   How do we convert abbreviation to an actual context name?
        -   Score templates need to define a mapping.
        -   Demonstrate. Check.
    -   What is the context name for?
        -   Name-wise indexing in an actual score.
        -   Demonstrate. Check.
    -   Also, composite music specifiers: when two contexts need to be
        discussed as a single unit.
        -   Composite music specifiers need to convert one abbreviation into
            two more abbreviations, each mapped to an actual context name.
        -   Consort's ScoreTemplateManager takes care of calculating and
            caching the appropriate names and abbreviations.
-   Layer is implicit, derived from the order of setting definitions.
    -   Recall the discussion of timespan layer from earlier chapters.
\end{markdown}

\subsection{Ratio-parts expression examples}

\begin{comment}
<abjad>
timespan = timespantools.Timespan(0, 8)
show(timespan)
ratio_parts_expression = consort.RatioPartsExpression(
    ratio=[1, 2, 1],
    parts=[0, 2],
    )
result = ratio_parts_expression(timespan)
show(result)
</abjad>
\end{comment}

%%% ABJADBOOK START %%%
\begin{singlespacing}
\vspace{-0.5\baselineskip}
\begin{lstlisting}
>>> timespan = timespantools.Timespan(0, 8)
>>> show(timespan)
\end{lstlisting}
\noindent\includegraphics[max width=\textwidth,]{assets/lilypond-a34adb1cfbda637e38739ddd84494442.pdf}
\begin{lstlisting}
>>> ratio_parts_expression = consort.RatioPartsExpression(
...     ratio=[1, 2, 1],
...     parts=[0, 2],
...     )
>>> result = ratio_parts_expression(timespan)
>>> show(result)
\end{lstlisting}
\noindent\includegraphics[max width=\textwidth,]{assets/lilypond-53d850fdf03d8308e4c1a9b0c39b239a.pdf}
\end{singlespacing}
%%% ABJADBOOK END %%%

\begin{comment}
<abjad>
ratio_parts_expression = new(
    ratio_parts_expression,
    timespan=timespantools.Timespan(
        start_offset=Offset(1, 4),
        ),
    )
result = ratio_parts_expression(timespan)
show(result, range_=(0, 8))
</abjad>
\end{comment}

%%% ABJADBOOK START %%%
\begin{singlespacing}
\vspace{-0.5\baselineskip}
\begin{lstlisting}
>>> ratio_parts_expression = new(
...     ratio_parts_expression,
...     timespan=timespantools.Timespan(
...         start_offset=Offset(1, 4),
...         ),
...     )
>>> result = ratio_parts_expression(timespan)
>>> show(result, range_=(0, 8))
\end{lstlisting}
\noindent\includegraphics[max width=\textwidth,]{assets/lilypond-79f16a4a8418396c8645b819bd11c617.pdf}
\end{singlespacing}
%%% ABJADBOOK END %%%

\subsection{Score template and abbreviation examples}

\begin{comment}
<abjad>
import armilla
armilla_score_template = armilla.makers.ArmillaScoreTemplate()
armilla_score = armilla_score_template()
print(format(armilla_score))
for item in armilla_score_template.context_name_abbreviations.items():
    abbreviation, context_name = item
    print(abbreviation, context_name)

for item in armilla_score_template.composite_context_pairs.items():
    grouping_abbreviation, grouped_abbreviations = item
    print(grouping_abbreviation, grouped_abbreviations)

</abjad>
\end{comment}

%%% ABJADBOOK START %%%
\begin{singlespacing}
\vspace{-0.5\baselineskip}
\begin{lstlisting}
>>> import armilla
>>> armilla_score_template = armilla.makers.ArmillaScoreTemplate()
>>> armilla_score = armilla_score_template()
>>> print(format(armilla_score))
\context Score = "Armilla Score" <<
    \tag #'time
    \context TimeSignatureContext = "TimeSignatureContext" {
    }
    \tag #'viola-1
    \context StringPerformerGroup = "Viola 1 Performer Group" \with {
        instrumentName = \markup {
            \hcenter-in
                #10
                "Viola 1"
            }
        shortInstrumentName = \markup {
            \hcenter-in
                #10
                "Va. 1"
            }
    } <<
        \context BowingStaff = "Viola 1 Bowing Staff" {
            \clef "percussion"
            \context Voice = "Viola 1 Bowing Voice" {
            }
        }
        \context FingeringStaff = "Viola 1 Fingering Staff" {
            \clef "alto"
            \context Voice = "Viola 1 Fingering Voice" {
            }
        }
    >>
    \tag #'viola-2
    \context StringPerformerGroup = "Viola 2 Performer Group" \with {
        instrumentName = \markup {
            \hcenter-in
                #10
                "Viola 2"
            }
        shortInstrumentName = \markup {
            \hcenter-in
                #10
                "Va. 2"
            }
    } <<
        \context BowingStaff = "Viola 2 Bowing Staff" {
            \clef "percussion"
            \context Voice = "Viola 2 Bowing Voice" {
            }
        }
        \context FingeringStaff = "Viola 2 Fingering Staff" {
            \clef "alto"
            \context Voice = "Viola 2 Fingering Voice" {
            }
        }
    >>
>>
\end{lstlisting}
\begin{lstlisting}
>>> for item in armilla_score_template.context_name_abbreviations.items():
...     abbreviation, context_name = item
...     print(abbreviation, context_name)
...
('viola_1', 'Viola 1 Performer Group')
('viola_1_rh', 'Viola 1 Bowing Voice')
('viola_1_lh', 'Viola 1 Fingering Voice')
('viola_2', 'Viola 2 Performer Group')
('viola_2_rh', 'Viola 2 Bowing Voice')
('viola_2_lh', 'Viola 2 Fingering Voice')
\end{lstlisting}
\begin{lstlisting}
>>> for item in armilla_score_template.composite_context_pairs.items():
...     grouping_abbreviation, grouped_abbreviations = item
...     print(grouping_abbreviation, grouped_abbreviations)
...
('viola_1', ('viola_1_rh', 'viola_1_lh'))
('viola_2', ('viola_2_rh', 'viola_2_lh'))
\end{lstlisting}
\end{singlespacing}
%%% ABJADBOOK END %%%

\begin{comment}
<abjad>
armilla_score['Viola 1 Fingering Voice']
</abjad>
\end{comment}

%%% ABJADBOOK START %%%
\begin{singlespacing}
\vspace{-0.5\baselineskip}
\begin{lstlisting}
>>> armilla_score['Viola 1 Fingering Voice']
Voice()
\end{lstlisting}
\end{singlespacing}
%%% ABJADBOOK END %%%

\begin{markdown}
# Music specifiers
-   A bundle of descriptors for what kind of music should fill a series of
    1 or more timespans.
-   All of the descriptors are optional.
-   Rhythm-makers:
    -   Creates rhythms in the divisions defined by a series of contiguous
        timespans.
-   Grace-handlers:
    -   Adds grace notes to the start of logical ties in a patterned way.
    -   Processes the score time-wise by logical tie.
-   Pitch-handlers:
    -   Applies pitches to logical ties in a patterned way.
    -   Applies pitches to grace notes associated with a logical tie.
    -   Applies logical-tie-expressions which can convert logical ties from
        notes into chords, key-clusters or harmonics.
    -   Processes the score time-wise by logical tie.
        -   The goal is to limit pitch class repetition both vertically and
            horizontally, but *only* with regard to phrases in the score scoped
            by each music specifier. Other phrases are not considered.
    -   Application rate: by logical tie, division, phrase
        -   This requires the SeedSession class for keeping track of many
            seeds, each advancing at a potentially different rate.
        -   This also requires the AttackPointSignature class, which caches
            information about each logical tie's position in its parent
            division, phrase and overall segment.
    -   MusicSpecifier: pitches are non-semantic (is this even used?)
    -   Maps different patterns of pitches and different patterns of operations
        across the timeline.
        -   PitchHandler: `get_pitch_choice_timespans()`
        -   Demonstrate.
    -   Can act on absolute pitches, or registered pitch classes.
    -   Other formulations are possible: selecting from vertical sonorities
        based on register curves. (This is not currently implemented, but maybe
        for Ersilia.)
    -   Demonstrate simple PitchHandler examples.
\end{markdown}

\subsection{Music specifier label examples}

\begin{comment}
<abjad>
unlabeled_music_specifier = consort.MusicSpecifier()
labeled_music_specifier = consort.MusicSpecifier(labels=['labeled'])
timespan_inventory = timespantools.TimespanInventory([
    consort.PerformedTimespan(
        layer=1,
        start_offset=0,
        stop_offset=4,
        music_specifier=labeled_music_specifier,
        voice_name='Voice 1',
        ),
    consort.PerformedTimespan(
        layer=1,
        start_offset=2,
        stop_offset=7,
        music_specifier=labeled_music_specifier,
        voice_name='Voice 2',
        ),
    consort.PerformedTimespan(
        layer=2,
        start_offset=6,
        stop_offset=8,
        music_specifier=unlabeled_music_specifier,
        voice_name='Voice 1',
        ),
    consort.PerformedTimespan(
        layer=2,
        start_offset=10,
        stop_offset=(25, 2),
        music_specifier=unlabeled_music_specifier,
        voice_name='Voice 2',
        ),
    consort.PerformedTimespan(
        layer=1,
        start_offset=11,
        stop_offset=14,
        music_specifier=labeled_music_specifier,
        voice_name='Voice 1',
        ),
    consort.PerformedTimespan(
        layer=1,
        start_offset=14,
        stop_offset=16,
        music_specifier=labeled_music_specifier,
        voice_name='Voice 1',
        ),
    consort.PerformedTimespan(
        layer=1,
        start_offset=15,
        stop_offset=16,
        music_specifier=labeled_music_specifier,
        voice_name='Voice 2',
        ),
    ])
show(timespan_inventory, key='voice_name')
</abjad>
\end{comment}

%%% ABJADBOOK START %%%
\begin{singlespacing}
\vspace{-0.5\baselineskip}
\begin{lstlisting}
>>> unlabeled_music_specifier = consort.MusicSpecifier()
>>> labeled_music_specifier = consort.MusicSpecifier(labels=['labeled'])
>>> timespan_inventory = timespantools.TimespanInventory([
...     consort.PerformedTimespan(
...         layer=1,
...         start_offset=0,
...         stop_offset=4,
...         music_specifier=labeled_music_specifier,
...         voice_name='Voice 1',
...         ),
...     consort.PerformedTimespan(
...         layer=1,
...         start_offset=2,
...         stop_offset=7,
...         music_specifier=labeled_music_specifier,
...         voice_name='Voice 2',
...         ),
...     consort.PerformedTimespan(
...         layer=2,
...         start_offset=6,
...         stop_offset=8,
...         music_specifier=unlabeled_music_specifier,
...         voice_name='Voice 1',
...         ),
...     consort.PerformedTimespan(
...         layer=2,
...         start_offset=10,
...         stop_offset=(25, 2),
...         music_specifier=unlabeled_music_specifier,
...         voice_name='Voice 2',
...         ),
...     consort.PerformedTimespan(
...         layer=1,
...         start_offset=11,
...         stop_offset=14,
...         music_specifier=labeled_music_specifier,
...         voice_name='Voice 1',
...         ),
...     consort.PerformedTimespan(
...         layer=1,
...         start_offset=14,
...         stop_offset=16,
...         music_specifier=labeled_music_specifier,
...         voice_name='Voice 1',
...         ),
...     consort.PerformedTimespan(
...         layer=1,
...         start_offset=15,
...         stop_offset=16,
...         music_specifier=labeled_music_specifier,
...         voice_name='Voice 2',
...         ),
...     ])
>>> show(timespan_inventory, key='voice_name')
\end{lstlisting}
\noindent\includegraphics[max width=\textwidth,]{assets/lilypond-8ff4b7fe83d5db8fb0d01627be42da4b.pdf}
\end{singlespacing}
%%% ABJADBOOK END %%%

\begin{comment}
<abjad>
dependent_timespan_maker = consort.DependentTimespanMaker(
    include_inner_starts=True,
    voice_names=('Voice 1', 'Voice 2'),
    )
result = dependent_timespan_maker(
    layer=3,
    music_specifiers={'Voice 3': None},
    timespan_inventory=timespan_inventory[:],
    )
show(result, key='voice_name')
</abjad>
\end{comment}

%%% ABJADBOOK START %%%
\begin{singlespacing}
\vspace{-0.5\baselineskip}
\begin{lstlisting}
>>> dependent_timespan_maker = consort.DependentTimespanMaker(
...     include_inner_starts=True,
...     voice_names=('Voice 1', 'Voice 2'),
...     )
>>> result = dependent_timespan_maker(
...     layer=3,
...     music_specifiers={'Voice 3': None},
...     timespan_inventory=timespan_inventory[:],
...     )
>>> show(result, key='voice_name')
\end{lstlisting}
\noindent\includegraphics[max width=\textwidth,]{assets/lilypond-cacf84e69a9aeb754e2908597bc776a2.pdf}
\end{singlespacing}
%%% ABJADBOOK END %%%

\begin{comment}
<abjad>
dependent_timespan_maker = new(
    dependent_timespan_maker,
    labels=['labeled'],
    )
result = dependent_timespan_maker(
    layer=3,
    music_specifiers={'Voice 3': None},
    timespan_inventory=timespan_inventory[:],
    )
show(result, key='voice_name')
</abjad>
\end{comment}

%%% ABJADBOOK START %%%
\begin{singlespacing}
\vspace{-0.5\baselineskip}
\begin{lstlisting}
>>> dependent_timespan_maker = new(
...     dependent_timespan_maker,
...     labels=['labeled'],
...     )
>>> result = dependent_timespan_maker(
...     layer=3,
...     music_specifiers={'Voice 3': None},
...     timespan_inventory=timespan_inventory[:],
...     )
>>> show(result, key='voice_name')
\end{lstlisting}
\noindent\includegraphics[max width=\textwidth,]{assets/lilypond-9382d23b443fa753fb33e78d0e7a805f.pdf}
\end{singlespacing}
%%% ABJADBOOK END %%%


\begin{markdown}
-   Attachment-handlers:
    -   Attaches things to the score.
    -   Aggregates AttachmentExpression instances together.
        -   A bundle of a selector and an iterable of attachments or
            expressions.
        -   Reprise discussion of selectors.
        -   Discuss expressions: DynamicExpression, etc.
    -   Processes the score by voice, then by *phrase*.
        -   Unlike the other handlers, attachment handlers require the entire
            phrase to operate on, and selectors should be designed with that in
            mind.
    -   Demonstrate a gallery of selectors.
        -   by duration
        -   by leaves
        -   by length
        -   by logical tie
        -   by counts (with negative counts too)
    -   Expressive attachments
        -   Idiomatic indicators
        -   DynamicExpression
        -   BowContactSpanner
        -   StringContactSpanner
-   Other music specifier properties of note?
    -   *labels*
        -   This works in tandem with DependentTimespanMaker.
        -   Example? Piano music with two hands and pedaling. The
            hand-performed music might involve key presses, or it might involve
            percussive techniques. All of the techniques that require pedaling
            should be labeled 'pedaled'. A DependentTimespanMaker for the pedal
            context can then be configured to look at timespans for both the LH
            and RH of the piano, but only those timespans configured with a
            music specifier labeled 'pedaled'.
        -   Demonstrate.
    -   *minimum phrase duration*
        -   (should this be hoisted into PerformedTimespan?
    -   *seed*
    -   *is_sentinel* (maybe remove from consort altogether)
\end{markdown}

\begin{markdown}
# Composite music specifiers
\end{markdown}

\begin{markdown}
# Timespan population
-   Multiplexing & demultiplexing
-   Resolving cascading overlap
\end{markdown}

\subsection{Timespan resolution examples}

\begin{comment}
<abjad>
layer_1_timespan_maker = consort.FloodedTimespanMaker()
layer_1_target_timespan = timespantools.Timespan(0, (19, 4))
layer_1_music_specifiers = collections.OrderedDict([
    ('Voice 2', None),
    ('Voice 3', None),
    ])
layer_1 = layer_1_timespan_maker(
    layer=1,
    music_specifiers=layer_1_music_specifiers,
    target_timespan=layer_1_target_timespan,
    )
show(layer_1, key='voice_name', range_=(0, (21, 4)))
</abjad>
\end{comment}

%%% ABJADBOOK START %%%
\begin{singlespacing}
\vspace{-0.5\baselineskip}
\begin{lstlisting}
>>> layer_1_timespan_maker = consort.FloodedTimespanMaker()
>>> layer_1_target_timespan = timespantools.Timespan(0, (19, 4))
>>> layer_1_music_specifiers = collections.OrderedDict([
...     ('Voice 2', None),
...     ('Voice 3', None),
...     ])
>>> layer_1 = layer_1_timespan_maker(
...     layer=1,
...     music_specifiers=layer_1_music_specifiers,
...     target_timespan=layer_1_target_timespan,
...     )
>>> show(layer_1, key='voice_name', range_=(0, (21, 4)))
\end{lstlisting}
\noindent\includegraphics[max width=\textwidth,]{assets/lilypond-f86c3ef83d7c5ffbef9e47999bb478a9.pdf}
\end{singlespacing}
%%% ABJADBOOK END %%%

\begin{comment}
<abjad>
layer_2_timespan_maker = consort.TaleaTimespanMaker(
    initial_silence_talea=rhythmmakertools.Talea(
        counts=(0, 1, 3),
        denominator=8,
        ),
    playing_groupings=(1, 2),
    playing_talea=rhythmmakertools.Talea(
        counts=(1, 2, 3, 4),
        denominator=4,
        ),
    silence_talea=rhythmmakertools.Talea(
        counts=(5, 3, 1),
        denominator=8,
        ),
    )
layer_2_target_timespan = timespantools.Timespan((3, 4), (19, 4))
layer_2_music_specifiers = collections.OrderedDict([
    ('Voice 1', None),
    ('Voice 2', None),
    ('Voice 3', None),
    ('Voice 4', None),
    ])
layer_2 = layer_2_timespan_maker(
    layer=2,
    music_specifiers=layer_2_music_specifiers,
    target_timespan=layer_2_target_timespan,
    )
show(layer_2, key='voice_name', range_=(0, (21, 4)))
</abjad>
\end{comment}

%%% ABJADBOOK START %%%
\begin{singlespacing}
\vspace{-0.5\baselineskip}
\begin{lstlisting}
>>> layer_2_timespan_maker = consort.TaleaTimespanMaker(
...     initial_silence_talea=rhythmmakertools.Talea(
...         counts=(0, 1, 3),
...         denominator=8,
...         ),
...     playing_groupings=(1, 2),
...     playing_talea=rhythmmakertools.Talea(
...         counts=(1, 2, 3, 4),
...         denominator=4,
...         ),
...     silence_talea=rhythmmakertools.Talea(
...         counts=(5, 3, 1),
...         denominator=8,
...         ),
...     )
>>> layer_2_target_timespan = timespantools.Timespan((3, 4), (19, 4))
>>> layer_2_music_specifiers = collections.OrderedDict([
...     ('Voice 1', None),
...     ('Voice 2', None),
...     ('Voice 3', None),
...     ('Voice 4', None),
...     ])
>>> layer_2 = layer_2_timespan_maker(
...     layer=2,
...     music_specifiers=layer_2_music_specifiers,
...     target_timespan=layer_2_target_timespan,
...     )
>>> show(layer_2, key='voice_name', range_=(0, (21, 4)))
\end{lstlisting}
\noindent\includegraphics[max width=\textwidth,]{assets/lilypond-e49b088ae657fd66299d7b78da251b1a.pdf}
\end{singlespacing}
%%% ABJADBOOK END %%%

\begin{comment}
<abjad>
layer_3_timespan_maker = consort.TaleaTimespanMaker(
    initial_silence_talea=rhythmmakertools.Talea(
        counts=(0, 0, 0, 1),
        denominator=8,
        ),
    padding=Duration(1, 4),
    playing_talea=rhythmmakertools.Talea(
        counts=(2, 3, 4),
        denominator=8,
        ),
    silence_talea=rhythmmakertools.Talea(
        counts=(6,),
        denominator=4,
        ),
    synchronize_step=True,
    )
layer_3_target_timespan = timespantools.Timespan((6, 4), (21, 4))
layer_3_music_specifiers = collections.OrderedDict([
    ('Voice 1', None),
    ('Voice 3', None),
    ('Voice 4', None),
    ])
layer_3 = layer_3_timespan_maker(
    layer=3,
    music_specifiers=layer_3_music_specifiers,
    target_timespan=layer_3_target_timespan,
    )
show(layer_3, key='voice_name', range_=(0, (21, 4)))
</abjad>
\end{comment}

%%% ABJADBOOK START %%%
\begin{singlespacing}
\vspace{-0.5\baselineskip}
\begin{lstlisting}
>>> layer_3_timespan_maker = consort.TaleaTimespanMaker(
...     initial_silence_talea=rhythmmakertools.Talea(
...         counts=(0, 0, 0, 1),
...         denominator=8,
...         ),
...     padding=Duration(1, 4),
...     playing_talea=rhythmmakertools.Talea(
...         counts=(2, 3, 4),
...         denominator=8,
...         ),
...     silence_talea=rhythmmakertools.Talea(
...         counts=(6,),
...         denominator=4,
...         ),
...     synchronize_step=True,
...     )
>>> layer_3_target_timespan = timespantools.Timespan((6, 4), (21, 4))
>>> layer_3_music_specifiers = collections.OrderedDict([
...     ('Voice 1', None),
...     ('Voice 3', None),
...     ('Voice 4', None),
...     ])
>>> layer_3 = layer_3_timespan_maker(
...     layer=3,
...     music_specifiers=layer_3_music_specifiers,
...     target_timespan=layer_3_target_timespan,
...     )
>>> show(layer_3, key='voice_name', range_=(0, (21, 4)))
\end{lstlisting}
\noindent\includegraphics[max width=\textwidth,]{assets/lilypond-941b5746ac1f0adcadef1f907d8ffb78.pdf}
\end{singlespacing}
%%% ABJADBOOK END %%%

\begin{comment}
<abjad>
timespan_makers = (
    layer_1_timespan_maker,
    layer_2_timespan_maker,
    layer_3_timespan_maker,
    )
music_specifiers = (
    layer_1_music_specifiers,
    layer_2_music_specifiers,
    layer_3_music_specifiers,
    )
target_timespans = (
    layer_1_target_timespan,
    layer_2_target_timespan,
    layer_3_target_timespan,
    )
triples = zip(timespan_makers, music_specifiers, target_timespans)
timespan_inventory = timespantools.TimespanInventory()
for layer, triple in enumerate(triples, 1):
    timespan_inventory = triple[0](
        layer=layer,
        music_specifiers=triple[1],
        target_timespan=triple[2],
        timespan_inventory=timespan_inventory,
        )

show(timespan_inventory, key='voice_name', range_=(0, (21, 4)))
</abjad>
\end{comment}

%%% ABJADBOOK START %%%
\begin{singlespacing}
\vspace{-0.5\baselineskip}
\begin{lstlisting}
>>> timespan_makers = (
...     layer_1_timespan_maker,
...     layer_2_timespan_maker,
...     layer_3_timespan_maker,
...     )
>>> music_specifiers = (
...     layer_1_music_specifiers,
...     layer_2_music_specifiers,
...     layer_3_music_specifiers,
...     )
>>> target_timespans = (
...     layer_1_target_timespan,
...     layer_2_target_timespan,
...     layer_3_target_timespan,
...     )
>>> triples = zip(timespan_makers, music_specifiers, target_timespans)
>>> timespan_inventory = timespantools.TimespanInventory()
>>> for layer, triple in enumerate(triples, 1):
...     timespan_inventory = triple[0](
...         layer=layer,
...         music_specifiers=triple[1],
...         target_timespan=triple[2],
...         timespan_inventory=timespan_inventory,
...         )
...
>>> show(timespan_inventory, key='voice_name', range_=(0, (21, 4)))
\end{lstlisting}
\noindent\includegraphics[max width=\textwidth,]{assets/lilypond-cd13e1c03522127ffbfba2623f59a7fb.pdf}
\end{singlespacing}
%%% ABJADBOOK END %%%

\begin{comment}
<abjad>
show(timespan_inventory, range_=(0, (21, 4)))
</abjad>
\end{comment}

%%% ABJADBOOK START %%%
\begin{singlespacing}
\vspace{-0.5\baselineskip}
\begin{lstlisting}
>>> show(timespan_inventory, range_=(0, (21, 4)))
\end{lstlisting}
\noindent\includegraphics[max width=\textwidth,]{assets/lilypond-39bc7fc954dbcc692b2517c8195b821e.pdf}
\end{singlespacing}
%%% ABJADBOOK END %%%

\begin{comment}
<abjad>
demultiplexed_timespans = consort.TimeManager.demultiplex_timespans(
    timespan_inventory,
    )
show(demultiplexed_timespans, range_=(0, (21, 4)))
</abjad>
\end{comment}

%%% ABJADBOOK START %%%
\begin{singlespacing}
\vspace{-0.5\baselineskip}
\begin{lstlisting}
>>> demultiplexed_timespans = consort.TimeManager.demultiplex_timespans(
...     timespan_inventory,
...     )
>>> show(demultiplexed_timespans, range_=(0, (21, 4)))
\end{lstlisting}
\noindent\includegraphics[max width=\textwidth,]{assets/lilypond-8d7921006d6bce021d9a284d12ed2e90.pdf}
\end{singlespacing}
%%% ABJADBOOK END %%%


\begin{markdown}
# Timespan inscription
-   Divisions
-   Rhythm creation
-   Rest consolidation
-   Rhythmic post-processing
    -   attaching a GeneralizedBeam
    -   attaching the scoped music specifier
-   Meter rewriting
    Cleaning up logical ties
-   Attack-point collection
\end{markdown}

\subsection{Rest consolidation examples}

\begin{comment}
<abjad>
parseable = r'''
\new Voice {
    {
        {
            \time 4/4
            r4
            c4
        }
        {
            \times 2/3 {
                c4
                r8
            }
            r4
        }
        {
            \time 4/4
            r4
            c4.
            r8
        }
        {
            r4
            \break
        }
        {
            \time 3/4
            r4
        }
        {
            c8
            c4.
        }
        \times 2/3 {
            \time 2/4
            r4
            c4
            c4
        }
        {
            \time 4/4
            c4.
            r8
        }
        {
            r8
            c4
            r8
        }
    }
}
'''
unconsolidated_staff = Staff(parseable, context_name='RhythmicStaff')
consort.annotate(unconsolidated_staff)
show(unconsolidated_staff)
</abjad>
\end{comment}

%%% ABJADBOOK START %%%
\begin{singlespacing}
\vspace{-0.5\baselineskip}
\begin{lstlisting}
>>> parseable = r'''
... \new Voice {
...     {
...         {
...             \time 4/4
...             r4
...             c4
...         }
...         {
...             \times 2/3 {
...                 c4
...                 r8
...             }
...             r4
...         }
...         {
...             \time 4/4
...             r4
...             c4.
...             r8
...         }
...         {
...             r4
...             \break
...         }
...         {
...             \time 3/4
...             r4
...         }
...         {
...             c8
...             c4.
...         }
...         \times 2/3 {
...             \time 2/4
...             r4
...             c4
...             c4
...         }
...         {
...             \time 4/4
...             c4.
...             r8
...         }
...         {
...             r8
...             c4
...             r8
...         }
...     }
... }
... '''
>>> unconsolidated_staff = Staff(parseable, context_name='RhythmicStaff')
>>> consort.annotate(unconsolidated_staff)
>>> show(unconsolidated_staff)
\end{lstlisting}
\noindent\includegraphics[max width=\textwidth,]{assets/lilypond-8a213398dc0a03a0c9fcf4af26637767.pdf}
\end{singlespacing}
%%% ABJADBOOK END %%%

\begin{comment}
<abjad>
consolidated_staff = Staff(parseable, context_name='RhythmicStaff')
for voice in consolidated_staff:
    for phrase in voice:
        phrase = consort.TimeManager.consolidate_rests(phrase)

consort.annotate(consolidated_staff)
staff_group = StaffGroup([unconsolidated_staff, consolidated_staff])
show(staff_group)
</abjad>
\end{comment}

%%% ABJADBOOK START %%%
\begin{singlespacing}
\vspace{-0.5\baselineskip}
\begin{lstlisting}
>>> consolidated_staff = Staff(parseable, context_name='RhythmicStaff')
>>> for voice in consolidated_staff:
...     for phrase in voice:
...         phrase = consort.TimeManager.consolidate_rests(phrase)
...
>>> consort.annotate(consolidated_staff)
>>> staff_group = StaffGroup([unconsolidated_staff, consolidated_staff])
>>> show(staff_group)
\end{lstlisting}
\noindent\includegraphics[max width=\textwidth,]{assets/lilypond-1ef1a4031465a364425aef4e059efda0.pdf}
\end{singlespacing}
%%% ABJADBOOK END %%%


\begin{markdown}
# Post-rhythm-creation processing
-   Score traversal revisited
-   Grace handling
-   Pitch handling
    -   SeedSession
    -   Pitch operations
    -   Logical tie expressions
    -   Pitch application rate
    -   Pitch specifier
    -   Grace expressions
-   Attachment handling
\end{markdown}

\subsection{Pitch handler examples}

\begin{comment}
<abjad>[stylesheet=../consort.ily]
segment_maker = consort.SegmentMaker(
    desired_duration_in_seconds=9,
    omit_stylesheets=True,
    permitted_time_signatures=[(3, 4)],
    score_template=templatetools.GroupedStavesScoreTemplate(
        staff_count=2,
        ),
    tempo=indicatortools.Tempo((1, 4), 60),
    )
music_specifier = consort.MusicSpecifier(
    rhythm_maker=rhythmmakertools.TaleaRhythmMaker(
        talea=rhythmmakertools.Talea([1], 16),
        ),
    )
timespan_maker = consort.TaleaTimespanMaker(
    initial_silence_talea=rhythmmakertools.Talea([0, 1], 4),
    playing_talea=rhythmmakertools.Talea([1], 8),
    playing_groupings=[3],
    silence_talea=rhythmmakertools.Talea([1], 8),
    )
segment_maker.add_setting(
    timespan_maker=timespan_maker,
    v1=music_specifier,
    v2=music_specifier,
    )
show(segment_maker, verbose=False)
</abjad>
\end{comment}

%%% ABJADBOOK START %%%
\begin{singlespacing}
\vspace{-0.5\baselineskip}
\begin{lstlisting}
>>> segment_maker = consort.SegmentMaker(
...     desired_duration_in_seconds=9,
...     omit_stylesheets=True,
...     permitted_time_signatures=[(3, 4)],
...     score_template=templatetools.GroupedStavesScoreTemplate(
...         staff_count=2,
...         ),
...     tempo=indicatortools.Tempo((1, 4), 60),
...     )
>>> music_specifier = consort.MusicSpecifier(
...     rhythm_maker=rhythmmakertools.TaleaRhythmMaker(
...         talea=rhythmmakertools.Talea([1], 16),
...         ),
...     )
>>> timespan_maker = consort.TaleaTimespanMaker(
...     initial_silence_talea=rhythmmakertools.Talea([0, 1], 4),
...     playing_talea=rhythmmakertools.Talea([1], 8),
...     playing_groupings=[3],
...     silence_talea=rhythmmakertools.Talea([1], 8),
...     )
>>> segment_maker.add_setting(
...     timespan_maker=timespan_maker,
...     v1=music_specifier,
...     v2=music_specifier,
...     )
>>> show(segment_maker, verbose=False)
\end{lstlisting}
\noindent\includegraphics[max width=\textwidth,]{assets/lilypond-394f358f60132ecf989d89a8a9e62012.pdf}
\end{singlespacing}
%%% ABJADBOOK END %%%

\begin{comment}
<abjad>[stylesheet=../consort.ily]
music_specifier = new(
    music_specifier,
    pitch_handler=consort.AbsolutePitchHandler(
        pitch_specifier="c' d' e' f' g' a' b' c''",
        ),
    )
music_setting = consort.MusicSetting(
    timespan_maker=timespan_maker,
    v1=music_specifier,
    v2=music_specifier,
    )
segment_maker = new(segment_maker, settings=[music_setting])
show(segment_maker, verbose=False)
</abjad>
\end{comment}

%%% ABJADBOOK START %%%
\begin{singlespacing}
\vspace{-0.5\baselineskip}
\begin{lstlisting}
>>> music_specifier = new(
...     music_specifier,
...     pitch_handler=consort.AbsolutePitchHandler(
...         pitch_specifier="c' d' e' f' g' a' b' c''",
...         ),
...     )
>>> music_setting = consort.MusicSetting(
...     timespan_maker=timespan_maker,
...     v1=music_specifier,
...     v2=music_specifier,
...     )
>>> segment_maker = new(segment_maker, settings=[music_setting])
>>> show(segment_maker, verbose=False)
\end{lstlisting}
\noindent\includegraphics[max width=\textwidth,]{assets/lilypond-104b2b0b061ac0a12d87191eadfae379.pdf}
\end{singlespacing}
%%% ABJADBOOK END %%%

\begin{comment}
<abjad>[stylesheet=../consort.ily]
music_specifier = new(
    music_specifier,
    rhythm_maker__talea__counts=[1, 2, 3, 4],
    )
music_setting = consort.MusicSetting(
    timespan_maker=timespan_maker,
    v1=music_specifier,
    v2=music_specifier,
    )
segment_maker = new(segment_maker, settings=[music_setting])
show(segment_maker, verbose=False)
</abjad>
\end{comment}

%%% ABJADBOOK START %%%
\begin{singlespacing}
\vspace{-0.5\baselineskip}
\begin{lstlisting}
>>> music_specifier = new(
...     music_specifier,
...     rhythm_maker__talea__counts=[1, 2, 3, 4],
...     )
>>> music_setting = consort.MusicSetting(
...     timespan_maker=timespan_maker,
...     v1=music_specifier,
...     v2=music_specifier,
...     )
>>> segment_maker = new(segment_maker, settings=[music_setting])
>>> show(segment_maker, verbose=False)
\end{lstlisting}
\noindent\includegraphics[max width=\textwidth,]{assets/lilypond-1548051ace14e831b1685f04ffc9bf04.pdf}
\end{singlespacing}
%%% ABJADBOOK END %%%

\begin{comment}
<abjad>[stylesheet=../consort.ily]
other_music_specifier = consort.MusicSpecifier(
    pitch_handler=consort.AbsolutePitchHandler(pitch_specifier='g fs e f'),
    rhythm_maker=rhythmmakertools.EvenDivisionRhythmMaker(
        denominators=[8],
        extra_counts_per_division=(1,),
        ),
    )
other_music_setting = consort.MusicSetting(
    timespan_maker=consort.TaleaTimespanMaker(
        initial_silence_talea=rhythmmakertools.Talea([1], 2),
        silence_talea=rhythmmakertools.Talea([1], 2),
        ),
    v1=other_music_specifier,
    v2=other_music_specifier,
    )
segment_maker = new(
    segment_maker,
    settings=[music_setting, other_music_setting],
    )
show(segment_maker, verbose=False)
</abjad>
\end{comment}

%%% ABJADBOOK START %%%
\begin{singlespacing}
\vspace{-0.5\baselineskip}
\begin{lstlisting}
>>> other_music_specifier = consort.MusicSpecifier(
...     pitch_handler=consort.AbsolutePitchHandler(pitch_specifier='g fs e f'),
...     rhythm_maker=rhythmmakertools.EvenDivisionRhythmMaker(
...         denominators=[8],
...         extra_counts_per_division=(1,),
...         ),
...     )
>>> other_music_setting = consort.MusicSetting(
...     timespan_maker=consort.TaleaTimespanMaker(
...         initial_silence_talea=rhythmmakertools.Talea([1], 2),
...         silence_talea=rhythmmakertools.Talea([1], 2),
...         ),
...     v1=other_music_specifier,
...     v2=other_music_specifier,
...     )
>>> segment_maker = new(
...     segment_maker,
...     settings=[music_setting, other_music_setting],
...     )
>>> show(segment_maker, verbose=False)
\end{lstlisting}
\noindent\includegraphics[max width=\textwidth,]{assets/lilypond-e6f73fdc68fe0c974a8ca8492d683bdb.pdf}
\end{singlespacing}
%%% ABJADBOOK END %%%

\begin{comment}
<abjad>[stylesheet=../consort.ily]
music_specifier = new(
    music_specifier,
    pitch_handler__pitch_specifier=consort.PitchSpecifier(
        pitch_segments=(
            "c' e' g'",
            "fs' g' a'",
            "b d'",
            ),
        ratio=(1, 2, 3),
        ),
    )
music_setting = consort.MusicSetting(
    timespan_maker=timespan_maker,
    v1=music_specifier,
    v2=music_specifier,
    )
segment_maker = new(segment_maker, settings=[music_setting])
show(segment_maker, verbose=False)
</abjad>
\end{comment}

%%% ABJADBOOK START %%%
\begin{singlespacing}
\vspace{-0.5\baselineskip}
\begin{lstlisting}
>>> music_specifier = new(
...     music_specifier,
...     pitch_handler__pitch_specifier=consort.PitchSpecifier(
...         pitch_segments=(
...             "c' e' g'",
...             "fs' g' a'",
...             "b d'",
...             ),
...         ratio=(1, 2, 3),
...         ),
...     )
>>> music_setting = consort.MusicSetting(
...     timespan_maker=timespan_maker,
...     v1=music_specifier,
...     v2=music_specifier,
...     )
>>> segment_maker = new(segment_maker, settings=[music_setting])
>>> show(segment_maker, verbose=False)
\end{lstlisting}
\noindent\includegraphics[max width=\textwidth,]{assets/lilypond-f863612768a505f3f1a27901d8908c01.pdf}
\end{singlespacing}
%%% ABJADBOOK END %%%

\begin{comment}
<abjad>[stylesheet=../consort.ily]
music_specifier = new(
    music_specifier,
    pitch_handler__pitch_operation_specifier=consort.PitchOperationSpecifier(
        pitch_operations=(
            pitchtools.PitchOperation((
                pitchtools.Inversion(),
                )),
            None,
            pitchtools.PitchOperation((
                pitchtools.Rotation(-1),
                pitchtools.Transposition(-1),
                ))
            ),
        ratio=(1, 2, 1),
        ),
    )
music_setting = consort.MusicSetting(
    timespan_maker=timespan_maker,
    v1=music_specifier,
    v2=music_specifier,
    )
segment_maker = new(segment_maker, settings=[music_setting])
show(segment_maker, verbose=False)
</abjad>
\end{comment}

%%% ABJADBOOK START %%%
\begin{singlespacing}
\vspace{-0.5\baselineskip}
\begin{lstlisting}
>>> music_specifier = new(
...     music_specifier,
...     pitch_handler__pitch_operation_specifier=consort.PitchOperationSpecifier(
...         pitch_operations=(
...             pitchtools.PitchOperation((
...                 pitchtools.Inversion(),
...                 )),
...             None,
...             pitchtools.PitchOperation((
...                 pitchtools.Rotation(-1),
...                 pitchtools.Transposition(-1),
...                 ))
...             ),
...         ratio=(1, 2, 1),
...         ),
...     )
>>> music_setting = consort.MusicSetting(
...     timespan_maker=timespan_maker,
...     v1=music_specifier,
...     v2=music_specifier,
...     )
>>> segment_maker = new(segment_maker, settings=[music_setting])
>>> show(segment_maker, verbose=False)
\end{lstlisting}
\noindent\includegraphics[max width=\textwidth,]{assets/lilypond-8353cb721ae26e66270945a62cbb8a67.pdf}
\end{singlespacing}
%%% ABJADBOOK END %%%

\begin{comment}
<abjad>[stylesheet=../consort.ily]
music_specifier = new(
    music_specifier,
    pitch_handler__forbid_repetitions=True,
    )
music_setting = consort.MusicSetting(
    timespan_maker=timespan_maker,
    v1=music_specifier,
    v2=music_specifier,
    )
segment_maker = new(segment_maker, settings=[music_setting])
show(segment_maker, verbose=False)
</abjad>
\end{comment}

%%% ABJADBOOK START %%%
\begin{singlespacing}
\vspace{-0.5\baselineskip}
\begin{lstlisting}
>>> music_specifier = new(
...     music_specifier,
...     pitch_handler__forbid_repetitions=True,
...     )
>>> music_setting = consort.MusicSetting(
...     timespan_maker=timespan_maker,
...     v1=music_specifier,
...     v2=music_specifier,
...     )
>>> segment_maker = new(segment_maker, settings=[music_setting])
>>> show(segment_maker, verbose=False)
\end{lstlisting}
\noindent\includegraphics[max width=\textwidth,]{assets/lilypond-e8337085639c633444a1e65214aa5493.pdf}
\end{singlespacing}
%%% ABJADBOOK END %%%

\begin{comment}
<abjad>[stylesheet=../consort.ily]
music_specifier = new(
    music_specifier,
    pitch_handler__logical_tie_expressions=(
        consort.ChordExpression(chord_expr=(-2, 0, 2)),
        consort.ChordExpression(chord_expr=(-7, 0, 7)),
        None,
        ),
    )
music_setting = consort.MusicSetting(
    timespan_maker=timespan_maker,
    v1=music_specifier,
    v2=music_specifier,
    )
segment_maker = new(segment_maker, settings=[music_setting])
show(segment_maker, verbose=False)
</abjad>
\end{comment}

%%% ABJADBOOK START %%%
\begin{singlespacing}
\vspace{-0.5\baselineskip}
\begin{lstlisting}
>>> music_specifier = new(
...     music_specifier,
...     pitch_handler__logical_tie_expressions=(
...         consort.ChordExpression(chord_expr=(-2, 0, 2)),
...         consort.ChordExpression(chord_expr=(-7, 0, 7)),
...         None,
...         ),
...     )
>>> music_setting = consort.MusicSetting(
...     timespan_maker=timespan_maker,
...     v1=music_specifier,
...     v2=music_specifier,
...     )
>>> segment_maker = new(segment_maker, settings=[music_setting])
>>> show(segment_maker, verbose=False)
\end{lstlisting}
\noindent\includegraphics[max width=\textwidth,]{assets/lilypond-1faec952a7b45f54cee2ed62c44d50bc.pdf}
\end{singlespacing}
%%% ABJADBOOK END %%%

\begin{comment}
<abjad>[stylesheet=../consort.ily]
segment_maker = new(
    segment_maker,
    settings=[music_setting, other_music_setting],
    )
show(segment_maker, verbose=False)
</abjad>
\end{comment}

%%% ABJADBOOK START %%%
\begin{singlespacing}
\vspace{-0.5\baselineskip}
\begin{lstlisting}
>>> segment_maker = new(
...     segment_maker,
...     settings=[music_setting, other_music_setting],
...     )
>>> show(segment_maker, verbose=False)
\end{lstlisting}
\noindent\includegraphics[max width=\textwidth,]{assets/lilypond-9b48c7c7d8ec2ca4e86b9da611fdef17.pdf}
\end{singlespacing}
%%% ABJADBOOK END %%%

\begin{comment}
<abjad>[stylesheet=../consort.ily]
music_specifier = consort.MusicSpecifier(
    pitch_handler=consort.AbsolutePitchHandler(
        pitch_application_rate='division',
        pitch_specifier="c' d' e' f' g' a' b' c''",
        ),
    rhythm_maker=rhythmmakertools.EvenDivisionRhythmMaker(denominators=[16]),
    )
music_setting = consort.MusicSetting(
    timespan_maker=timespan_maker,
    v1=music_specifier,
    v2=music_specifier,
    )
segment_maker = new(segment_maker, settings=[music_setting])
lilypond_file = segment_maker(verbose=False)
consort.annotate(lilypond_file.score)
show(lilypond_file)
</abjad>
\end{comment}

%%% ABJADBOOK START %%%
\begin{singlespacing}
\vspace{-0.5\baselineskip}
\begin{lstlisting}
>>> music_specifier = consort.MusicSpecifier(
...     pitch_handler=consort.AbsolutePitchHandler(
...         pitch_application_rate='division',
...         pitch_specifier="c' d' e' f' g' a' b' c''",
...         ),
...     rhythm_maker=rhythmmakertools.EvenDivisionRhythmMaker(denominators=[16]),
...     )
>>> music_setting = consort.MusicSetting(
...     timespan_maker=timespan_maker,
...     v1=music_specifier,
...     v2=music_specifier,
...     )
>>> segment_maker = new(segment_maker, settings=[music_setting])
>>> lilypond_file = segment_maker(verbose=False)
>>> consort.annotate(lilypond_file.score)
>>> show(lilypond_file)
\end{lstlisting}
\noindent\includegraphics[max width=\textwidth,]{assets/lilypond-76acdc0bda9feecdd70997204aa7c9c8.pdf}
\end{singlespacing}
%%% ABJADBOOK END %%%

\begin{comment}
<abjad>[stylesheet=../consort.ily]
music_specifier = new(
    music_specifier,
    pitch_handler__pitch_application_rate='phrase',
    )
music_setting = consort.MusicSetting(
    timespan_maker=timespan_maker,
    v1=music_specifier,
    v2=music_specifier,
    )
segment_maker = new(segment_maker, settings=[music_setting])
lilypond_file = segment_maker(verbose=False)
consort.annotate(lilypond_file.score)
show(lilypond_file)
</abjad>
\end{comment}

%%% ABJADBOOK START %%%
\begin{singlespacing}
\vspace{-0.5\baselineskip}
\begin{lstlisting}
>>> music_specifier = new(
...     music_specifier,
...     pitch_handler__pitch_application_rate='phrase',
...     )
>>> music_setting = consort.MusicSetting(
...     timespan_maker=timespan_maker,
...     v1=music_specifier,
...     v2=music_specifier,
...     )
>>> segment_maker = new(segment_maker, settings=[music_setting])
>>> lilypond_file = segment_maker(verbose=False)
>>> consort.annotate(lilypond_file.score)
>>> show(lilypond_file)
\end{lstlisting}
\noindent\includegraphics[max width=\textwidth,]{assets/lilypond-89244abdb768aa23fa5a7425fab9e539.pdf}
\end{singlespacing}
%%% ABJADBOOK END %%%

\begin{comment}
<abjad>[stylesheet=../consort.ily]
music_specifier = new(
    music_specifier,
    pitch_handler__deviations=(0, 0, '-m2', '+m2'),
    )
music_setting = consort.MusicSetting(
    timespan_maker=timespan_maker,
    v1=music_specifier,
    v2=music_specifier,
    )
segment_maker = new(segment_maker, settings=[music_setting])
lilypond_file = segment_maker(verbose=False)
consort.annotate(lilypond_file.score)
show(lilypond_file)
</abjad>
\end{comment}

%%% ABJADBOOK START %%%
\begin{singlespacing}
\vspace{-0.5\baselineskip}
\begin{lstlisting}
>>> music_specifier = new(
...     music_specifier,
...     pitch_handler__deviations=(0, 0, '-m2', '+m2'),
...     )
>>> music_setting = consort.MusicSetting(
...     timespan_maker=timespan_maker,
...     v1=music_specifier,
...     v2=music_specifier,
...     )
>>> segment_maker = new(segment_maker, settings=[music_setting])
>>> lilypond_file = segment_maker(verbose=False)
>>> consort.annotate(lilypond_file.score)
>>> show(lilypond_file)
\end{lstlisting}
\noindent\includegraphics[max width=\textwidth,]{assets/lilypond-ff0b1c46ddbd29c5a690fe7c182da0aa.pdf}
\end{singlespacing}
%%% ABJADBOOK END %%%

\subsection{Attachment handler examples}

\begin{comment}
<abjad>[stylesheet=../consort.ily]
music_specifier = consort.MusicSpecifier(
    attachment_handler=consort.AttachmentHandler(),
    rhythm_maker=rhythmmakertools.TaleaRhythmMaker(
        extra_counts_per_division=(0, 1),
        talea=rhythmmakertools.Talea([1, 2, 3, 1, 4], 16),
        ),
    )
timespan_maker = consort.TaleaTimespanMaker(
    initial_silence_talea=rhythmmakertools.Talea([0, 1], 4),
    playing_groupings=(1, 2, 2),
    playing_talea=rhythmmakertools.Talea([2, 3], 8),
    silence_talea=rhythmmakertools.Talea([1, 2, 3, 4], 8),
    )
music_setting = consort.MusicSetting(
    timespan_maker=timespan_maker,
    v1=music_specifier,
    v2=music_specifier,
    )
segment_maker = consort.SegmentMaker(
    desired_duration_in_seconds=8,
    discard_final_silence=True,
    omit_stylesheets=True,
    permitted_time_signatures=[(2, 4), (5, 16), (3, 4)],
    score_template=templatetools.GroupedRhythmicStavesScoreTemplate(
        staff_count=2,
        with_clefs=True,
        ),
    settings=[music_setting],
    tempo=indicatortools.Tempo((1, 4), 72),
    )
show(segment_maker, verbose=False)
</abjad>
\end{comment}

%%% ABJADBOOK START %%%
\begin{singlespacing}
\vspace{-0.5\baselineskip}
\begin{lstlisting}
>>> music_specifier = consort.MusicSpecifier(
...     attachment_handler=consort.AttachmentHandler(),
...     rhythm_maker=rhythmmakertools.TaleaRhythmMaker(
...         extra_counts_per_division=(0, 1),
...         talea=rhythmmakertools.Talea([1, 2, 3, 1, 4], 16),
...         ),
...     )
>>> timespan_maker = consort.TaleaTimespanMaker(
...     initial_silence_talea=rhythmmakertools.Talea([0, 1], 4),
...     playing_groupings=(1, 2, 2),
...     playing_talea=rhythmmakertools.Talea([2, 3], 8),
...     silence_talea=rhythmmakertools.Talea([1, 2, 3, 4], 8),
...     )
>>> music_setting = consort.MusicSetting(
...     timespan_maker=timespan_maker,
...     v1=music_specifier,
...     v2=music_specifier,
...     )
>>> segment_maker = consort.SegmentMaker(
...     desired_duration_in_seconds=8,
...     discard_final_silence=True,
...     omit_stylesheets=True,
...     permitted_time_signatures=[(2, 4), (5, 16), (3, 4)],
...     score_template=templatetools.GroupedRhythmicStavesScoreTemplate(
...         staff_count=2,
...         with_clefs=True,
...         ),
...     settings=[music_setting],
...     tempo=indicatortools.Tempo((1, 4), 72),
...     )
>>> show(segment_maker, verbose=False)
\end{lstlisting}
\noindent\includegraphics[max width=\textwidth,]{assets/lilypond-31ad7eaab600ca94fc940e6c050a8651.pdf}
\end{singlespacing}
%%% ABJADBOOK END %%%

\begin{comment}
<abjad>[stylesheet=../consort.ily]
music_specifier = new(
    music_specifier,
    attachment_handler__accents=consort.AttachmentExpression(
        attachments=Articulation('accent'),
        selector=selectortools.Selector().by_leaves()[0],
        ),
    )
music_setting = new(
    music_setting,
    v1=music_specifier,
    v2=music_specifier,
    )
segment_maker = new(segment_maker, settings=[music_setting])
show(segment_maker,verbose=False)
</abjad>
\end{comment}

%%% ABJADBOOK START %%%
\begin{singlespacing}
\vspace{-0.5\baselineskip}
\begin{lstlisting}
>>> music_specifier = new(
...     music_specifier,
...     attachment_handler__accents=consort.AttachmentExpression(
...         attachments=Articulation('accent'),
...         selector=selectortools.Selector().by_leaves()[0],
...         ),
...     )
>>> music_setting = new(
...     music_setting,
...     v1=music_specifier,
...     v2=music_specifier,
...     )
>>> segment_maker = new(segment_maker, settings=[music_setting])
>>> show(segment_maker,verbose=False)
\end{lstlisting}
\noindent\includegraphics[max width=\textwidth,]{assets/lilypond-5845a137b0839d77edd44e425c040cdb.pdf}
\end{singlespacing}
%%% ABJADBOOK END %%%

\begin{comment}
<abjad>[stylesheet=../consort.ily]
music_specifier = new(
    music_specifier,
    attachment_handler__tenuti=consort.AttachmentExpression(
        attachments=Articulation('tenuto'),
        selector=selectortools.Selector()
            .by_leaves()[1:]
            .by_logical_tie(pitched=True)[0],
        ),
    )
music_setting = new(
    music_setting,
    v1=music_specifier,
    v2=music_specifier,
    )
segment_maker = new(segment_maker, settings=[music_setting])
show(segment_maker, verbose=False)
</abjad>
\end{comment}

%%% ABJADBOOK START %%%
\begin{singlespacing}
\vspace{-0.5\baselineskip}
\begin{lstlisting}
>>> music_specifier = new(
...     music_specifier,
...     attachment_handler__tenuti=consort.AttachmentExpression(
...         attachments=Articulation('tenuto'),
...         selector=selectortools.Selector()
...             .by_leaves()[1:]
...             .by_logical_tie(pitched=True)[0],
...         ),
...     )
>>> music_setting = new(
...     music_setting,
...     v1=music_specifier,
...     v2=music_specifier,
...     )
>>> segment_maker = new(segment_maker, settings=[music_setting])
>>> show(segment_maker, verbose=False)
\end{lstlisting}
\noindent\includegraphics[max width=\textwidth,]{assets/lilypond-254b71b1dd161525523b2dfc96ee5b18.pdf}
\end{singlespacing}
%%% ABJADBOOK END %%%

\begin{comment}
<abjad>[stylesheet=../consort.ily]
music_specifier = new(
    music_specifier,
    attachment_handler__slurs=Slur()
    )
music_setting = new(
    music_setting,
    v1=music_specifier,
    v2=music_specifier,
    )
segment_maker = new(segment_maker, settings=[music_setting])
show(segment_maker, verbose=False)
</abjad>
\end{comment}

%%% ABJADBOOK START %%%
\begin{singlespacing}
\vspace{-0.5\baselineskip}
\begin{lstlisting}
>>> music_specifier = new(
...     music_specifier,
...     attachment_handler__slurs=Slur()
...     )
>>> music_setting = new(
...     music_setting,
...     v1=music_specifier,
...     v2=music_specifier,
...     )
>>> segment_maker = new(segment_maker, settings=[music_setting])
>>> show(segment_maker, verbose=False)
\end{lstlisting}
\noindent\includegraphics[max width=\textwidth,]{assets/lilypond-f0e62c688147028c121f9b53bb698a65.pdf}
\end{singlespacing}
%%% ABJADBOOK END %%%

\begin{comment}
<abjad>[stylesheet=../consort.ily]
music_specifier = new(
    music_specifier,
    attachment_handler__dynamics=consort.DynamicExpression(['f', 'p'])
    )
music_setting = new(
    music_setting,
    v1=music_specifier,
    v2=music_specifier,
    )
segment_maker = new(segment_maker, settings=[music_setting])
show(segment_maker, verbose=False)
</abjad>
\end{comment}

%%% ABJADBOOK START %%%
\begin{singlespacing}
\vspace{-0.5\baselineskip}
\begin{lstlisting}
>>> music_specifier = new(
...     music_specifier,
...     attachment_handler__dynamics=consort.DynamicExpression(['f', 'p'])
...     )
>>> music_setting = new(
...     music_setting,
...     v1=music_specifier,
...     v2=music_specifier,
...     )
>>> segment_maker = new(segment_maker, settings=[music_setting])
>>> show(segment_maker, verbose=False)
\end{lstlisting}
\noindent\includegraphics[max width=\textwidth,]{assets/lilypond-5134d656fed6cee151678103491f4f07.pdf}
\end{singlespacing}
%%% ABJADBOOK END %%%

\begin{comment}
<abjad>[stylesheet=../consort.ily]
lilypond_file = segment_maker(verbose=False)
consort.annotate(lilypond_file.score)
show(lilypond_file)
</abjad>
\end{comment}

%%% ABJADBOOK START %%%
\begin{singlespacing}
\vspace{-0.5\baselineskip}
\begin{lstlisting}
>>> lilypond_file = segment_maker(verbose=False)
>>> consort.annotate(lilypond_file.score)
>>> show(lilypond_file)
\end{lstlisting}
\noindent\includegraphics[max width=\textwidth,]{assets/lilypond-6e9d587e5ee37ad6583f5197bed09814.pdf}
\end{singlespacing}
%%% ABJADBOOK END %%%

\begin{markdown}
# Score post-processing
-   Voice copying
\end{markdown}
