%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
\chapter{Tools for modeling time, rhythm and meter}
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%

\begin{comment}
<abjad>[hide=true]
import consort
</abjad>
\end{comment}

Consort implements a model of composition which relies on a number of
interrelated but distinct approaches to working with musical time. Abjad's
\emph{timespan} object suggests a \enquote{coarse} approach to musical time.
Timespans represent arbitrary durated events on a timeline, without respect for
score hierarchy or meter. They are well-suited for modeling large scale
phrasing or gestural density structures and can handle overlap, splitting,
stretching and other transformations without requiring any notational reality.
Annotated timespans allow composers to position metadata anywhere on a
timeline, much like arranging audio regions in a DAW. Moreover, every durated
object in a score hierarchy can be described as a timespan, allowing score
components to engage in abstract time relations. In contrast, notated rhythms,
composed of note, rest, tie and tuplet objects -- among others, provide the
most \enquote{fine-grained} approach to musical time. While incredibly
expressive, fully notated rhythms are potentially complex to create, and must
ultimately be anchored in a score hierarchy. Rhythm maker classes ameliorate
the complexity of creating notated rhythms by providing a high-level interface
to the process of rhythmic generation. Meter coordinates time and rhythm
vertically across score hierarchy, and bridges the coarse and fine stages of
rhythmic interpretation. Meter sequences can be generated from timespan-based
phrase structures, and those meter sequences used to transform notated rhythms
in turn. A thorough discussion of the implementations of time models and their
implications will clarify a later analysis of Consort's score interpretation
stage.

%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
\section{Timespans}
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%

\emph{Timespans} model left-closed / right-open intervals of time positioned
absolutely along a timeline. This means that every timespan describes an
interval of time starting with -- and including -- some start offset and
leading up to -- but not including -- some stop offset. Note that all leaves in
a score describe such half-bounded interval of time. Adjacent notes in a score
do not overlap, but rather abut one another because their timespans do not
overlap. In fact, every durated object in a score -- every note, chord, rest,
measure, staff, and even the score itself -- can be described in terms of
timespans. Yet while score objects can always be described in terms of
timespans, timespans themselved do not -- by definition -- refer to any score
objects. Abjad implements timespans as immutable constants, much like Abjad's
\texttt{Pitch} and \texttt{Duration} objects, and similarly to Python's
implementation of numbers or strings. Constancy allows timespans to avoid a
variety of computational reference problems. Multiple objects can reference the
same timespan without fear of that timespan changing state, much as multiple
objects can reference the integer 11 without fear that it will change into the
integer 5.

Abjad implements timespans via the \texttt{timespantools.Timespan} class. The
following timespan begins at the offset 1/4 and continues up until the offset
3/2:

\begin{comment}
<abjad>
timespan = timespantools.Timespan(
    start_offset=Offset(1, 4),
    stop_offset=Offset(3, 2),
    )
print(timespan)
show(timespan)
</abjad>
\end{comment}

%%% ABJADBOOK START %%%
\begin{singlespacing}
\vspace{-0.5\baselineskip}
\begin{lstlisting}
>>> timespan = timespantools.Timespan(
...     start_offset=Offset(1, 4),
...     stop_offset=Offset(3, 2),
...     )
>>> print(timespan)
Timespan(start_offset=Offset(1, 4), stop_offset=Offset(3, 2))
\end{lstlisting}
\begin{lstlisting}
>>> show(timespan)
\end{lstlisting}
\noindent\includegraphics{assets/lilypond-12ab026823f0716cee59e2f80e77a4e9.pdf}
\end{singlespacing}
%%% ABJADBOOK END %%%

\noindent The \texttt{Timespan} class provides a large number of methods and
properties for inspecting timespans, comparing them to other timespans or
offsets, and for operating on timespans to generate new timespans. Once
instantiated, the timespan can be examined for its start offset, stop offset
and duration. Because of the \texttt{Timespan} class' immutability, these
properties are read-only and therefore can only be accessed, but not changed.

\begin{comment}
<abjad>
timespan.start_offset
timespan.stop_offset
timespan.duration
</abjad>
\end{comment}

%%% ABJADBOOK START %%%
\begin{singlespacing}
\vspace{-0.5\baselineskip}
\begin{lstlisting}
>>> timespan.start_offset
Offset(1, 4)
\end{lstlisting}
\begin{lstlisting}
>>> timespan.stop_offset
Offset(3, 2)
\end{lstlisting}
\begin{lstlisting}
>>> timespan.duration
Duration(5, 4)
\end{lstlisting}
\end{singlespacing}
%%% ABJADBOOK END %%%

\noindent A timespan's start offset must be equal to or less than its stop
offset. Timespans with identical start and stop offsets have a duration of 0
and effectively model a single time-point. Such timespans are considered not
\enquote{well-formed}:

\begin{comment}
<abjad>
timepoint_timespan = timespantools.Timespan(1, 1)
timepoint_timespan.duration
timepoint_timespan.is_well_formed
</abjad>
\end{comment}

%%% ABJADBOOK START %%%
\begin{singlespacing}
\vspace{-0.5\baselineskip}
\begin{lstlisting}
>>> timepoint_timespan = timespantools.Timespan(1, 1)
>>> timepoint_timespan.duration
Duration(0, 1)
\end{lstlisting}
\begin{lstlisting}
>>> timepoint_timespan.is_well_formed
False
\end{lstlisting}
\end{singlespacing}
%%% ABJADBOOK END %%%

\noindent Both the \texttt{start\_offset} and \texttt{stop\_offset} keywords to
the \texttt{Timespan} class' initializer are optional, and default to Abjad's
built-in rational constants \texttt{NegativeInfinity} and \texttt{Infinity}
respectively. A timespan created without specifying either a start or stop
offset effectively describes the timespan which encompasses all possible
offsets in time:

\begin{comment}
<abjad>
infinite_timespan = timespantools.Timespan()
infinite_timespan.start_offset
infinite_timespan.stop_offset
infinite_timespan.duration
</abjad>
\end{comment}

%%% ABJADBOOK START %%%
\begin{singlespacing}
\vspace{-0.5\baselineskip}
\begin{lstlisting}
>>> infinite_timespan = timespantools.Timespan()
>>> infinite_timespan.start_offset
NegativeInfinity
\end{lstlisting}
\begin{lstlisting}
>>> infinite_timespan.stop_offset
Infinity
\end{lstlisting}
\begin{lstlisting}
>>> infinite_timespan.duration
Infinity
\end{lstlisting}
\end{singlespacing}
%%% ABJADBOOK END %%%

\noindent By specifying only a start or stop offset, timespans can also be
created which encompass the infinite set of offsets up until some stop offset,
or the infinite set of offsets starting at and following some start-offset:

\begin{comment}
<abjad>
timespantools.Timespan(stop_offset=0)
timespantools.Timespan(start_offset=0)
</abjad>
\end{comment}

%%% ABJADBOOK START %%%
\begin{singlespacing}
\vspace{-0.5\baselineskip}
\begin{lstlisting}
>>> timespantools.Timespan(stop_offset=0)
Timespan(start_offset=NegativeInfinity, stop_offset=Offset(0, 1))
\end{lstlisting}
\begin{lstlisting}
>>> timespantools.Timespan(start_offset=0)
Timespan(start_offset=Offset(0, 1), stop_offset=Infinity)
\end{lstlisting}
\end{singlespacing}
%%% ABJADBOOK END %%%

\noindent \texttt{Timespan} objects also partake in Abjad's templating regime.
New timespans can be created from old ones through the use of the top-level
\texttt{new()} function:

\begin{comment}
<abjad>
new(timespan, stop_offset=(5, 16))
</abjad>
\end{comment}

%%% ABJADBOOK START %%%
\begin{singlespacing}
\vspace{-0.5\baselineskip}
\begin{lstlisting}
>>> new(timespan, stop_offset=(5, 16))
Timespan(start_offset=Offset(1, 4), stop_offset=Offset(5, 16))
\end{lstlisting}
\end{singlespacing}
%%% ABJADBOOK END %%%

\subsection{Annotated timespans} %%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%

While the \texttt{Timespan} class only has two configurable properties -- its
start offset and stop offset -- subclassing allows for the creation of new
classes with the same core functionality as \texttt{Timespan} but expanded to
allow for other configurable properties. As an example, \texttt{timespantools}
provides an \texttt{AnnotatedTimespan} class which subclasses \texttt{Timespan}
and adds a third read-only \texttt{annotation} property:

\begin{comment}
<abjad>
annotated_timespan = timespantools.AnnotatedTimespan(
    start_offset=(1, 8),
    stop_offset=(7, 8),
    annotation='Any arbitrary object can act as an annotation.'
    )
annotated_timespan.annotation
</abjad>
\end{comment}

%%% ABJADBOOK START %%%
\begin{singlespacing}
\vspace{-0.5\baselineskip}
\begin{lstlisting}
>>> annotated_timespan = timespantools.AnnotatedTimespan(
...     start_offset=(1, 8),
...     stop_offset=(7, 8),
...     annotation='Any arbitrary object can act as an annotation.'
...     )
>>> annotated_timespan.annotation
'Any arbitrary object can act as an annotation.'
\end{lstlisting}
\end{singlespacing}
%%% ABJADBOOK END %%%

\noindent Annotated timespans let composers position annotations or other
metadata arbitrarily along a timeline. If the annotation is itself a mutable
datastructure like a dictionary, that annotation can be used to store
increasing amounts of arbitrary information during the compositional process.
Abjad's top-level \texttt{new()} function can also be used to template new
annotated timespans from old ones, replacing one annotation with another:

\begin{comment}
<abjad>
metadata_timespan = new(annotated_timespan,
    stop_offset=(3, 2),
    annotation={
        'durations': ((1, 8), (1, 8), (3, 16)),
        'dynamic': indicatortools.Dynamic('ppp'),
        'pitch_segment': pitchtools.PitchSegment([0, 1, 4, 7]),
        },
    )
metadata_timespan.annotation['bow_contact_point'] = Multiplier(1, 3)
print(format(metadata_timespan))
</abjad>
\end{comment}

%%% ABJADBOOK START %%%
\begin{singlespacing}
\vspace{-0.5\baselineskip}
\begin{lstlisting}
>>> metadata_timespan = new(annotated_timespan,
...     stop_offset=(3, 2),
...     annotation={
...         'durations': ((1, 8), (1, 8), (3, 16)),
...         'dynamic': indicatortools.Dynamic('ppp'),
...         'pitch_segment': pitchtools.PitchSegment([0, 1, 4, 7]),
...         },
...     )
>>> metadata_timespan.annotation['bow_contact_point'] = Multiplier(1, 3)
>>> print(format(metadata_timespan))
timespantools.AnnotatedTimespan(
    start_offset=durationtools.Offset(1, 8),
    stop_offset=durationtools.Offset(3, 2),
    annotation={
        'bow_contact_point': durationtools.Multiplier(1, 3),
        'durations': (
            (1, 8),
            (1, 8),
            (3, 16),
            ),
        'dynamic': indicatortools.Dynamic(
            name='ppp',
            ),
        'pitch_segment': pitchtools.PitchSegment(
            (
                pitchtools.NumberedPitch(0),
                pitchtools.NumberedPitch(1),
                pitchtools.NumberedPitch(4),
                pitchtools.NumberedPitch(7),
                ),
            item_class=pitchtools.NumberedPitch,
            ),
        },
    )
\end{lstlisting}
\end{singlespacing}
%%% ABJADBOOK END %%%

\noindent Other subclasses are also possible, allowing for even more
configurable properties, as well as new methods. Two \texttt{Timespan}
subclasses discussed later, \texttt{consort.PerformedTimespan} and
\texttt{consort.SilentTimespan}, are core components in Consort's score
interpretation algorithm.

\subsection{Time relations} %%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%

Abjad's \texttt{timespantools} provides a \texttt{TimeRelation} class and a
collection of factory methods for configuring \texttt{TimeRelation} instances
which formalize all possible dispositions of a timespan relative another
timespan or relative an offset\footnote{ The thirty-three time relation factory
functions contained in \texttt{timespantools} are
\texttt{offset\_happens\_after\_timespan\_starts()},
\texttt{offset\_happens\_after\_timespan\_stops()},
\texttt{offset\_happens\_before\_timespan\_starts()},
\texttt{offset\_happens\_before\_timespan\_stops()},
\texttt{offset\_happens\_during\_timespan()},
\texttt{offset\_happens\_when\_timespan\_starts()},
\texttt{offset\_happens\_when\_timespan\_stops()},
\texttt{timespan\_2\_contains\_timespan\_1\_improperly()},
\texttt{timespan\_2\_curtails\_timespan\_1()},
\texttt{timespan\_2\_delays\_timespan\_1()},
\texttt{timespan\_2\_happens\_during\_timespan\_1()},
\texttt{timespan\_2\_intersects\_timespan\_1()},
\texttt{timespan\_2\_is\_congruent\_to\_timespan\_1()},
\texttt{timespan\_2\_overlaps\_all\_of\_timespan\_1()},
\texttt{timespan\_2\_overlaps\_only\_start\_of\_timespan\_1()},
\texttt{timespan\_2\_overlaps\_only\_stop\_of\_timespan\_1()},
\texttt{timespan\_2\_overlaps\_start\_of\_timespan\_1()},
\texttt{timespan\_2\_overlaps\_stop\_of\_timespan\_1()},
\texttt{timespan\_2\_starts\_after\_timespan\_1\_starts()},
\texttt{timespan\_2\_starts\_after\_timespan\_1\_stops()},
\texttt{timespan\_2\_starts\_before\_timespan\_1\_starts()},
\texttt{timespan\_2\_starts\_before\_timespan\_1\_stops()},
\texttt{timespan\_2\_starts\_during\_timespan\_1()},
\texttt{timespan\_2\_starts\_when\_timespan\_1\_starts()},
\texttt{timespan\_2\_starts\_when\_timespan\_1\_stops()},
\texttt{timespan\_2\_stops\_after\_timespan\_1\_starts()},
\texttt{timespan\_2\_stops\_after\_timespan\_1\_stops()},
\texttt{timespan\_2\_stops\_before\_timespan\_1\_starts()},
\texttt{timespan\_2\_stops\_before\_timespan\_1\_stops()},
\texttt{timespan\_2\_stops\_during\_timespan\_1()},
\texttt{timespan\_2\_stops\_when\_timespan\_1\_starts()},
\texttt{timespan\_2\_stops\_when\_timespan\_1\_stops()} and
\texttt{timespan\_2\_trisects\_timespan\_1()}. }. Time relations may be
configured with or without reference to any timespans or offsets at all,
allowing for the possibility of modeling a purely abstract time relationship.

\begin{comment}
<abjad>
time_relation_1 = timespantools.timespan_2_intersects_timespan_1()
print(format(time_relation_1))
</abjad>
\end{comment}

%%% ABJADBOOK START %%%
\begin{singlespacing}
\vspace{-0.5\baselineskip}
\begin{lstlisting}
>>> time_relation_1 = timespantools.timespan_2_intersects_timespan_1()
>>> print(format(time_relation_1))
timespantools.TimespanTimespanTimeRelation(
    inequality=timespantools.CompoundInequality(
        [
            timespantools.CompoundInequality(
                [
                    timespantools.SimpleInequality('timespan_1.start_offset <= timespan_2.start_offset'),
                    timespantools.SimpleInequality('timespan_2.start_offset < timespan_1.stop_offset'),
                    ],
                logical_operator='and',
                ),
            timespantools.CompoundInequality(
                [
                    timespantools.SimpleInequality('timespan_2.start_offset <= timespan_1.start_offset'),
                    timespantools.SimpleInequality('timespan_1.start_offset < timespan_2.stop_offset'),
                    ],
                logical_operator='and',
                ),
            ],
        logical_operator='or',
        ),
    )
\end{lstlisting}
\end{singlespacing}
%%% ABJADBOOK END %%%

\noindent A \enquote{half-configured} time relation is also possible. Such
object acts like a kind of \enquote{frozen} predicate function, and can be
called like a function on another timespan or offset to return a truth value.

\begin{comment}
<abjad>
time_relation_2 = timespantools.timespan_2_intersects_timespan_1(
    timespan_1=timespantools.Timespan(0, 10),
    )
time_relation_2(timespan_2=timespantools.Timespan(5, 15))
time_relation_2(timespan_2=timespantools.Timespan(30, 45))
</abjad>
\end{comment}

%%% ABJADBOOK START %%%
\begin{singlespacing}
\vspace{-0.5\baselineskip}
\begin{lstlisting}
>>> time_relation_2 = timespantools.timespan_2_intersects_timespan_1(
...     timespan_1=timespantools.Timespan(0, 10),
...     )
>>> time_relation_2(timespan_2=timespantools.Timespan(5, 15))
True
\end{lstlisting}
\begin{lstlisting}
>>> time_relation_2(timespan_2=timespantools.Timespan(30, 45))
False
\end{lstlisting}
\end{singlespacing}
%%% ABJADBOOK END %%%

\noindent Time relations which are \enquote{fully loaded} will be evaluated
immediately:

\begin{comment}
<abjad>
timespantools.timespan_2_intersects_timespan_1(
    timespan_1=timespantools.Timespan(1, 3),
    timespan_2=timespantools.Timespan(2, 4),
    )
</abjad>
\end{comment}

%%% ABJADBOOK START %%%
\begin{singlespacing}
\vspace{-0.5\baselineskip}
\begin{lstlisting}
>>> timespantools.timespan_2_intersects_timespan_1(
...     timespan_1=timespantools.Timespan(1, 3),
...     timespan_2=timespantools.Timespan(2, 4),
...     )
True
\end{lstlisting}
\end{singlespacing}
%%% ABJADBOOK END %%%

\noindent The time relation factory functions in \texttt{timespantools} are
also implemented as methods on the \texttt{Timespan} class itself, allowing
composers to determine the various relations of any timespan relative any other
timespan or offset in an object-oriented fashion. The \texttt{Timespan} object
automatically \enquote{fills in} the \texttt{timespan\_1} argument to the
\texttt{TimeRelation} with itself, and can pass the optional argument to its
method call as the other object in the relation, allowing for the immediate
evaluation of the relation as either true or false.

Consider the following three timespans:

\begin{comment}
<abjad>
timespan_1 = timespantools.Timespan(0, 10)
timespan_2 = timespantools.Timespan(5, 15)
timespan_3 = timespantools.Timespan(10, 20)
</abjad>
\end{comment}

%%% ABJADBOOK START %%%
\begin{singlespacing}
\vspace{-0.5\baselineskip}
\begin{lstlisting}
>>> timespan_1 = timespantools.Timespan(0, 10)
>>> timespan_2 = timespantools.Timespan(5, 15)
>>> timespan_3 = timespantools.Timespan(10, 20)
\end{lstlisting}
\end{singlespacing}
%%% ABJADBOOK END %%%

\noindent These three timespans could be represented together visually like
this:

\begin{comment}
<abjad>[hide=true]
timespan_inventory = timespantools.TimespanInventory([
    timespan_1,
    timespan_2,
    timespan_3,
    ])
show(timespan_inventory)
</abjad>
\end{comment}

%%% ABJADBOOK START %%%
\begin{singlespacing}
\vspace{-0.5\baselineskip}
\noindent\includegraphics{assets/lilypond-a75a0f25e64c4b1f6c8f78544f5e028d.pdf}
\end{singlespacing}
%%% ABJADBOOK END %%%

\noindent We can test for intersection between these three timespans via the
\texttt{intersects\_timespan()} method. Two timespans are considered to
intersect if any part of one timespan overlaps any part of another, and is
therefore commutative. Note that \texttt{timespan\_1} and \texttt{timespan\_3}
do not overlap even though they share the offset 10. As discussed earlier,
timespans are left-closed / right-open, meaning that while their start offset is
contained in the infinite set of offsets they cover, their stop offset is not.

\begin{comment}
<abjad>
timespan_1.intersects_timespan(timespan_2)
timespan_1.intersects_timespan(timespan_3)
timespan_2.intersects_timespan(timespan_1)
timespan_2.intersects_timespan(timespan_3)
timespan_3.intersects_timespan(timespan_1)
timespan_3.intersects_timespan(timespan_2)
</abjad>
\end{comment}

%%% ABJADBOOK START %%%
\begin{singlespacing}
\vspace{-0.5\baselineskip}
\begin{lstlisting}
>>> timespan_1.intersects_timespan(timespan_2)
True
\end{lstlisting}
\begin{lstlisting}
>>> timespan_1.intersects_timespan(timespan_3)
False
\end{lstlisting}
\begin{lstlisting}
>>> timespan_2.intersects_timespan(timespan_1)
True
\end{lstlisting}
\begin{lstlisting}
>>> timespan_2.intersects_timespan(timespan_3)
True
\end{lstlisting}
\begin{lstlisting}
>>> timespan_3.intersects_timespan(timespan_1)
False
\end{lstlisting}
\begin{lstlisting}
>>> timespan_3.intersects_timespan(timespan_2)
True
\end{lstlisting}
\end{singlespacing}
%%% ABJADBOOK END %%%

\noindent Congruency tests whether two timespans share the same start and stop
offset. Every timespan is congruent with itself:

\begin{comment}
<abjad>
timespan_1.is_congruent_to_timespan(timespan_2)
timespan_1.is_congruent_to_timespan(timespan_1)
</abjad>
\end{comment}

%%% ABJADBOOK START %%%
\begin{singlespacing}
\vspace{-0.5\baselineskip}
\begin{lstlisting}
>>> timespan_1.is_congruent_to_timespan(timespan_2)
False
\end{lstlisting}
\begin{lstlisting}
>>> timespan_1.is_congruent_to_timespan(timespan_1)
True
\end{lstlisting}
\end{singlespacing}
%%% ABJADBOOK END %%%

\noindent Tangency tests whether one timespan's stop offset is the same as
another timespan's start offset, or vice versa. Tangency can be used to
determine if a sorted collection of timespans are all contiguous together.

\begin{comment}
<abjad>
timespan_1.is_tangent_to_timespan(timespan_2)
timespan_1.is_tangent_to_timespan(timespan_3)
</abjad>
\end{comment}

%%% ABJADBOOK START %%%
\begin{singlespacing}
\vspace{-0.5\baselineskip}
\begin{lstlisting}
>>> timespan_1.is_tangent_to_timespan(timespan_2)
False
\end{lstlisting}
\begin{lstlisting}
>>> timespan_1.is_tangent_to_timespan(timespan_3)
True
\end{lstlisting}
\end{singlespacing}
%%% ABJADBOOK END %%%

\noindent A wide variety of other time relation predicates are also possible,
such as testing if a timespan intersects with a specific offset, testing if a
timespan overlaps only the beginning or end of another timespan, or testing if
a timespan contains another timespan entirely. These predicates make possible
many of the generative operations carried out on timespans.

\subsection{Operations on timespans} %%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%

Many \texttt{Timespan} methods provide transformations, such as translation,
scaling or offset rounding. Because timespans are immutable, these methods
create a new timespan based on the old one and then return the new, leaving
the old exactly as it was:

\begin{comment}
<abjad>
timespan = timespantools.Timespan(0, 15)
timespan.translate(3)
timespan.scale(3)
timespan.round_offsets(2)
</abjad>
\end{comment}

%%% ABJADBOOK START %%%
\begin{singlespacing}
\vspace{-0.5\baselineskip}
\begin{lstlisting}
>>> timespan = timespantools.Timespan(0, 15)
>>> timespan.translate(3)
Timespan(start_offset=Offset(3, 1), stop_offset=Offset(18, 1))
\end{lstlisting}
\begin{lstlisting}
>>> timespan.scale(3)
Timespan(start_offset=Offset(0, 1), stop_offset=Offset(45, 1))
\end{lstlisting}
\begin{lstlisting}
>>> timespan.round_offsets(2)
Timespan(start_offset=Offset(0, 1), stop_offset=Offset(16, 1))
\end{lstlisting}
\end{singlespacing}
%%% ABJADBOOK END %%%

\noindent Internally, these generative methods are implemented via templating
as described earlier, allowing annotated timespan subclasses to partake in the
same templating functionality -- templating their start and / or stop offsets,
but maintaining all other previously configured properties:

\begin{comment}
<abjad>
annotated_timespan = timespantools.AnnotatedTimespan(0, 5, 'an annotation')
scaled_annotated_timespan = annotated_timespan.translate((-1, 3))
print(format(scaled_annotated_timespan))
</abjad>
\end{comment}

%%% ABJADBOOK START %%%
\begin{singlespacing}
\vspace{-0.5\baselineskip}
\begin{lstlisting}
>>> annotated_timespan = timespantools.AnnotatedTimespan(0, 5, 'an annotation')
>>> scaled_annotated_timespan = annotated_timespan.translate((-1, 3))
>>> print(format(scaled_annotated_timespan))
timespantools.AnnotatedTimespan(
    start_offset=durationtools.Offset(-1, 3),
    stop_offset=durationtools.Offset(14, 3),
    annotation='an annotation',
    )
\end{lstlisting}
\end{singlespacing}
%%% ABJADBOOK END %%%

\noindent Some generative operations may return zero or more timespans,
aggregated in a datastructure called a \emph{timespan inventory}, which is
discussed at length in the following section. Splitting a timespan by an offset
is one such operation. If the offset to be split by is \emph{properly
contained}\footnote{\emph{Proper containment} of an offset means that the
offset is greater than the timespan's start offset and less than the timespan's
stop offset. \emph{Improper containment} would indicated the offset is greater
than or equal to the timespan's start offset and less than or equal to its stop
offset.} by the timespan to be split, two new timespans will be returned,
otherwise a timespan inventory containing a copy of the original input timespan
will be returned:

\begin{comment}
<abjad>
two_shards = timespan.split_at_offset(5)
print(format(two_shards))
one_shard = timespan.split_at_offset(10000)
print(format(one_shard))
</abjad>
\end{comment}

%%% ABJADBOOK START %%%
\begin{singlespacing}
\vspace{-0.5\baselineskip}
\begin{lstlisting}
>>> two_shards = timespan.split_at_offset(5)
>>> print(format(two_shards))
timespantools.TimespanInventory(
    [
        timespantools.Timespan(
            start_offset=durationtools.Offset(0, 1),
            stop_offset=durationtools.Offset(5, 1),
            ),
        timespantools.Timespan(
            start_offset=durationtools.Offset(5, 1),
            stop_offset=durationtools.Offset(15, 1),
            ),
        ]
    )
\end{lstlisting}
\begin{lstlisting}
>>> one_shard = timespan.split_at_offset(10000)
>>> print(format(one_shard))
timespantools.TimespanInventory(
    [
        timespantools.Timespan(
            start_offset=durationtools.Offset(0, 1),
            stop_offset=durationtools.Offset(15, 1),
            ),
        ]
    )
\end{lstlisting}
\end{singlespacing}
%%% ABJADBOOK END %%%

\noindent More complex operations between timespans which result in timespan
inventories include subtraction, as well as logical \texttt{AND}, \texttt{OR}
and \texttt{XOR}. These generative operations are conceptually \emph{set}
operations -- union, difference, intersection, symmetric difference, etc. --
performed on the two sets of offsets contained by the two timespan operands.
Consider these same set operations -- union, difference, intersection,
symmetric difference -- carried out on trivial sets in Python:

\begin{comment}
<abjad>
set([1, 2, 3]) | set([2, 3, 4])  # union
set([1, 2, 3]) - set([2, 3, 4])  # difference
set([1, 2, 3]) & set([2, 3, 4])  # intersection
set([1, 2, 3]) ^ set([2, 3, 4])  # symmetric difference
</abjad>
\end{comment}

%%% ABJADBOOK START %%%
\begin{singlespacing}
\vspace{-0.5\baselineskip}
\begin{lstlisting}
>>> set([1, 2, 3]) | set([2, 3, 4])  # union
set([1, 2, 3, 4])
\end{lstlisting}
\begin{lstlisting}
>>> set([1, 2, 3]) - set([2, 3, 4])  # difference
set([1])
\end{lstlisting}
\begin{lstlisting}
>>> set([1, 2, 3]) & set([2, 3, 4])  # intersection
set([2, 3])
\end{lstlisting}
\begin{lstlisting}
>>> set([1, 2, 3]) ^ set([2, 3, 4])  # symmetric difference
set([1, 4])
\end{lstlisting}
\end{singlespacing}
%%% ABJADBOOK END %%%

\noindent Set operations performed on timespans are conceptually identical, but
operate on infinite but bounded sets of offsets instead of discrete sets of
objects such as integers. For example, subtracting one timespan from another
computes the set difference of the offsets contained by both. This operation is
not commutative -- subtracting one timespan from another will not result in the
same ouput as subtract the latter from the former. Subtracting a timespan from
itself always results in the empty set of offsets: no timespan at all:

\begin{comment}
<abjad>
result = timespantools.Timespan(0, 10) - timespantools.Timespan(0, 10)
print(format(result))
result = timespantools.Timespan(0, 10) - timespantools.Timespan(5, 15)
print(format(result))
result = timespantools.Timespan(0, 10) - timespantools.Timespan(10, 20)
print(format(result))
result = timespantools.Timespan(5, 15) - timespantools.Timespan(0, 10)
print(format(result))
result = timespantools.Timespan(5, 15) - timespantools.Timespan(5, 15)
print(format(result))
result = timespantools.Timespan(5, 15) - timespantools.Timespan(10, 20)
print(format(result))
result = timespantools.Timespan(10, 20) - timespantools.Timespan(0, 10)
print(format(result))
result = timespantools.Timespan(10, 20) - timespantools.Timespan(5, 15)
print(format(result))
result = timespantools.Timespan(10, 20) - timespantools.Timespan(10, 20)
print(format(result))
</abjad>
\end{comment}

%%% ABJADBOOK START %%%
\begin{singlespacing}
\vspace{-0.5\baselineskip}
\begin{lstlisting}
>>> result = timespantools.Timespan(0, 10) - timespantools.Timespan(0, 10)
>>> print(format(result))
timespantools.TimespanInventory(
    []
    )
\end{lstlisting}
\begin{lstlisting}
>>> result = timespantools.Timespan(0, 10) - timespantools.Timespan(5, 15)
>>> print(format(result))
timespantools.TimespanInventory(
    [
        timespantools.Timespan(
            start_offset=durationtools.Offset(0, 1),
            stop_offset=durationtools.Offset(5, 1),
            ),
        ]
    )
\end{lstlisting}
\begin{lstlisting}
>>> result = timespantools.Timespan(0, 10) - timespantools.Timespan(10, 20)
>>> print(format(result))
timespantools.TimespanInventory(
    [
        timespantools.Timespan(
            start_offset=durationtools.Offset(0, 1),
            stop_offset=durationtools.Offset(10, 1),
            ),
        ]
    )
\end{lstlisting}
\begin{lstlisting}
>>> result = timespantools.Timespan(5, 15) - timespantools.Timespan(0, 10)
>>> print(format(result))
timespantools.TimespanInventory(
    [
        timespantools.Timespan(
            start_offset=durationtools.Offset(10, 1),
            stop_offset=durationtools.Offset(15, 1),
            ),
        ]
    )
\end{lstlisting}
\begin{lstlisting}
>>> result = timespantools.Timespan(5, 15) - timespantools.Timespan(5, 15)
>>> print(format(result))
timespantools.TimespanInventory(
    []
    )
\end{lstlisting}
\begin{lstlisting}
>>> result = timespantools.Timespan(5, 15) - timespantools.Timespan(10, 20)
>>> print(format(result))
timespantools.TimespanInventory(
    [
        timespantools.Timespan(
            start_offset=durationtools.Offset(5, 1),
            stop_offset=durationtools.Offset(10, 1),
            ),
        ]
    )
\end{lstlisting}
\begin{lstlisting}
>>> result = timespantools.Timespan(10, 20) - timespantools.Timespan(0, 10)
>>> print(format(result))
timespantools.TimespanInventory(
    [
        timespantools.Timespan(
            start_offset=durationtools.Offset(10, 1),
            stop_offset=durationtools.Offset(20, 1),
            ),
        ]
    )
\end{lstlisting}
\begin{lstlisting}
>>> result = timespantools.Timespan(10, 20) - timespantools.Timespan(5, 15)
>>> print(format(result))
timespantools.TimespanInventory(
    [
        timespantools.Timespan(
            start_offset=durationtools.Offset(15, 1),
            stop_offset=durationtools.Offset(20, 1),
            ),
        ]
    )
\end{lstlisting}
\begin{lstlisting}
>>> result = timespantools.Timespan(10, 20) - timespantools.Timespan(10, 20)
>>> print(format(result))
timespantools.TimespanInventory(
    []
    )
\end{lstlisting}
\end{singlespacing}
%%% ABJADBOOK END %%%

\noindent Computing the logical \texttt{OR} of two timespans results in an
offset set union -- a commutative operation, effectively fusing the timespans
together if they overlap:

\begin{comment}
<abjad>
result = timespantools.Timespan(0, 10) | timespantools.Timespan(5, 15)
print(format(result))
result = timespantools.Timespan(0, 10) | timespantools.Timespan(10, 20)
print(format(result))
result = timespantools.Timespan(5, 15) | timespantools.Timespan(10, 20)
print(format(result))
</abjad>
\end{comment}

%%% ABJADBOOK START %%%
\begin{singlespacing}
\vspace{-0.5\baselineskip}
\begin{lstlisting}
>>> result = timespantools.Timespan(0, 10) | timespantools.Timespan(5, 15)
>>> print(format(result))
timespantools.TimespanInventory(
    [
        timespantools.Timespan(
            start_offset=durationtools.Offset(0, 1),
            stop_offset=durationtools.Offset(15, 1),
            ),
        ]
    )
\end{lstlisting}
\begin{lstlisting}
>>> result = timespantools.Timespan(0, 10) | timespantools.Timespan(10, 20)
>>> print(format(result))
timespantools.TimespanInventory(
    [
        timespantools.Timespan(
            start_offset=durationtools.Offset(0, 1),
            stop_offset=durationtools.Offset(20, 1),
            ),
        ]
    )
\end{lstlisting}
\begin{lstlisting}
>>> result = timespantools.Timespan(5, 15) | timespantools.Timespan(10, 20)
>>> print(format(result))
timespantools.TimespanInventory(
    [
        timespantools.Timespan(
            start_offset=durationtools.Offset(5, 1),
            stop_offset=durationtools.Offset(20, 1),
            ),
        ]
    )
\end{lstlisting}
\end{singlespacing}
%%% ABJADBOOK END %%%

\noindent Unioning guarantees that all of the offsets contained in the two
input timespans will appear in the output timespan(s), whether or not any
overlap occurred:

\begin{comment}
<abjad>
result = timespantools.Timespan(10, 20) | timespantools.Timespan(25, 50)
print(format(result))
</abjad>
\end{comment}

%%% ABJADBOOK START %%%
\begin{singlespacing}
\vspace{-0.5\baselineskip}
\begin{lstlisting}
>>> result = timespantools.Timespan(10, 20) | timespantools.Timespan(25, 50)
>>> print(format(result))
timespantools.TimespanInventory(
    [
        timespantools.Timespan(
            start_offset=durationtools.Offset(10, 1),
            stop_offset=durationtools.Offset(20, 1),
            ),
        timespantools.Timespan(
            start_offset=durationtools.Offset(25, 1),
            stop_offset=durationtools.Offset(50, 1),
            ),
        ]
    )
\end{lstlisting}
\end{singlespacing}
%%% ABJADBOOK END %%%

\noindent The logical \texttt{AND} -- set intersection -- results in the
intersection of the two input timespans:

\begin{comment}
<abjad>
result = timespantools.Timespan(0, 10) & timespantools.Timespan(5, 15)
print(format(result))
result = timespantools.Timespan(0, 10) & timespantools.Timespan(10, 20)
print(format(result))
result = timespantools.Timespan(5, 15) & timespantools.Timespan(10, 20)
print(format(result))
</abjad>
\end{comment}

%%% ABJADBOOK START %%%
\begin{singlespacing}
\vspace{-0.5\baselineskip}
\begin{lstlisting}
>>> result = timespantools.Timespan(0, 10) & timespantools.Timespan(5, 15)
>>> print(format(result))
timespantools.TimespanInventory(
    [
        timespantools.Timespan(
            start_offset=durationtools.Offset(5, 1),
            stop_offset=durationtools.Offset(10, 1),
            ),
        ]
    )
\end{lstlisting}
\begin{lstlisting}
>>> result = timespantools.Timespan(0, 10) & timespantools.Timespan(10, 20)
>>> print(format(result))
timespantools.TimespanInventory(
    []
    )
\end{lstlisting}
\begin{lstlisting}
>>> result = timespantools.Timespan(5, 15) & timespantools.Timespan(10, 20)
>>> print(format(result))
timespantools.TimespanInventory(
    [
        timespantools.Timespan(
            start_offset=durationtools.Offset(10, 1),
            stop_offset=durationtools.Offset(15, 1),
            ),
        ]
    )
\end{lstlisting}
\end{singlespacing}
%%% ABJADBOOK END %%%

\noindent Logical \texttt{XOR} -- also known as exclusive \texttt{OR} --
results in the symmetric difference of the two input timespans. Only those
offsets which are contained by only one of the two input timespans will occur
in the output:

\begin{comment}
<abjad>
result = timespantools.Timespan(0, 10) ^ timespantools.Timespan(5, 15)
print(format(result))
result = timespantools.Timespan(0, 10) ^ timespantools.Timespan(10, 20)
print(format(result))
result = timespantools.Timespan(5, 15) ^ timespantools.Timespan(10, 20)
print(format(result))
</abjad>
\end{comment}

%%% ABJADBOOK START %%%
\begin{singlespacing}
\vspace{-0.5\baselineskip}
\begin{lstlisting}
>>> result = timespantools.Timespan(0, 10) ^ timespantools.Timespan(5, 15)
>>> print(format(result))
timespantools.TimespanInventory(
    [
        timespantools.Timespan(
            start_offset=durationtools.Offset(0, 1),
            stop_offset=durationtools.Offset(5, 1),
            ),
        timespantools.Timespan(
            start_offset=durationtools.Offset(10, 1),
            stop_offset=durationtools.Offset(15, 1),
            ),
        ]
    )
\end{lstlisting}
\begin{lstlisting}
>>> result = timespantools.Timespan(0, 10) ^ timespantools.Timespan(10, 20)
>>> print(format(result))
timespantools.TimespanInventory(
    [
        timespantools.Timespan(
            start_offset=durationtools.Offset(0, 1),
            stop_offset=durationtools.Offset(10, 1),
            ),
        timespantools.Timespan(
            start_offset=durationtools.Offset(10, 1),
            stop_offset=durationtools.Offset(20, 1),
            ),
        ]
    )
\end{lstlisting}
\begin{lstlisting}
>>> result = timespantools.Timespan(5, 15) ^ timespantools.Timespan(10, 20)
>>> print(format(result))
timespantools.TimespanInventory(
    [
        timespantools.Timespan(
            start_offset=durationtools.Offset(5, 1),
            stop_offset=durationtools.Offset(10, 1),
            ),
        timespantools.Timespan(
            start_offset=durationtools.Offset(15, 1),
            stop_offset=durationtools.Offset(20, 1),
            ),
        ]
    )
\end{lstlisting}
\end{singlespacing}
%%% ABJADBOOK END %%%

\noindent These operations, while perhaps initially rather abstract, are
incredibly powerful and artistically useful. They afford composers with the
procedural building blocks to mask temporal objects with one another, fuse them
together, or create lacunae. When extended to operate on many timespans at
once, wholesale transformations on massed timespans becomes practical.

%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
\section{Timespan inventories}
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%

Abjad provides a \texttt{TimespanInventory} class specifically for aggregating
together a collection of \texttt{Timespan} objects. Timespan inventories
implement Python's \emph{mutable sequence protocol} which allow them to behave
exactly like lists, supporting appension, extension, insertion, indexing,
sorting, iteration and other procedures pertinent to list-like objects. They
also provide a wide variety of properties and methods for interacting with
massed groups of timespans such as searching for timespans matching a time
relation, splitting all timespans which interact with a given offset or
partitioning one inventory into multiple separate inventories of overlapping
timespans.

A timespan inventory can be created with a list of zero or more timespans as an
argument, be appended to, or extended into:

\begin{comment}
<abjad>
timespan_inventory = timespantools.TimespanInventory([
    timespantools.Timespan(0, 16),
    ])
timespan_inventory.append(timespantools.Timespan(5, 12))
timespan_inventory.extend([
    timespantools.Timespan(-2, 8),
    timespantools.Timespan(15, 20),
    ])
print(format(timespan_inventory))
show(timespan_inventory)
</abjad>
\end{comment}

%%% ABJADBOOK START %%%
\begin{singlespacing}
\vspace{-0.5\baselineskip}
\begin{lstlisting}
>>> timespan_inventory = timespantools.TimespanInventory([
...     timespantools.Timespan(0, 16),
...     ])
>>> timespan_inventory.append(timespantools.Timespan(5, 12))
>>> timespan_inventory.extend([
...     timespantools.Timespan(-2, 8),
...     timespantools.Timespan(15, 20),
...     ])
>>> print(format(timespan_inventory))
timespantools.TimespanInventory(
    [
        timespantools.Timespan(
            start_offset=durationtools.Offset(0, 1),
            stop_offset=durationtools.Offset(16, 1),
            ),
        timespantools.Timespan(
            start_offset=durationtools.Offset(5, 1),
            stop_offset=durationtools.Offset(12, 1),
            ),
        timespantools.Timespan(
            start_offset=durationtools.Offset(-2, 1),
            stop_offset=durationtools.Offset(8, 1),
            ),
        timespantools.Timespan(
            start_offset=durationtools.Offset(15, 1),
            stop_offset=durationtools.Offset(20, 1),
            ),
        ]
    )
\end{lstlisting}
\begin{lstlisting}
>>> show(timespan_inventory)
\end{lstlisting}
\noindent\includegraphics{assets/lilypond-ae5c9d1428c32d953939a845f498e90e.pdf}
\end{singlespacing}
%%% ABJADBOOK END %%%

\noindent Timespan inventories can also be queried for their length -- just
like any other sequence in Python --, be indexed into, or iterated over:

\begin{comment}
<abjad>
len(timespan_inventory)
timespan_inventory[1]
for timespan in timespan_inventory:
    timespan

</abjad>
\end{comment}

%%% ABJADBOOK START %%%
\begin{singlespacing}
\vspace{-0.5\baselineskip}
\begin{lstlisting}
>>> len(timespan_inventory)
4
\end{lstlisting}
\begin{lstlisting}
>>> timespan_inventory[1]
Timespan(start_offset=Offset(5, 1), stop_offset=Offset(12, 1))
\end{lstlisting}
\begin{lstlisting}
>>> for timespan in timespan_inventory:
...     timespan
...
Timespan(start_offset=Offset(0, 1), stop_offset=Offset(16, 1))
Timespan(start_offset=Offset(5, 1), stop_offset=Offset(12, 1))
Timespan(start_offset=Offset(-2, 1), stop_offset=Offset(8, 1))
Timespan(start_offset=Offset(15, 1), stop_offset=Offset(20, 1))
\end{lstlisting}
\end{singlespacing}
%%% ABJADBOOK END %%%

\noindent Similarly, one timespan inventory can be created from another -- just
like one can create a Python list simply by calling \texttt{list()} on another
iterable object -- by passing the first timespan inventory as an instantiation
argument to the second. As many of the mutating methods implemented on timespan
inventories operate in place, this instantiation pattern provides a simple
means of \enquote{copying}, allowing composers to duplicate a timespan
structure before operating on it, thereby preserving the original.

\begin{comment}
<abjad>
duplicate = timespantools.TimespanInventory(timespan_inventory)
duplicate == timespan_inventory
duplicate is timespan_inventory
print(format(duplicate))
</abjad>
\end{comment}

%%% ABJADBOOK START %%%
\begin{singlespacing}
\vspace{-0.5\baselineskip}
\begin{lstlisting}
>>> duplicate = timespantools.TimespanInventory(timespan_inventory)
>>> duplicate == timespan_inventory
True
\end{lstlisting}
\begin{lstlisting}
>>> duplicate is timespan_inventory
False
\end{lstlisting}
\begin{lstlisting}
>>> print(format(duplicate))
timespantools.TimespanInventory(
    [
        timespantools.Timespan(
            start_offset=durationtools.Offset(0, 1),
            stop_offset=durationtools.Offset(16, 1),
            ),
        timespantools.Timespan(
            start_offset=durationtools.Offset(5, 1),
            stop_offset=durationtools.Offset(12, 1),
            ),
        timespantools.Timespan(
            start_offset=durationtools.Offset(-2, 1),
            stop_offset=durationtools.Offset(8, 1),
            ),
        timespantools.Timespan(
            start_offset=durationtools.Offset(15, 1),
            stop_offset=durationtools.Offset(20, 1),
            ),
        ]
    )
\end{lstlisting}
\end{singlespacing}
%%% ABJADBOOK END %%%

Timespan inventories can be treated as timespans themselves, having
a start offset equal to the minimum start offset of any of their contained
timespans, and a stop offset equal to the maximum stop offset of any of their
contained timespans. Their start and stop offset properties allow them to
express a duration, as well as provide a concrete timespan representation.
Because timespan inventories can be modeled as timespans, they can even be
inserted into other timespan inventories.

\begin{comment}
<abjad>
timespan_inventory.start_offset
timespan_inventory.stop_offset
timespan_inventory.duration
timespan_inventory.timespan
</abjad>
\end{comment}

%%% ABJADBOOK START %%%
\begin{singlespacing}
\vspace{-0.5\baselineskip}
\begin{lstlisting}
>>> timespan_inventory.start_offset
Offset(-2, 1)
\end{lstlisting}
\begin{lstlisting}
>>> timespan_inventory.stop_offset
Offset(20, 1)
\end{lstlisting}
\begin{lstlisting}
>>> timespan_inventory.duration
Duration(22, 1)
\end{lstlisting}
\begin{lstlisting}
>>> timespan_inventory.timespan
Timespan(start_offset=Offset(-2, 1), stop_offset=Offset(20, 1))
\end{lstlisting}
\end{singlespacing}
%%% ABJADBOOK END %%%

\noindent Because timespan inventories aggregate multiple timespans together,
they also provide properties for describing collective qualities of those
timespans. \emph{Contiguity} tests if every timespan in the inventory is
tangent to another timespan, and does not overlap any other timespan,
\emph{overlap} tests if any timespan intersects any other timespan, and
\emph{well-formedness} tests that all timespans' durations are greater than 0.
A timespan inventory whose timespans are contiguous is necessarily
also non-overlapping.

\begin{comment}
<abjad>
timespan_inventory.all_are_contiguous
timespan_inventory.all_are_nonoverlapping
timespan_inventory.all_are_well_formed
</abjad>
\end{comment}

%%% ABJADBOOK START %%%
\begin{singlespacing}
\vspace{-0.5\baselineskip}
\begin{lstlisting}
>>> timespan_inventory.all_are_contiguous
False
\end{lstlisting}
\begin{lstlisting}
>>> timespan_inventory.all_are_nonoverlapping
False
\end{lstlisting}
\begin{lstlisting}
>>> timespan_inventory.all_are_well_formed
True
\end{lstlisting}
\end{singlespacing}
%%% ABJADBOOK END %%%

\noindent The following timespan inventory's timespans are non-overlapping but
also non-contiguous:

\begin{comment}
<abjad>
timespan_inventory = timespantools.TimespanInventory([
    timespantools.Timespan(0, 10),
    timespantools.Timespan(10, 20),
    timespantools.Timespan(30, 40),
    ])
show(timespan_inventory)
timespan_inventory.all_are_contiguous
timespan_inventory.all_are_nonoverlapping
</abjad>
\end{comment}

%%% ABJADBOOK START %%%
\begin{singlespacing}
\vspace{-0.5\baselineskip}
\begin{lstlisting}
>>> timespan_inventory = timespantools.TimespanInventory([
...     timespantools.Timespan(0, 10),
...     timespantools.Timespan(10, 20),
...     timespantools.Timespan(30, 40),
...     ])
>>> show(timespan_inventory)
\end{lstlisting}
\noindent\includegraphics{assets/lilypond-ca27b6b4f676e7b346d961ba8e93e58b.pdf}
\begin{lstlisting}
>>> timespan_inventory.all_are_contiguous
False
\end{lstlisting}
\begin{lstlisting}
>>> timespan_inventory.all_are_nonoverlapping
True
\end{lstlisting}
\end{singlespacing}
%%% ABJADBOOK END %%%

\noindent In contrast, this timespan inventory's timespans are both
non-overlapping and contiguous:

\begin{comment}
<abjad>
timespan_inventory = timespantools.TimespanInventory([
    timespantools.Timespan(0, 10),
    timespantools.Timespan(10, 20),
    timespantools.Timespan(20, 30),
    ])
show(timespan_inventory)
timespan_inventory.all_are_contiguous
timespan_inventory.all_are_nonoverlapping
</abjad>
\end{comment}

%%% ABJADBOOK START %%%
\begin{singlespacing}
\vspace{-0.5\baselineskip}
\begin{lstlisting}
>>> timespan_inventory = timespantools.TimespanInventory([
...     timespantools.Timespan(0, 10),
...     timespantools.Timespan(10, 20),
...     timespantools.Timespan(20, 30),
...     ])
>>> show(timespan_inventory)
\end{lstlisting}
\noindent\includegraphics{assets/lilypond-13312f49d0e1c1dec7a381054d7b94d8.pdf}
\begin{lstlisting}
>>> timespan_inventory.all_are_contiguous
True
\end{lstlisting}
\begin{lstlisting}
>>> timespan_inventory.all_are_nonoverlapping
True
\end{lstlisting}
\end{singlespacing}
%%% ABJADBOOK END %%%

\subsection{Operations on timespan inventories} %%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%

Timespan inventory implement unioning, differencing and splitting methods which
parallel those implemented on timespans themselves. These methods
map the desired operation onto the contents of the inventory by, for example,
splitting every timespan contained in a given inventory by some offset. All of
these operations act in place. The intersection of all of the timespans in a
timespan inventory relative another timespan can be computed with the
\texttt{\&} operator, just like with single timespans:

\begin{comment}
<abjad>
timespan_inventory = timespantools.TimespanInventory([
    timespantools.Timespan(0, 16),
    timespantools.Timespan(5, 12),
    timespantools.Timespan(-2, 8),
    ])
show(timespan_inventory)
timespan_operand = timespantools.Timespan(6, 10)
result = timespan_inventory & timespan_operand
show(result, range_=(-2, 16))
</abjad>
\end{comment}

%%% ABJADBOOK START %%%
\begin{singlespacing}
\vspace{-0.5\baselineskip}
\begin{lstlisting}
>>> timespan_inventory = timespantools.TimespanInventory([
...     timespantools.Timespan(0, 16),
...     timespantools.Timespan(5, 12),
...     timespantools.Timespan(-2, 8),
...     ])
>>> show(timespan_inventory)
\end{lstlisting}
\noindent\includegraphics{assets/lilypond-cbd3cbca83a5656f43180e6511028af0.pdf}
\begin{lstlisting}
>>> timespan_operand = timespantools.Timespan(6, 10)
>>> result = timespan_inventory & timespan_operand
>>> show(result, range_=(-2, 16))
\end{lstlisting}
\noindent\includegraphics{assets/lilypond-a3c32e864752416833c66585a4f1413a.pdf}
\end{singlespacing}
%%% ABJADBOOK END %%%

\noindent Likewise, the offsets bound by a given timespan can be subtracted
from all of the timespans in a timespan inventory, effectively cutting a hole
in that inventory's timeline:

\begin{comment}
<abjad>
timespan_inventory = timespantools.TimespanInventory([
    timespantools.Timespan(0, 16),
    timespantools.Timespan(5, 12),
    timespantools.Timespan(-2, 8),
    ])
show(timespan_inventory)
timespan_operand = timespantools.Timespan(6, 10)
result = timespan_inventory - timespan_operand
show(result)
</abjad>
\end{comment}

%%% ABJADBOOK START %%%
\begin{singlespacing}
\vspace{-0.5\baselineskip}
\begin{lstlisting}
>>> timespan_inventory = timespantools.TimespanInventory([
...     timespantools.Timespan(0, 16),
...     timespantools.Timespan(5, 12),
...     timespantools.Timespan(-2, 8),
...     ])
>>> show(timespan_inventory)
\end{lstlisting}
\noindent\includegraphics{assets/lilypond-cbd3cbca83a5656f43180e6511028af0.pdf}
\begin{lstlisting}
>>> timespan_operand = timespantools.Timespan(6, 10)
>>> result = timespan_inventory - timespan_operand
>>> show(result)
\end{lstlisting}
\noindent\includegraphics{assets/lilypond-a0f158778c0f6c7689d964434632ff30.pdf}
\end{singlespacing}
%%% ABJADBOOK END %%%

\noindent As with a single timespan and an offset, an entire timespan inventory
can be split into two separate inventories via the \texttt{split\_at\_offset()}
method:

\begin{comment}
<abjad>
timespan_inventory = timespantools.TimespanInventory([
    timespantools.Timespan(0, 3),
    timespantools.Timespan(3, 6),
    timespantools.Timespan(6, 10),
    ])
show(timespan_inventory)
left, right = timespan_inventory.split_at_offset(4)
show(left, range_=(0, 10))
show(right, range_=(0, 10))
</abjad>
\end{comment}

%%% ABJADBOOK START %%%
\begin{singlespacing}
\vspace{-0.5\baselineskip}
\begin{lstlisting}
>>> timespan_inventory = timespantools.TimespanInventory([
...     timespantools.Timespan(0, 3),
...     timespantools.Timespan(3, 6),
...     timespantools.Timespan(6, 10),
...     ])
>>> show(timespan_inventory)
\end{lstlisting}
\noindent\includegraphics{assets/lilypond-100769e0b051f5de2aa3a3e8100c7d5d.pdf}
\begin{lstlisting}
>>> left, right = timespan_inventory.split_at_offset(4)
>>> show(left, range_=(0, 10))
\end{lstlisting}
\noindent\includegraphics{assets/lilypond-f358ba2b9306e731e9b69f6fc3a3e106.pdf}
\begin{lstlisting}
>>> show(right, range_=(0, 10))
\end{lstlisting}
\noindent\includegraphics{assets/lilypond-3567cf6646cc5ba40ce9e55b99682928.pdf}
\end{singlespacing}
%%% ABJADBOOK END %%%

\noindent The \texttt{TimespanInventory} class also provides the convenience
method \texttt{split\_at\_offsets()} for splitting an inventory by an arbitrary
number of offsets at once:

\begin{comment}
<abjad>
timespan_inventory = timespantools.TimespanInventory([
    timespantools.Timespan(0, 3),
    timespantools.Timespan(3, 6),
    timespantools.Timespan(6, 10),
    ])
show(timespan_inventory)
shards = timespan_inventory.split_at_offsets((2, 4, 7))
for shard in shards:
    show(shard, range_=(0, 10))

</abjad>
\end{comment}

%%% ABJADBOOK START %%%
\begin{singlespacing}
\vspace{-0.5\baselineskip}
\begin{lstlisting}
>>> timespan_inventory = timespantools.TimespanInventory([
...     timespantools.Timespan(0, 3),
...     timespantools.Timespan(3, 6),
...     timespantools.Timespan(6, 10),
...     ])
>>> show(timespan_inventory)
\end{lstlisting}
\noindent\includegraphics{assets/lilypond-100769e0b051f5de2aa3a3e8100c7d5d.pdf}
\begin{lstlisting}
>>> shards = timespan_inventory.split_at_offsets((2, 4, 7))
>>> for shard in shards:
...     show(shard, range_=(0, 10))
...
\end{lstlisting}
\noindent\includegraphics{assets/lilypond-f7b69c8dc6fba7368db0ea25a17c218e.pdf}\\
\noindent\includegraphics{assets/lilypond-3f4afb8ad19d35255735454103227441.pdf}\\
\noindent\includegraphics{assets/lilypond-6b963de07270b5bb2d1b81e144019430.pdf}\\
\noindent\includegraphics{assets/lilypond-39c01eb3f890b7ee91826b855f0bc1e1.pdf}
\end{singlespacing}
%%% ABJADBOOK END %%%

The mutating methods described above modify a timespan inventory
by mapping some procedure against its contents and some outside timespan or
offset. However, timespan inventories may also be modified by applying a
procedure solely against the contents of the inventory itself, mapping each
timespan in the collection against each other timespan in that collection.

For example, a timespan inventory can be modified by computing the logical
\texttt{OR} -- the set union -- of every timespan in the inventory relative
every other timespan, effectively fusing all overlapping timespans together:

\begin{comment}
<abjad>
timespan_inventory = timespantools.TimespanInventory([
    timespantools.Timespan(-2, 2),
    timespantools.Timespan(0, 10),
    timespantools.Timespan(5, 12),
    ])
show(timespan_inventory)
result = timespan_inventory.compute_logical_or()
print(format(result))
show(result)
</abjad>
\end{comment}

%%% ABJADBOOK START %%%
\begin{singlespacing}
\vspace{-0.5\baselineskip}
\begin{lstlisting}
>>> timespan_inventory = timespantools.TimespanInventory([
...     timespantools.Timespan(-2, 2),
...     timespantools.Timespan(0, 10),
...     timespantools.Timespan(5, 12),
...     ])
>>> show(timespan_inventory)
\end{lstlisting}
\noindent\includegraphics{assets/lilypond-9f5b5ced3211ef9a0f052881548540fb.pdf}
\begin{lstlisting}
>>> result = timespan_inventory.compute_logical_or()
>>> print(format(result))
timespantools.TimespanInventory(
    [
        timespantools.Timespan(
            start_offset=durationtools.Offset(-2, 1),
            stop_offset=durationtools.Offset(12, 1),
            ),
        ]
    )
\end{lstlisting}
\begin{lstlisting}
>>> show(result)
\end{lstlisting}
\noindent\includegraphics{assets/lilypond-008d70ca2e1404753a24ea2cad81359e.pdf}
\end{singlespacing}
%%% ABJADBOOK END %%%

\noindent A timespan inventory can also be modified by computing the logical
\texttt{AND} of every timespan in the inventory relative every other timespan.
This procedure leaves only those offsets where every single timespan
overlaps:

\begin{comment}
<abjad>
timespan_inventory = timespantools.TimespanInventory([
    timespantools.Timespan(-2, 8),
    timespantools.Timespan(0, 10),
    timespantools.Timespan(5, 12),
    ])
show(timespan_inventory)
result = timespan_inventory.compute_logical_and()
print(format(result))
show(result, range_=(-2, 12))
</abjad>
\end{comment}

%%% ABJADBOOK START %%%
\begin{singlespacing}
\vspace{-0.5\baselineskip}
\begin{lstlisting}
>>> timespan_inventory = timespantools.TimespanInventory([
...     timespantools.Timespan(-2, 8),
...     timespantools.Timespan(0, 10),
...     timespantools.Timespan(5, 12),
...     ])
>>> show(timespan_inventory)
\end{lstlisting}
\noindent\includegraphics{assets/lilypond-06292ff0f7245f849664f8e785a20d1e.pdf}
\begin{lstlisting}
>>> result = timespan_inventory.compute_logical_and()
>>> print(format(result))
timespantools.TimespanInventory(
    [
        timespantools.Timespan(
            start_offset=durationtools.Offset(5, 1),
            stop_offset=durationtools.Offset(8, 1),
            ),
        ]
    )
\end{lstlisting}
\begin{lstlisting}
>>> show(result, range_=(-2, 12))
\end{lstlisting}
\noindent\includegraphics{assets/lilypond-3112b4df401698e59129f95d93aea29b.pdf}
\end{singlespacing}
%%% ABJADBOOK END %%%

\noindent Lastly, computing the in-place logical \texttt{XOR} removes all
overlap from the timespan inventory, leaving only those offsets occupied by
only one timespan:

\begin{comment}
<abjad>
timespan_inventory = timespantools.TimespanInventory([
    timespantools.Timespan(-2, 2),
    timespantools.Timespan(0, 10),
    timespantools.Timespan(5, 12),
    ])
show(timespan_inventory)
result = timespan_inventory.compute_logical_xor()
print(format(result))
show(result, range_=(-2, 12))
</abjad>
\end{comment}

%%% ABJADBOOK START %%%
\begin{singlespacing}
\vspace{-0.5\baselineskip}
\begin{lstlisting}
>>> timespan_inventory = timespantools.TimespanInventory([
...     timespantools.Timespan(-2, 2),
...     timespantools.Timespan(0, 10),
...     timespantools.Timespan(5, 12),
...     ])
>>> show(timespan_inventory)
\end{lstlisting}
\noindent\includegraphics{assets/lilypond-9f5b5ced3211ef9a0f052881548540fb.pdf}
\begin{lstlisting}
>>> result = timespan_inventory.compute_logical_xor()
>>> print(format(result))
timespantools.TimespanInventory(
    [
        timespantools.Timespan(
            start_offset=durationtools.Offset(-2, 1),
            stop_offset=durationtools.Offset(0, 1),
            ),
        timespantools.Timespan(
            start_offset=durationtools.Offset(2, 1),
            stop_offset=durationtools.Offset(5, 1),
            ),
        timespantools.Timespan(
            start_offset=durationtools.Offset(10, 1),
            stop_offset=durationtools.Offset(12, 1),
            ),
        ]
    )
\end{lstlisting}
\begin{lstlisting}
>>> show(result, range_=(-2, 12))
\end{lstlisting}
\noindent\includegraphics{assets/lilypond-8d338eff91c4451288a8c4c678aa85e9.pdf}
\end{singlespacing}
%%% ABJADBOOK END %%%

Timespan partitioning separates a timespan inventory into groups of overlapping
and optionally tangent timespans, aggregated into new timespan inventories.
This procedure allows composers to isolate contiguous blocks of activity.

\begin{comment}
<abjad>
timespan_inventory = timespantools.TimespanInventory([
    timespantools.Timespan(0, 10),
    timespantools.Timespan(5, 15),
    timespantools.Timespan(15, 20),
    timespantools.Timespan(25, 30),
    ])
show(timespan_inventory)
for shard in timespan_inventory.partition():
    show(shard, range_=(0, 30))

for shard in timespan_inventory.partition(include_tangent_timespans=True):
    show(shard, range_=(0, 30))

</abjad>
\end{comment}

%%% ABJADBOOK START %%%
\begin{singlespacing}
\vspace{-0.5\baselineskip}
\begin{lstlisting}
>>> timespan_inventory = timespantools.TimespanInventory([
...     timespantools.Timespan(0, 10),
...     timespantools.Timespan(5, 15),
...     timespantools.Timespan(15, 20),
...     timespantools.Timespan(25, 30),
...     ])
>>> show(timespan_inventory)
\end{lstlisting}
\noindent\includegraphics{assets/lilypond-c512cb21503c082e03964f3390524269.pdf}
\begin{lstlisting}
>>> for shard in timespan_inventory.partition():
...     show(shard, range_=(0, 30))
...
\end{lstlisting}
\noindent\includegraphics{assets/lilypond-6db08ebb4475fff2bce45f46b03ecc6a.pdf}\\
\noindent\includegraphics{assets/lilypond-2beb1c2af46f19b84f1205821b2a3222.pdf}\\
\noindent\includegraphics{assets/lilypond-6b6bff0c030aebd141b40d59bde344e1.pdf}
\begin{lstlisting}
>>> for shard in timespan_inventory.partition(include_tangent_timespans=True):
...     show(shard, range_=(0, 30))
...
\end{lstlisting}
\noindent\includegraphics{assets/lilypond-6b11da605f1c2131d077db201b1ae7d0.pdf}\\
\noindent\includegraphics{assets/lilypond-6b6bff0c030aebd141b40d59bde344e1.pdf}
\end{singlespacing}
%%% ABJADBOOK END %%%

The procedures outlined above provide high-level tools for interacting with
large numbers of timespans at once. All of the techniques described in later
chapters with regards to Consort's score interpretation algorithm -- timespan
consolidation, cascading overlap resolution, multiplexing multiple inventories
into one, demultiplexing one inventory into many, and so forth -- build on and
extend these techniques.

\subsection{Optimized timespan inventories} %%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%

Consort provides its own timespan collection class -- the
\texttt{TimespanCollection}. This class stores timespans internally not as a
list, but in a balanced \emph{interval tree}\footnote{An interval tree is an
augmented self-balancing binary tree which stores both start offsets as well as
stop offsets.} datastructure which guarantees sorting and allows for highly
optimized lookups of timespans intersecting specific offsets. This class is
used at crucial points during Consort's interpretation stage simply for
purposes of speed, and should be considered an implementation detail. It
implements only a few methods, specifically for affording rapid search and
retrieval of timespans intersecting other timespans or offsets. With work, its
internal datastructure may eventually be merged into Abjad's own
\texttt{TimespanInventory} class.

%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
\section{Annotated timespans in Consort}
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%

While the above datastructures and operations are potentially very useful, a
larger question remains: how can composers create enough timespans, and in
various patterns, to be musically interesting? Consort approaches this problem
by providing a collection of factory classes -- \emph{timespan makers} -- which
can be configured and called to create arbitrarily large amounts of timespans.
However, before turning to a detailed discussion of timespan makers, we must
discuss the products of the timespan themselves: Consort's annotated timespan
subclasses.

Consort provides two separate timespan subclasses which are integral, if
transient, components of its score interpretation algorithm: the
\texttt{PerformedTimespan} and \texttt{SilentTimespan} classes. These classes
are never created \enquote{by hand} during Consort's specification stage --
this is, explicitly instantiated by a composer while specifying a score segment
--, but are instead generated as transitory objects during interpretation.
Consort uses \texttt{PerformedTimespan} objects to specify locations in the
score timeline where some active musical material should appear, while
\texttt{SilentTimespan} objects specify tacet passages.

As will be described in more detail in the following chapters, Consort requires
composers to specify musical materials in \emph{layers}, and to specify
specifically in which voices in the score -- vertically -- that material should
occur in. During the course of interpretation, Consort separates out generated
timespans by voice name and layer into separate timespan inventories, and then
progressively masks out timespans in timespan inventories with lower layer
numbers by timespans in timespan inventories with higher layer numbers. This
process is somewhat analogous to the use of opaque layers in image editing
software. Both the \texttt{PerformedTimespan} and \texttt{SilentTimespan}
classes provide configurable properties for layer and voice name, in addition
to the start offset and stop offset properties provided by their parent
\texttt{Timespan} class. These properties allow the processes that generate
them to record \emph{when} they were created, as well as \emph{where} the
should appear in the score, should they survive the masking process.

Silent timespans do not appear in the score, but can be created for a
particular layer and used to simply erase any timespan in a lower layer by
masking.

\begin{comment}
<abjad>
performed_timespan = consort.PerformedTimespan(
    layer=1,
    start_offset=(1, 2),
    stop_offset=(7, 8),
    voice_name='Clarinet Voice',
    )
silent_timespan = consort.SilentTimespan(
    layer=2,
    start_offset=Offset(0, 1),
    stop_offset=Offset(1, 4),
    voice_name='Oboe Voice',
    )
</abjad>
\end{comment}

%%% ABJADBOOK START %%%
\begin{singlespacing}
\vspace{-0.5\baselineskip}
\begin{lstlisting}
>>> performed_timespan = consort.PerformedTimespan(
...     layer=1,
...     start_offset=(1, 2),
...     stop_offset=(7, 8),
...     voice_name='Clarinet Voice',
...     )
>>> silent_timespan = consort.SilentTimespan(
...     layer=2,
...     start_offset=Offset(0, 1),
...     stop_offset=Offset(1, 4),
...     voice_name='Oboe Voice',
...     )
\end{lstlisting}
\end{singlespacing}
%%% ABJADBOOK END %%%

\begin{comment}
<abjad>
performed_timespan = consort.PerformedTimespan(
    layer=1,
    minimum_duration=Duration(1, 8),
    music_specifier=consort.MusicSpecifier(),
    start_offset=Offset(1, 4),
    stop_offset=Offset(2, 1),
    voice_name='Violin 1 LH Voice',
    )
</abjad>
\end{comment}

%%% ABJADBOOK START %%%
\begin{singlespacing}
\vspace{-0.5\baselineskip}
\begin{lstlisting}
>>> performed_timespan = consort.PerformedTimespan(
...     layer=1,
...     minimum_duration=Duration(1, 8),
...     music_specifier=consort.MusicSpecifier(),
...     start_offset=Offset(1, 4),
...     stop_offset=Offset(2, 1),
...     voice_name='Violin 1 LH Voice',
...     )
\end{lstlisting}
\end{singlespacing}
%%% ABJADBOOK END %%%

- forbid fusing

- forbid splitting

- minimum duration

- (additionally, music specifier: minimum phrase duration)

- divisions

- music

- music specifier

%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
\section{Timespan makers}
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%

- timespan specifier

- independent vs dependent

- target timespans

- talea

- padding

\subsection{FloodedTimespanMaker} %%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%

\begin{comment}
<abjad>
flooded_timespan_maker = consort.FloodedTimespanMaker()
print(format(flooded_timespan_maker))
</abjad>
\end{comment}

%%% ABJADBOOK START %%%
\begin{singlespacing}
\vspace{-0.5\baselineskip}
\begin{lstlisting}
>>> flooded_timespan_maker = consort.FloodedTimespanMaker()
>>> print(format(flooded_timespan_maker))
consort.tools.FloodedTimespanMaker()
\end{lstlisting}
\end{singlespacing}
%%% ABJADBOOK END %%%

\begin{comment}
<abjad>
music_specifiers = {'Violin Voice': 'violin music'}
target_timespan = timespantools.Timespan((1, 4), (11, 8))
timespan_inventory = flooded_timespan_maker(
    music_specifiers=music_specifiers,
    target_timespan=target_timespan,
    )
print(format(timespan_inventory))
</abjad>
\end{comment}

%%% ABJADBOOK START %%%
\begin{singlespacing}
\vspace{-0.5\baselineskip}
\begin{lstlisting}
>>> music_specifiers = {'Violin Voice': 'violin music'}
>>> target_timespan = timespantools.Timespan((1, 4), (11, 8))
>>> timespan_inventory = flooded_timespan_maker(
...     music_specifiers=music_specifiers,
...     target_timespan=target_timespan,
...     )
>>> print(format(timespan_inventory))
timespantools.TimespanInventory(
    [
        consort.tools.PerformedTimespan(
            start_offset=durationtools.Offset(1, 4),
            stop_offset=durationtools.Offset(11, 8),
            music_specifier='violin music',
            voice_name='Violin Voice',
            ),
        ]
    )
\end{lstlisting}
\end{singlespacing}
%%% ABJADBOOK END %%%

Adding a second music specifier entry and a layer keyword generates another
collection of timespans.

\begin{comment}
<abjad>
music_specifiers = {
    'Violin Voice': 'violin music',
    'Cello Voice': 'cello music',
    }
timespan_inventory = flooded_timespan_maker(
    layer=3,
    music_specifiers=music_specifiers,
    target_timespan=target_timespan,
    )
print(format(timespan_inventory))
show(timespan_inventory, key='voice_name')
</abjad>
\end{comment}

%%% ABJADBOOK START %%%
\begin{singlespacing}
\vspace{-0.5\baselineskip}
\begin{lstlisting}
>>> music_specifiers = {
...     'Violin Voice': 'violin music',
...     'Cello Voice': 'cello music',
...     }
>>> timespan_inventory = flooded_timespan_maker(
...     layer=3,
...     music_specifiers=music_specifiers,
...     target_timespan=target_timespan,
...     )
>>> print(format(timespan_inventory))
timespantools.TimespanInventory(
    [
        consort.tools.PerformedTimespan(
            start_offset=durationtools.Offset(1, 4),
            stop_offset=durationtools.Offset(11, 8),
            layer=3,
            music_specifier='cello music',
            voice_name='Cello Voice',
            ),
        consort.tools.PerformedTimespan(
            start_offset=durationtools.Offset(1, 4),
            stop_offset=durationtools.Offset(11, 8),
            layer=3,
            music_specifier='violin music',
            voice_name='Violin Voice',
            ),
        ]
    )
\end{lstlisting}
\begin{lstlisting}
>>> show(timespan_inventory, key='voice_name')
\end{lstlisting}
\noindent\includegraphics{assets/lilypond-24fe3b830cb2266c67ad664db69742ff.pdf}
\end{singlespacing}
%%% ABJADBOOK END %%%

A new flooded timespan maker, configured with padding and a timespan specifier
which will further configure each generated timespan.

\begin{comment}
<abjad>
flooded_timespan_maker = consort.FloodedTimespanMaker(
    padding=Duration(1, 4),
    timespan_specifier=consort.TimespanSpecifier(
        minimum_duration=Duration(1, 8),
        ),
    )
timespan_inventory = flooded_timespan_maker(
    layer=5,
    music_specifiers=music_specifiers,
    target_timespan=target_timespan,
    )
print(format(timespan_inventory))
show(timespan_inventory, key='voice_name')
</abjad>
\end{comment}

%%% ABJADBOOK START %%%
\begin{singlespacing}
\vspace{-0.5\baselineskip}
\begin{lstlisting}
>>> flooded_timespan_maker = consort.FloodedTimespanMaker(
...     padding=Duration(1, 4),
...     timespan_specifier=consort.TimespanSpecifier(
...         minimum_duration=Duration(1, 8),
...         ),
...     )
>>> timespan_inventory = flooded_timespan_maker(
...     layer=5,
...     music_specifiers=music_specifiers,
...     target_timespan=target_timespan,
...     )
>>> print(format(timespan_inventory))
timespantools.TimespanInventory(
    [
        consort.tools.SilentTimespan(
            start_offset=durationtools.Offset(0, 1),
            stop_offset=durationtools.Offset(1, 4),
            layer=5,
            voice_name='Violin Voice',
            ),
        consort.tools.SilentTimespan(
            start_offset=durationtools.Offset(0, 1),
            stop_offset=durationtools.Offset(1, 4),
            layer=5,
            voice_name='Cello Voice',
            ),
        consort.tools.PerformedTimespan(
            start_offset=durationtools.Offset(1, 4),
            stop_offset=durationtools.Offset(11, 8),
            layer=5,
            minimum_duration=durationtools.Duration(1, 8),
            music_specifier='cello music',
            voice_name='Cello Voice',
            ),
        consort.tools.PerformedTimespan(
            start_offset=durationtools.Offset(1, 4),
            stop_offset=durationtools.Offset(11, 8),
            layer=5,
            minimum_duration=durationtools.Duration(1, 8),
            music_specifier='violin music',
            voice_name='Violin Voice',
            ),
        consort.tools.SilentTimespan(
            start_offset=durationtools.Offset(11, 8),
            stop_offset=durationtools.Offset(13, 8),
            layer=5,
            voice_name='Violin Voice',
            ),
        consort.tools.SilentTimespan(
            start_offset=durationtools.Offset(11, 8),
            stop_offset=durationtools.Offset(13, 8),
            layer=5,
            voice_name='Cello Voice',
            ),
        ]
    )
\end{lstlisting}
\begin{lstlisting}
>>> show(timespan_inventory, key='voice_name')
\end{lstlisting}
\noindent\includegraphics{assets/lilypond-2d33a3f89ce475ea23b0afa80f5291ad.pdf}
\end{singlespacing}
%%% ABJADBOOK END %%%

\subsection{TaleaTimespanMaker} %%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%

\begin{comment}
<abjad>
talea_timespan_maker = consort.TaleaTimespanMaker()
print(format(talea_timespan_maker))
</abjad>
\end{comment}

%%% ABJADBOOK START %%%
\begin{singlespacing}
\vspace{-0.5\baselineskip}
\begin{lstlisting}
>>> talea_timespan_maker = consort.TaleaTimespanMaker()
>>> print(format(talea_timespan_maker))
consort.tools.TaleaTimespanMaker(
    playing_talea=rhythmmakertools.Talea(
        counts=(4,),
        denominator=16,
        ),
    playing_groupings=(1,),
    repeat=True,
    silence_talea=rhythmmakertools.Talea(
        counts=(4,),
        denominator=16,
        ),
    step_anchor=Right,
    synchronize_groupings=False,
    synchronize_step=False,
    )
\end{lstlisting}
\end{singlespacing}
%%% ABJADBOOK END %%%

\begin{comment}
<abjad>
import collections
music_specifiers = collections.OrderedDict([
    ('Voice 1', None),
    ('Voice 2', None),
    ('Voice 3', None),
    ('Voice 4', None),
    ])
target_timespan = timespantools.Timespan(0, (19, 4))
</abjad>
\end{comment}

%%% ABJADBOOK START %%%
\begin{singlespacing}
\vspace{-0.5\baselineskip}
\begin{lstlisting}
>>> import collections
>>> music_specifiers = collections.OrderedDict([
...     ('Voice 1', None),
...     ('Voice 2', None),
...     ('Voice 3', None),
...     ('Voice 4', None),
...     ])
>>> target_timespan = timespantools.Timespan(0, (19, 4))
\end{lstlisting}
\end{singlespacing}
%%% ABJADBOOK END %%%

\begin{comment}
<abjad>
result = talea_timespan_maker(
    music_specifiers=music_specifiers,
    target_timespan=target_timespan,
    )
show(result, key='voice_name')
</abjad>
\end{comment}

%%% ABJADBOOK START %%%
\begin{singlespacing}
\vspace{-0.5\baselineskip}
\begin{lstlisting}
>>> result = talea_timespan_maker(
...     music_specifiers=music_specifiers,
...     target_timespan=target_timespan,
...     )
>>> show(result, key='voice_name')
\end{lstlisting}
\noindent\includegraphics{assets/lilypond-e6387b7cc94dcc65e15cd96cc452ac89.pdf}
\end{singlespacing}
%%% ABJADBOOK END %%%

\begin{comment}
<abjad>
talea_timespan_maker = new(
    talea_timespan_maker,
    playing_talea=rhythmmakertools.Talea(
        counts=(1, 2, 3, 4),
        denominator=4,
        )
    )
result = talea_timespan_maker(
    music_specifiers=music_specifiers,
    target_timespan=target_timespan,
    )
show(result, key='voice_name')
</abjad>
\end{comment}

%%% ABJADBOOK START %%%
\begin{singlespacing}
\vspace{-0.5\baselineskip}
\begin{lstlisting}
>>> talea_timespan_maker = new(
...     talea_timespan_maker,
...     playing_talea=rhythmmakertools.Talea(
...         counts=(1, 2, 3, 4),
...         denominator=4,
...         )
...     )
>>> result = talea_timespan_maker(
...     music_specifiers=music_specifiers,
...     target_timespan=target_timespan,
...     )
>>> show(result, key='voice_name')
\end{lstlisting}
\noindent\includegraphics{assets/lilypond-5ebd9f6cea41f822af93bf205578e76d.pdf}
\end{singlespacing}
%%% ABJADBOOK END %%%

\begin{comment}
<abjad>
talea_timespan_maker = new(
    talea_timespan_maker,
    playing_groupings=(1, 2),
    )
result = talea_timespan_maker(
    music_specifiers=music_specifiers,
    target_timespan=target_timespan,
    )
show(result, key='voice_name')
</abjad>
\end{comment}

%%% ABJADBOOK START %%%
\begin{singlespacing}
\vspace{-0.5\baselineskip}
\begin{lstlisting}
>>> talea_timespan_maker = new(
...     talea_timespan_maker,
...     playing_groupings=(1, 2),
...     )
>>> result = talea_timespan_maker(
...     music_specifiers=music_specifiers,
...     target_timespan=target_timespan,
...     )
>>> show(result, key='voice_name')
\end{lstlisting}
\noindent\includegraphics{assets/lilypond-5f68b5dc547494c06b2a9e8cadfffab6.pdf}
\end{singlespacing}
%%% ABJADBOOK END %%%

\begin{comment}
<abjad>
talea_timespan_maker = new(
    talea_timespan_maker,
    silence_talea=rhythmmakertools.Talea(
        counts=(3, 1, 1),
        denominator=8,
        ),
    )
result = talea_timespan_maker(
    music_specifiers=music_specifiers,
    target_timespan=target_timespan,
    )
show(result, key='voice_name')
</abjad>
\end{comment}

%%% ABJADBOOK START %%%
\begin{singlespacing}
\vspace{-0.5\baselineskip}
\begin{lstlisting}
>>> talea_timespan_maker = new(
...     talea_timespan_maker,
...     silence_talea=rhythmmakertools.Talea(
...         counts=(3, 1, 1),
...         denominator=8,
...         ),
...     )
>>> result = talea_timespan_maker(
...     music_specifiers=music_specifiers,
...     target_timespan=target_timespan,
...     )
>>> show(result, key='voice_name')
\end{lstlisting}
\noindent\includegraphics{assets/lilypond-05d6eaa176890b95761429277d12a451.pdf}
\end{singlespacing}
%%% ABJADBOOK END %%%

\begin{comment}
<abjad>
talea_timespan_maker = new(
    talea_timespan_maker,
    initial_silence_talea=rhythmmakertools.Talea(
        counts=(0, 1, 3),
        denominator=8,
        ),
    )
result = talea_timespan_maker(
    music_specifiers=music_specifiers,
    target_timespan=target_timespan,
    )
show(result, key='voice_name')
</abjad>
\end{comment}

%%% ABJADBOOK START %%%
\begin{singlespacing}
\vspace{-0.5\baselineskip}
\begin{lstlisting}
>>> talea_timespan_maker = new(
...     talea_timespan_maker,
...     initial_silence_talea=rhythmmakertools.Talea(
...         counts=(0, 1, 3),
...         denominator=8,
...         ),
...     )
>>> result = talea_timespan_maker(
...     music_specifiers=music_specifiers,
...     target_timespan=target_timespan,
...     )
>>> show(result, key='voice_name')
\end{lstlisting}
\noindent\includegraphics{assets/lilypond-bf1ae65e6c27a19def5d2af95bc96146.pdf}
\end{singlespacing}
%%% ABJADBOOK END %%%

\begin{comment}
<abjad>
talea_timespan_maker = new(
    talea_timespan_maker,
    reflect=True,
    )
result = talea_timespan_maker(
    music_specifiers=music_specifiers,
    target_timespan=target_timespan,
    )
show(result, key='voice_name')
</abjad>
\end{comment}

%%% ABJADBOOK START %%%
\begin{singlespacing}
\vspace{-0.5\baselineskip}
\begin{lstlisting}
>>> talea_timespan_maker = new(
...     talea_timespan_maker,
...     reflect=True,
...     )
>>> result = talea_timespan_maker(
...     music_specifiers=music_specifiers,
...     target_timespan=target_timespan,
...     )
>>> show(result, key='voice_name')
\end{lstlisting}
\noindent\includegraphics{assets/lilypond-a056ab693faf200c126ed5415e3dfcc5.pdf}
\end{singlespacing}
%%% ABJADBOOK END %%%

\begin{comment}
<abjad>
synchronized_talea_timespan_maker = consort.TaleaTimespanMaker(
    playing_talea=rhythmmakertools.Talea(
        counts=(1, 2, 3, 4, 5),
        denominator=8,
        ),
    silence_talea=rhythmmakertools.Talea(
        counts=(4, 7),
        denominator=8,
        ),
    synchronize_step=True,
    )
result = synchronized_talea_timespan_maker(
    music_specifiers=music_specifiers,
    target_timespan=target_timespan,
    )
show(result, key='voice_name')
</abjad>
\end{comment}

%%% ABJADBOOK START %%%
\begin{singlespacing}
\vspace{-0.5\baselineskip}
\begin{lstlisting}
>>> synchronized_talea_timespan_maker = consort.TaleaTimespanMaker(
...     playing_talea=rhythmmakertools.Talea(
...         counts=(1, 2, 3, 4, 5),
...         denominator=8,
...         ),
...     silence_talea=rhythmmakertools.Talea(
...         counts=(4, 7),
...         denominator=8,
...         ),
...     synchronize_step=True,
...     )
>>> result = synchronized_talea_timespan_maker(
...     music_specifiers=music_specifiers,
...     target_timespan=target_timespan,
...     )
>>> show(result, key='voice_name')
\end{lstlisting}
\noindent\includegraphics{assets/lilypond-31462885c4eaad77a93063030e868250.pdf}
\end{singlespacing}
%%% ABJADBOOK END %%%

\begin{comment}
<abjad>
synchronized_talea_timespan_maker = new(
    synchronized_talea_timespan_maker,
    initial_silence_talea=rhythmmakertools.Talea(
        counts=(0, 1, 2),
        denominator=8,
        ),
    padding=Duration(1, 8),
    )
result = synchronized_talea_timespan_maker(
    music_specifiers=music_specifiers,
    target_timespan=target_timespan,
    )
show(result, key='voice_name')
</abjad>
\end{comment}

%%% ABJADBOOK START %%%
\begin{singlespacing}
\vspace{-0.5\baselineskip}
\begin{lstlisting}
>>> synchronized_talea_timespan_maker = new(
...     synchronized_talea_timespan_maker,
...     initial_silence_talea=rhythmmakertools.Talea(
...         counts=(0, 1, 2),
...         denominator=8,
...         ),
...     padding=Duration(1, 8),
...     )
>>> result = synchronized_talea_timespan_maker(
...     music_specifiers=music_specifiers,
...     target_timespan=target_timespan,
...     )
>>> show(result, key='voice_name')
\end{lstlisting}
\noindent\includegraphics{assets/lilypond-c3f20c8c695d4fa106c7fb3ef748bcc3.pdf}
\end{singlespacing}
%%% ABJADBOOK END %%%


\subsection{DependentTimespanMaker} %%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%

\begin{comment}
<abjad>
timespan_inventory = timespantools.TimespanInventory([
    consort.PerformedTimespan(0, 10, voice_name='Voice 1'),
    consort.PerformedTimespan(10, 20, voice_name='Voice 1'),
    consort.PerformedTimespan(25, 30, voice_name='Voice 1'),
    consort.PerformedTimespan(50, 60, voice_name='Voice 1'),
    consort.PerformedTimespan(0, 10, voice_name='Voice 2'),
    consort.PerformedTimespan(15, 35, voice_name='Voice 2'),
    consort.PerformedTimespan(40, 45, voice_name='Voice 2'),
    consort.PerformedTimespan(45, 75, voice_name='Voice 2'),
    ])
show(timespan_inventory, key='voice_name')
</abjad>
\end{comment}

%%% ABJADBOOK START %%%
\begin{singlespacing}
\vspace{-0.5\baselineskip}
\begin{lstlisting}
>>> timespan_inventory = timespantools.TimespanInventory([
...     consort.PerformedTimespan(0, 10, voice_name='Voice 1'),
...     consort.PerformedTimespan(10, 20, voice_name='Voice 1'),
...     consort.PerformedTimespan(25, 30, voice_name='Voice 1'),
...     consort.PerformedTimespan(50, 60, voice_name='Voice 1'),
...     consort.PerformedTimespan(0, 10, voice_name='Voice 2'),
...     consort.PerformedTimespan(15, 35, voice_name='Voice 2'),
...     consort.PerformedTimespan(40, 45, voice_name='Voice 2'),
...     consort.PerformedTimespan(45, 75, voice_name='Voice 2'),
...     ])
>>> show(timespan_inventory, key='voice_name')
\end{lstlisting}
\noindent\includegraphics{assets/lilypond-13296a148810e7ce3ea272fe0810333d.pdf}
\end{singlespacing}
%%% ABJADBOOK END %%%

\begin{comment}
<abjad>
music_specifiers = {'Voice 3': None}
dependent_timespan_maker = consort.DependentTimespanMaker(
    voice_names=(
        'Voice 1',
        'Voice 2',
        )
    )
result = dependent_timespan_maker(
    music_specifiers=music_specifiers,
    timespan_inventory=new(timespan_inventory),
    )
show(result, key='voice_name')
</abjad>
\end{comment}

%%% ABJADBOOK START %%%
\begin{singlespacing}
\vspace{-0.5\baselineskip}
\begin{lstlisting}
>>> music_specifiers = {'Voice 3': None}
>>> dependent_timespan_maker = consort.DependentTimespanMaker(
...     voice_names=(
...         'Voice 1',
...         'Voice 2',
...         )
...     )
>>> result = dependent_timespan_maker(
...     music_specifiers=music_specifiers,
...     timespan_inventory=new(timespan_inventory),
...     )
>>> show(result, key='voice_name')
\end{lstlisting}
\noindent\includegraphics{assets/lilypond-b8679d8c67bdc488c9bf7b253ee50093.pdf}
\end{singlespacing}
%%% ABJADBOOK END %%%

\begin{comment}
<abjad>
new_dependent_timespan_maker = new(
    dependent_timespan_maker,
    include_inner_starts=True,
    )
result = new_dependent_timespan_maker(
    music_specifiers=music_specifiers,
    timespan_inventory=new(timespan_inventory),
    )
show(result, key='voice_name')
</abjad>
\end{comment}

%%% ABJADBOOK START %%%
\begin{singlespacing}
\vspace{-0.5\baselineskip}
\begin{lstlisting}
>>> new_dependent_timespan_maker = new(
...     dependent_timespan_maker,
...     include_inner_starts=True,
...     )
>>> result = new_dependent_timespan_maker(
...     music_specifiers=music_specifiers,
...     timespan_inventory=new(timespan_inventory),
...     )
>>> show(result, key='voice_name')
\end{lstlisting}
\noindent\includegraphics{assets/lilypond-5e86cbbefe8caab1614b6a926c5fd9a0.pdf}
\end{singlespacing}
%%% ABJADBOOK END %%%

\begin{comment}
<abjad>
new_dependent_timespan_maker = new(
    dependent_timespan_maker,
    include_inner_stops=True,
    )
result = new_dependent_timespan_maker(
    music_specifiers=music_specifiers,
    timespan_inventory=new(timespan_inventory),
    )
show(result, key='voice_name')
</abjad>
\end{comment}

%%% ABJADBOOK START %%%
\begin{singlespacing}
\vspace{-0.5\baselineskip}
\begin{lstlisting}
>>> new_dependent_timespan_maker = new(
...     dependent_timespan_maker,
...     include_inner_stops=True,
...     )
>>> result = new_dependent_timespan_maker(
...     music_specifiers=music_specifiers,
...     timespan_inventory=new(timespan_inventory),
...     )
>>> show(result, key='voice_name')
\end{lstlisting}
\noindent\includegraphics{assets/lilypond-e087e1676265cbf9fe8d0de0c94af3df.pdf}
\end{singlespacing}
%%% ABJADBOOK END %%%

\begin{comment}
<abjad>
new_dependent_timespan_maker = new(
    dependent_timespan_maker,
    include_inner_starts=True,
    include_inner_stops=True,
    )
result = new_dependent_timespan_maker(
    music_specifiers=music_specifiers,
    timespan_inventory=new(timespan_inventory),
    )
show(result, key='voice_name')
</abjad>
\end{comment}

%%% ABJADBOOK START %%%
\begin{singlespacing}
\vspace{-0.5\baselineskip}
\begin{lstlisting}
>>> new_dependent_timespan_maker = new(
...     dependent_timespan_maker,
...     include_inner_starts=True,
...     include_inner_stops=True,
...     )
>>> result = new_dependent_timespan_maker(
...     music_specifiers=music_specifiers,
...     timespan_inventory=new(timespan_inventory),
...     )
>>> show(result, key='voice_name')
\end{lstlisting}
\noindent\includegraphics{assets/lilypond-083029aa8e7c7aac730d786816a9d7e7.pdf}
\end{singlespacing}
%%% ABJADBOOK END %%%

\begin{comment}
<abjad>
result = new_dependent_timespan_maker(
    music_specifiers=music_specifiers,
    target_timespan=timespantools.Timespan(17, 58),
    timespan_inventory=new(timespan_inventory),
    )
show(result, key='voice_name', range_=(0, 75))
</abjad>
\end{comment}

%%% ABJADBOOK START %%%
\begin{singlespacing}
\vspace{-0.5\baselineskip}
\begin{lstlisting}
>>> result = new_dependent_timespan_maker(
...     music_specifiers=music_specifiers,
...     target_timespan=timespantools.Timespan(17, 58),
...     timespan_inventory=new(timespan_inventory),
...     )
>>> show(result, key='voice_name', range_=(0, 75))
\end{lstlisting}
\noindent\includegraphics{assets/lilypond-0bf90f96e79184e7e174ab1d49f12f63.pdf}
\end{singlespacing}
%%% ABJADBOOK END %%%

\begin{comment}
<abjad>
rotated_dependent_timespan_maker = new(
    new_dependent_timespan_maker,
    rotation_indices=(1,),
    )
result = rotated_dependent_timespan_maker(
    music_specifiers=music_specifiers,
    timespan_inventory=new(timespan_inventory),
    )
show(result, key='voice_name', range_=(0, 75))
</abjad>
\end{comment}

%%% ABJADBOOK START %%%
\begin{singlespacing}
\vspace{-0.5\baselineskip}
\begin{lstlisting}
>>> rotated_dependent_timespan_maker = new(
...     new_dependent_timespan_maker,
...     rotation_indices=(1,),
...     )
>>> result = rotated_dependent_timespan_maker(
...     music_specifiers=music_specifiers,
...     timespan_inventory=new(timespan_inventory),
...     )
>>> show(result, key='voice_name', range_=(0, 75))
\end{lstlisting}
\noindent\includegraphics{assets/lilypond-905860797ad3079959b162674b8ef9e6.pdf}
\end{singlespacing}
%%% ABJADBOOK END %%%

\begin{comment}
<abjad>
rotated_dependent_timespan_maker = new(
    new_dependent_timespan_maker,
    rotation_indices=(1, -1),
    )
result = rotated_dependent_timespan_maker(
    music_specifiers=music_specifiers,
    timespan_inventory=new(timespan_inventory),
    )
show(result, key='voice_name', range_=(0, 75))
</abjad>
\end{comment}

%%% ABJADBOOK START %%%
\begin{singlespacing}
\vspace{-0.5\baselineskip}
\begin{lstlisting}
>>> rotated_dependent_timespan_maker = new(
...     new_dependent_timespan_maker,
...     rotation_indices=(1, -1),
...     )
>>> result = rotated_dependent_timespan_maker(
...     music_specifiers=music_specifiers,
...     timespan_inventory=new(timespan_inventory),
...     )
>>> show(result, key='voice_name', range_=(0, 75))
\end{lstlisting}
\noindent\includegraphics{assets/lilypond-1dddd844f55df74835c9c91d65b4b541.pdf}
\end{singlespacing}
%%% ABJADBOOK END %%%

%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
\section{Rhythm makers}
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%

- divisions

\begin{comment}
<abjad>
divisions = [(3, 8), (4, 8), (3, 16), (4, 16), (5, 8), (2, 4)]
</abjad>
\end{comment}

%%% ABJADBOOK START %%%
\begin{singlespacing}
\vspace{-0.5\baselineskip}
\begin{lstlisting}
>>> divisions = [(3, 8), (4, 8), (3, 16), (4, 16), (5, 8), (2, 4)]
\end{lstlisting}
\end{singlespacing}
%%% ABJADBOOK END %%%

- rhythm maker

\begin{comment}
<abjad>
note_rhythm_maker = rhythmmakertools.NoteRhythmMaker()
show(note_rhythm_maker, divisions=divisions)
</abjad>
\end{comment}

%%% ABJADBOOK START %%%
\begin{singlespacing}
\vspace{-0.5\baselineskip}
\begin{lstlisting}
>>> note_rhythm_maker = rhythmmakertools.NoteRhythmMaker()
>>> show(note_rhythm_maker, divisions=divisions)
\end{lstlisting}
\noindent\includegraphics{assets/lilypond-d0f66021e4860194d32ee0fa226ed174.pdf}
\end{singlespacing}
%%% ABJADBOOK END %%%

\begin{comment}
<abjad>
note_rhythm_maker = new(
    note_rhythm_maker,
    tie_specifier=rhythmmakertools.TieSpecifier(
        tie_across_divisions=True,
        ),
    )
show(note_rhythm_maker, divisions=divisions)
</abjad>
\end{comment}

%%% ABJADBOOK START %%%
\begin{singlespacing}
\vspace{-0.5\baselineskip}
\begin{lstlisting}
>>> note_rhythm_maker = new(
...     note_rhythm_maker,
...     tie_specifier=rhythmmakertools.TieSpecifier(
...         tie_across_divisions=True,
...         ),
...     )
>>> show(note_rhythm_maker, divisions=divisions)
\end{lstlisting}
\noindent\includegraphics{assets/lilypond-1c2192761535f741178fd5fc2ed22ed7.pdf}
\end{singlespacing}
%%% ABJADBOOK END %%%

\begin{comment}
<abjad>
note_rhythm_maker = rhythmmakertools.NoteRhythmMaker(
    output_masks=[
        rhythmmakertools.BooleanPattern(
            indices=[0],
            period=2,
            ),
        ],
    )
show(note_rhythm_maker, divisions=divisions)
</abjad>
\end{comment}

%%% ABJADBOOK START %%%
\begin{singlespacing}
\vspace{-0.5\baselineskip}
\begin{lstlisting}
>>> note_rhythm_maker = rhythmmakertools.NoteRhythmMaker(
...     output_masks=[
...         rhythmmakertools.BooleanPattern(
...             indices=[0],
...             period=2,
...             ),
...         ],
...     )
>>> show(note_rhythm_maker, divisions=divisions)
\end{lstlisting}
\noindent\includegraphics{assets/lilypond-fb60261fce39a6a8bed29c6bc1a39b14.pdf}
\end{singlespacing}
%%% ABJADBOOK END %%%

\begin{comment}
<abjad>
note_rhythm_maker = rhythmmakertools.NoteRhythmMaker(
    output_masks=[
        rhythmmakertools.BooleanPattern(
            indices=[0],
            period=1,
            ),
        ],
    )
show(note_rhythm_maker, divisions=divisions)
</abjad>
\end{comment}

%%% ABJADBOOK START %%%
\begin{singlespacing}
\vspace{-0.5\baselineskip}
\begin{lstlisting}
>>> note_rhythm_maker = rhythmmakertools.NoteRhythmMaker(
...     output_masks=[
...         rhythmmakertools.BooleanPattern(
...             indices=[0],
...             period=1,
...             ),
...         ],
...     )
>>> show(note_rhythm_maker, divisions=divisions)
\end{lstlisting}
\noindent\includegraphics{assets/lilypond-b8d4d2abe1d0cabd1dba685a0e5a2bcc.pdf}
\end{singlespacing}
%%% ABJADBOOK END %%%

\begin{comment}
<abjad>
incised_rhythm_maker = rhythmmakertools.IncisedRhythmMaker(
    incise_specifier=rhythmmakertools.InciseSpecifier(
        suffix_talea=[-1],
        suffix_counts=[1],
        talea_denominator=16,
        ),
    )
show(incised_rhythm_maker, divisions=divisions)
</abjad>
\end{comment}

%%% ABJADBOOK START %%%
\begin{singlespacing}
\vspace{-0.5\baselineskip}
\begin{lstlisting}
>>> incised_rhythm_maker = rhythmmakertools.IncisedRhythmMaker(
...     incise_specifier=rhythmmakertools.InciseSpecifier(
...         suffix_talea=[-1],
...         suffix_counts=[1],
...         talea_denominator=16,
...         ),
...     )
>>> show(incised_rhythm_maker, divisions=divisions)
\end{lstlisting}
\noindent\includegraphics{assets/lilypond-f21215b14c3e76d687060a020bdca52a.pdf}
\end{singlespacing}
%%% ABJADBOOK END %%%

\begin{comment}
<abjad>
incised_rhythm_maker = rhythmmakertools.IncisedRhythmMaker(
    incise_specifier=rhythmmakertools.InciseSpecifier(
        fill_with_notes=False,
        prefix_counts=[2, 1],
        prefix_talea=[1],
        talea_denominator=16,
        ),
    )
show(incised_rhythm_maker, divisions=divisions)
</abjad>
\end{comment}

%%% ABJADBOOK START %%%
\begin{singlespacing}
\vspace{-0.5\baselineskip}
\begin{lstlisting}
>>> incised_rhythm_maker = rhythmmakertools.IncisedRhythmMaker(
...     incise_specifier=rhythmmakertools.InciseSpecifier(
...         fill_with_notes=False,
...         prefix_counts=[2, 1],
...         prefix_talea=[1],
...         talea_denominator=16,
...         ),
...     )
>>> show(incised_rhythm_maker, divisions=divisions)
\end{lstlisting}
\noindent\includegraphics{assets/lilypond-d22f16b98a9a0b7dc379c37be145f71f.pdf}
\end{singlespacing}
%%% ABJADBOOK END %%%

\begin{comment}
<abjad>
incised_rhythm_maker = rhythmmakertools.IncisedRhythmMaker(
    incise_specifier=rhythmmakertools.InciseSpecifier(
        outer_divisions_only=True,
        prefix_counts=[1],
        prefix_talea=[-1],
        suffix_counts=[1],
        suffix_talea=[-1],
        talea_denominator=8,
        ),
    )
show(incised_rhythm_maker, divisions=divisions)
</abjad>
\end{comment}

%%% ABJADBOOK START %%%
\begin{singlespacing}
\vspace{-0.5\baselineskip}
\begin{lstlisting}
>>> incised_rhythm_maker = rhythmmakertools.IncisedRhythmMaker(
...     incise_specifier=rhythmmakertools.InciseSpecifier(
...         outer_divisions_only=True,
...         prefix_counts=[1],
...         prefix_talea=[-1],
...         suffix_counts=[1],
...         suffix_talea=[-1],
...         talea_denominator=8,
...         ),
...     )
>>> show(incised_rhythm_maker, divisions=divisions)
\end{lstlisting}
\noindent\includegraphics{assets/lilypond-8245f754d4c0b647786ba2c3e22988f3.pdf}
\end{singlespacing}
%%% ABJADBOOK END %%%

\begin{comment}
<abjad>
incised_rhythm_maker = new(
    incised_rhythm_maker,
    tie_specifier=rhythmmakertools.TieSpecifier(
        tie_across_divisions=True,
        ),
    )
show(incised_rhythm_maker, divisions=divisions)
</abjad>
\end{comment}

%%% ABJADBOOK START %%%
\begin{singlespacing}
\vspace{-0.5\baselineskip}
\begin{lstlisting}
>>> incised_rhythm_maker = new(
...     incised_rhythm_maker,
...     tie_specifier=rhythmmakertools.TieSpecifier(
...         tie_across_divisions=True,
...         ),
...     )
>>> show(incised_rhythm_maker, divisions=divisions)
\end{lstlisting}
\noindent\includegraphics{assets/lilypond-9890ffbc1115862a9479f6a97bf677e3.pdf}
\end{singlespacing}
%%% ABJADBOOK END %%%

\begin{comment}
<abjad>
even_division_rhythm_maker = rhythmmakertools.EvenDivisionRhythmMaker()
show(even_division_rhythm_maker, divisions=divisions)
</abjad>
\end{comment}

%%% ABJADBOOK START %%%
\begin{singlespacing}
\vspace{-0.5\baselineskip}
\begin{lstlisting}
>>> even_division_rhythm_maker = rhythmmakertools.EvenDivisionRhythmMaker()
>>> show(even_division_rhythm_maker, divisions=divisions)
\end{lstlisting}
\noindent\includegraphics{assets/lilypond-2bcea48859d1e8378a750341c3315103.pdf}
\end{singlespacing}
%%% ABJADBOOK END %%%

\begin{comment}
<abjad>
even_division_rhythm_maker = new(
    even_division_rhythm_maker,
    denominators=[8, 16],
    )
show(even_division_rhythm_maker, divisions=divisions)
</abjad>
\end{comment}

%%% ABJADBOOK START %%%
\begin{singlespacing}
\vspace{-0.5\baselineskip}
\begin{lstlisting}
>>> even_division_rhythm_maker = new(
...     even_division_rhythm_maker,
...     denominators=[8, 16],
...     )
>>> show(even_division_rhythm_maker, divisions=divisions)
\end{lstlisting}
\noindent\includegraphics{assets/lilypond-042a232c8ba3c9adb624c404980efe18.pdf}
\end{singlespacing}
%%% ABJADBOOK END %%%

\begin{comment}
<abjad>
even_division_rhythm_maker = new(
    even_division_rhythm_maker,
    denominators=[8, 4, 16],
    )
show(even_division_rhythm_maker, divisions=divisions)
</abjad>
\end{comment}

%%% ABJADBOOK START %%%
\begin{singlespacing}
\vspace{-0.5\baselineskip}
\begin{lstlisting}
>>> even_division_rhythm_maker = new(
...     even_division_rhythm_maker,
...     denominators=[8, 4, 16],
...     )
>>> show(even_division_rhythm_maker, divisions=divisions)
\end{lstlisting}
\noindent\includegraphics{assets/lilypond-18b3464ab66c7d829de5417e6e668687.pdf}
\end{singlespacing}
%%% ABJADBOOK END %%%

\begin{comment}
<abjad>
even_division_rhythm_maker = new(
    even_division_rhythm_maker,
    denominators=[8],
    extra_counts_per_division=(0, 1),
    )
show(even_division_rhythm_maker, divisions=divisions)
</abjad>
\end{comment}

%%% ABJADBOOK START %%%
\begin{singlespacing}
\vspace{-0.5\baselineskip}
\begin{lstlisting}
>>> even_division_rhythm_maker = new(
...     even_division_rhythm_maker,
...     denominators=[8],
...     extra_counts_per_division=(0, 1),
...     )
>>> show(even_division_rhythm_maker, divisions=divisions)
\end{lstlisting}
\noindent\includegraphics{assets/lilypond-7bd6867c75e18e48ebf2c898a35a53b9.pdf}
\end{singlespacing}
%%% ABJADBOOK END %%%

\begin{comment}
<abjad>
even_division_rhythm_maker = new(
    even_division_rhythm_maker,
    tie_specifier=rhythmmakertools.TieSpecifier(
        tie_across_divisions=True,
        ),
    )
show(even_division_rhythm_maker, divisions=divisions)
</abjad>
\end{comment}

%%% ABJADBOOK START %%%
\begin{singlespacing}
\vspace{-0.5\baselineskip}
\begin{lstlisting}
>>> even_division_rhythm_maker = new(
...     even_division_rhythm_maker,
...     tie_specifier=rhythmmakertools.TieSpecifier(
...         tie_across_divisions=True,
...         ),
...     )
>>> show(even_division_rhythm_maker, divisions=divisions)
\end{lstlisting}
\noindent\includegraphics{assets/lilypond-4cc7ba58b448cb7add8a0024b1e90f9b.pdf}
\end{singlespacing}
%%% ABJADBOOK END %%%

\begin{comment}
<abjad>
even_division_rhythm_maker = new(
    even_division_rhythm_maker,
    denominators=[8, 4, 16],
    )
show(even_division_rhythm_maker, divisions=divisions)
</abjad>
\end{comment}

%%% ABJADBOOK START %%%
\begin{singlespacing}
\vspace{-0.5\baselineskip}
\begin{lstlisting}
>>> even_division_rhythm_maker = new(
...     even_division_rhythm_maker,
...     denominators=[8, 4, 16],
...     )
>>> show(even_division_rhythm_maker, divisions=divisions)
\end{lstlisting}
\noindent\includegraphics{assets/lilypond-af43995b8651db6fd08d7d3e42ff809b.pdf}
\end{singlespacing}
%%% ABJADBOOK END %%%

\begin{comment}
<abjad>
talea_rhythm_maker = rhythmmakertools.TaleaRhythmMaker(
    talea=rhythmmakertools.Talea(
        counts=[1],
        denominator=16,
        ),
    )
show(talea_rhythm_maker, divisions=divisions)
</abjad>
\end{comment}

%%% ABJADBOOK START %%%
\begin{singlespacing}
\vspace{-0.5\baselineskip}
\begin{lstlisting}
>>> talea_rhythm_maker = rhythmmakertools.TaleaRhythmMaker(
...     talea=rhythmmakertools.Talea(
...         counts=[1],
...         denominator=16,
...         ),
...     )
>>> show(talea_rhythm_maker, divisions=divisions)
\end{lstlisting}
\noindent\includegraphics{assets/lilypond-a8d7d6245553b2c4f5d2e404e62ae27b.pdf}
\end{singlespacing}
%%% ABJADBOOK END %%%

\begin{comment}
<abjad>
talea_rhythm_maker = new(
    talea_rhythm_maker,
    talea__counts=[1, 2],
    )
show(talea_rhythm_maker, divisions=divisions)
</abjad>
\end{comment}

%%% ABJADBOOK START %%%
\begin{singlespacing}
\vspace{-0.5\baselineskip}
\begin{lstlisting}
>>> talea_rhythm_maker = new(
...     talea_rhythm_maker,
...     talea__counts=[1, 2],
...     )
>>> show(talea_rhythm_maker, divisions=divisions)
\end{lstlisting}
\noindent\includegraphics{assets/lilypond-a91e80c7459af113e517ef98d44608db.pdf}
\end{singlespacing}
%%% ABJADBOOK END %%%

\begin{comment}
<abjad>
talea_rhythm_maker = new(
    talea_rhythm_maker,
    talea__counts=[1, 2, 3, 4],
    )
show(talea_rhythm_maker, divisions=divisions)
</abjad>
\end{comment}

%%% ABJADBOOK START %%%
\begin{singlespacing}
\vspace{-0.5\baselineskip}
\begin{lstlisting}
>>> talea_rhythm_maker = new(
...     talea_rhythm_maker,
...     talea__counts=[1, 2, 3, 4],
...     )
>>> show(talea_rhythm_maker, divisions=divisions)
\end{lstlisting}
\noindent\includegraphics{assets/lilypond-101e0079ec09025cbd79b4f02fb37c60.pdf}
\end{singlespacing}
%%% ABJADBOOK END %%%

\begin{comment}
<abjad>
talea_rhythm_maker = new(
    talea_rhythm_maker,
    extra_counts_per_division=[0, 1, 1],
    )
show(talea_rhythm_maker, divisions=divisions)
</abjad>
\end{comment}

%%% ABJADBOOK START %%%
\begin{singlespacing}
\vspace{-0.5\baselineskip}
\begin{lstlisting}
>>> talea_rhythm_maker = new(
...     talea_rhythm_maker,
...     extra_counts_per_division=[0, 1, 1],
...     )
>>> show(talea_rhythm_maker, divisions=divisions)
\end{lstlisting}
\noindent\includegraphics{assets/lilypond-02eb5487975f8445cefb4b61deef34ff.pdf}
\end{singlespacing}
%%% ABJADBOOK END %%%

\begin{comment}
<abjad>
talea_rhythm_maker = new(
    talea_rhythm_maker,
    tie_specifier=rhythmmakertools.TieSpecifier(
        tie_across_divisions=True,
        ),
    )
show(talea_rhythm_maker, divisions=divisions)
</abjad>
\end{comment}

%%% ABJADBOOK START %%%
\begin{singlespacing}
\vspace{-0.5\baselineskip}
\begin{lstlisting}
>>> talea_rhythm_maker = new(
...     talea_rhythm_maker,
...     tie_specifier=rhythmmakertools.TieSpecifier(
...         tie_across_divisions=True,
...         ),
...     )
>>> show(talea_rhythm_maker, divisions=divisions)
\end{lstlisting}
\noindent\includegraphics{assets/lilypond-98638e7bc3f5e68f0b625083aeb87bd3.pdf}
\end{singlespacing}
%%% ABJADBOOK END %%%

\begin{comment}
<abjad>
talea_rhythm_maker = new(
    talea_rhythm_maker,
    burnish_specifier=rhythmmakertools.BurnishSpecifier(
        left_classes=[Rest, Note],
        left_counts=[1],
        ),
    )
show(talea_rhythm_maker, divisions=divisions)
</abjad>
\end{comment}

%%% ABJADBOOK START %%%
\begin{singlespacing}
\vspace{-0.5\baselineskip}
\begin{lstlisting}
>>> talea_rhythm_maker = new(
...     talea_rhythm_maker,
...     burnish_specifier=rhythmmakertools.BurnishSpecifier(
...         left_classes=[Rest, Note],
...         left_counts=[1],
...         ),
...     )
>>> show(talea_rhythm_maker, divisions=divisions)
\end{lstlisting}
\noindent\includegraphics{assets/lilypond-61a4a24d2a5c1723853eb5642113f887.pdf}
\end{singlespacing}
%%% ABJADBOOK END %%%

\subsection{Composite rhythm makers} %%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%

\begin{comment}
<abjad>
composite_rhythm_maker = consort.CompositeRhythmMaker(
    default=note_rhythm_maker,
    last=incised_rhythm_maker,
    first=even_division_rhythm_maker,
    )
</abjad>
\end{comment}

%%% ABJADBOOK START %%%
\begin{singlespacing}
\vspace{-0.5\baselineskip}
\begin{lstlisting}
>>> composite_rhythm_maker = consort.CompositeRhythmMaker(
...     default=note_rhythm_maker,
...     last=incised_rhythm_maker,
...     first=even_division_rhythm_maker,
...     )
\end{lstlisting}
\end{singlespacing}
%%% ABJADBOOK END %%%

%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
\section{Modeling meter}
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%

Abjad models meter as a \emph{rhythm-tree} of nested, durated nodes which
outline a series of strongly and weakly accented offsets. The accent strength
of a particular offset found in a meter's rhythm-tree derives from the number
of nodes in that tree sharing that offset as a start or stop. The more nodes in
the rhythm-tree which share an offset, the greater the weight -- the
accentedness -- of that offset is taken to be. Abjad can construct the rhythm
tree for any meter from a numerator / denominator pair such as a rational
duration or time signature. Meter construction involves the progressive
division of the numerator of the input pair into groups of two and
threes\footnote{The factors 4 and 5 are also used in meter rhythm-tree
generation as they provide better typical results during meter rewriting.}, and
the decomposition of any other prime factors into groups of threes and twos.
Division by two always occurs before division by three, giving preference to
even metrical structures above odd or otherwise prime divisions. Constructing
rhythm-trees in this fashion gives results which generally align with common
practice expectations.

Consider the following 6/8 meter and its graph representation:

\begin{comment}
<abjad>
six_eight_meter = metertools.Meter((6, 8))
graph(six_eight_meter)
</abjad>
\end{comment}

%%% ABJADBOOK START %%%
\begin{singlespacing}
\vspace{-0.5\baselineskip}
\begin{lstlisting}
>>> six_eight_meter = metertools.Meter((6, 8))
>>> graph(six_eight_meter)
\end{lstlisting}
\noindent\includegraphics[scale=0.333]{assets/graphviz-6867ac3456c6ee33b782ab9744d80562.pdf}
\end{singlespacing}
%%% ABJADBOOK END %%%

\noindent The triangular and rectangular boxes indicate nodes in the
rhythm-tree itself. Rectangular boxes represent \enquote{beats} -- the leaves
of the rhythm-tree -- while triangular boxes indicate larger metrical
groupings. The ovals at the bottom of the graph indicate -- at their top -- the
start or stop offset of the nodes connected to them from above and -- at their
bottom -- the relative weight of their accent. The final oval on the right
indicates the offset and accent weight of the \enquote{next} downbeat.

The topmost triangle in the above graph represent the \enquote{highest}
metrical grouping in a 6/8 meter. Tracing the leftmost and rightmost arrows
down through the topmost node's children gives the offsets 0 and 3/4: the first
downbeat and next downbeat in a 6/8 meter. Offsets 0 and 3/4 also have the
strongest accent weights as they occur as either the start offset or stop
offset of nodes at three levels of hierarchy in the rhythm tree. At the second
level the 6/8 grouping divides into two 3/8 groupings, following common
practice expectations: metrical groupings tend to subdivide into groups of two
before they subdivide into groups of three\footnote{Consider a 12/8 meter.
Western musicians tend to subdivide twelve into either two groups of six or
four groups of three rather than into three groups of four.}. Both second-level
nodes share the offset of 3/8, which also occurs in the third level, giving 3/8
a weight of two. The third level contains the 1/8 duration beats, grouped by
their parents in the second level into two groups three 1/8 duration nodes. The
offsets 1/8, 1/4, 1/2 and 5/8 are not shared by any nodes except at the lowest
metrical level and therefore all receive an accent weight of one.

\subsection{Examples of meter} %%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%

Consider the following examples of meters modeled in Abjad.

A 3/4 meter consists of a top-level 3/4 metrical grouping divided into three
1/4 duration beats:

\begin{comment}
<abjad>
three_four_meter = metertools.Meter((3, 4))
graph(three_four_meter)
</abjad>
\end{comment}

%%% ABJADBOOK START %%%
\begin{singlespacing}
\vspace{-0.5\baselineskip}
\begin{lstlisting}
>>> three_four_meter = metertools.Meter((3, 4))
>>> graph(three_four_meter)
\end{lstlisting}
\noindent\includegraphics[scale=0.333]{assets/graphviz-106b9d861244019c8f4508e338f00c09.pdf}
\end{singlespacing}
%%% ABJADBOOK END %%%

\noindent By default, a 7/8 meter subdivides its top-level metrical grouping
into 3/8+2/8+2/8 groupings:

\begin{comment}
<abjad>
seven_eight_meter = metertools.Meter((7, 8))
graph(seven_eight_meter)
</abjad>
\end{comment}

%%% ABJADBOOK START %%%
\begin{singlespacing}
\vspace{-0.5\baselineskip}
\begin{lstlisting}
>>> seven_eight_meter = metertools.Meter((7, 8))
>>> graph(seven_eight_meter)
\end{lstlisting}
\noindent\includegraphics[scale=0.333]{assets/graphviz-bbce67419d7d935bfc4536be88d9d06a.pdf}
\end{singlespacing}
%%% ABJADBOOK END %%%

\noindent A 12/8 meter subdivides into four 3/8 duration groupings, each
containining three 1/8 duration beats:

\begin{comment}
<abjad>
twelve_eight_meter = metertools.Meter((12, 8))
graph(twelve_eight_meter)
</abjad>
\end{comment}

%%% ABJADBOOK START %%%
\begin{singlespacing}
\vspace{-0.5\baselineskip}
\begin{lstlisting}
>>> twelve_eight_meter = metertools.Meter((12, 8))
>>> graph(twelve_eight_meter)
\end{lstlisting}
\noindent\includegraphics[scale=0.333]{assets/graphviz-a4bd974839ddf0257ed007fe6f491351.pdf}
\end{singlespacing}
%%% ABJADBOOK END %%%

\subsection{Alternate meter representations} %%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%

Abjad permits alternate representations of meters with the same numerator and
denominator. The default interpretation of 4/4 generates a top-level rhythmic
grouping with a duration of 4/4 and four 1/4 beats as children\footnote{A
\enquote{flat} 4/4 metrical structure is useful for meter rewriting as it
allows the meter rewriting algorithm to ignore many common rhythmic idioms like
1/4+1/2+1/4 and 1/4+3/4.}.

\begin{comment}
<abjad>
four_four_meter = metertools.Meter((4, 4))
graph(four_four_meter)
</abjad>
\end{comment}

%%% ABJADBOOK START %%%
\begin{singlespacing}
\vspace{-0.5\baselineskip}
\begin{lstlisting}
>>> four_four_meter = metertools.Meter((4, 4))
>>> graph(four_four_meter)
\end{lstlisting}
\noindent\includegraphics[scale=0.333]{assets/graphviz-08a7fcb5e62e38947325ecc3e2f20393.pdf}
\end{singlespacing}
%%% ABJADBOOK END %%%

\noindent While meter objects are usually instantiated from numerator /
denominator pairs, with their rhythm-tree structure determined programmatically
from that input pair, they can also be instantiated from strings parseable as
rhythm-trees, or from RhythmTree objects themselves. All meters, because they
are implemented in terms of rhythm-trees, can be represented by a Lisp-like
rhythm-tree syntax:

\begin{comment}
<abjad>
print(four_four_meter.pretty_rtm_format)
</abjad>
\end{comment}

%%% ABJADBOOK START %%%
\begin{singlespacing}
\vspace{-0.5\baselineskip}
\begin{lstlisting}
>>> print(four_four_meter.pretty_rtm_format)
(4/4 (
	1/4
	1/4
	1/4
	1/4))
\end{lstlisting}
\end{singlespacing}
%%% ABJADBOOK END %%%

Instantiating meters from explicit rhythm tree syntax allows composers to
choose alternate representations of metrical structures. For example, a 4/4
meter which strongly emphasizes beat three is possible by subdividing the
top-level 4/4 metrical grouping into two 2/4 duration groupings, which are then
subdivided each into two 1/4 duration beats:

\begin{comment}
<abjad>
arbitrary_meter_1 = metertools.Meter('(4/4 ((2/4 (1/4 1/4)) (2/4 (1/4 1/4))))')
graph(arbitrary_meter_1)
</abjad>
\end{comment}

%%% ABJADBOOK START %%%
\begin{singlespacing}
\vspace{-0.5\baselineskip}
\begin{lstlisting}
>>> arbitrary_meter_1 = metertools.Meter('(4/4 ((2/4 (1/4 1/4)) (2/4 (1/4 1/4))))')
>>> graph(arbitrary_meter_1)
\end{lstlisting}
\noindent\includegraphics[scale=0.333]{assets/graphviz-70be4a3bd53912533a67115b8f59e873.pdf}
\end{singlespacing}
%%% ABJADBOOK END %%%

\noindent Unusual metrical structures are also possible, such as the following
4/4 meter which divides into two parts, with the first part dividing into two
again, and the second grouping of that divided into two again:

\begin{comment}
<abjad>
arbitrary_meter_2 = metertools.Meter('(4/4 ((2/4 (1/4 (1/4 (1/8 1/8)))) 1/2))')
graph(arbitrary_meter_2)
</abjad>
\end{comment}

%%% ABJADBOOK START %%%
\begin{singlespacing}
\vspace{-0.5\baselineskip}
\begin{lstlisting}
>>> arbitrary_meter_2 = metertools.Meter('(4/4 ((2/4 (1/4 (1/4 (1/8 1/8)))) 1/2))')
>>> graph(arbitrary_meter_2)
\end{lstlisting}
\noindent\includegraphics[scale=0.333]{assets/graphviz-22af4041cd4228849368d4ee27d55fbb.pdf}
\end{singlespacing}
%%% ABJADBOOK END %%%

%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
\section{Rewriting meters}
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%

Notated rhythms can be expressed in multiple ways while maintaining the same
attack-point and duration structure. \emph{Meter rewriting} formalizes the
process of re-notating a rhythm according to the offset structure inherent to
some meter while maintaining the original attack-points and durations.

Consider the following rhythm:

\begin{comment}
<abjad>
parseable = "abj: | 2/4 c'2 ~ |"
parseable += "| 4/4 c'32 d'2.. ~ d'16 e'32 ~ |"
parseable += "| 2/4 e'2 |"
staff = Staff(parseable)
show(staff)
</abjad>
\end{comment}

%%% ABJADBOOK START %%%
\begin{singlespacing}
\vspace{-0.5\baselineskip}
\begin{lstlisting}
>>> parseable = "abj: | 2/4 c'2 ~ |"
>>> parseable += "| 4/4 c'32 d'2.. ~ d'16 e'32 ~ |"
>>> parseable += "| 2/4 e'2 |"
>>> staff = Staff(parseable)
>>> show(staff)
\end{lstlisting}
\noindent\includegraphics{assets/lilypond-329490b244b088f012cb5146859cdab0.pdf}
\end{singlespacing}
%%% ABJADBOOK END %%%

The middle measure is notated in a perfectly valid manner. However, the
double-dotted D does not align with or break against any of the offsets of a
4/4 metrical structure: 0/4, 1/4, 2/4, 3/4 or 4/4.

\begin{comment}
<abjad>
four_four_meter = metertools.Meter((4, 4))
graph(four_four_meter)
</abjad>
\end{comment}

%%% ABJADBOOK START %%%
\begin{singlespacing}
\vspace{-0.5\baselineskip}
\begin{lstlisting}
>>> four_four_meter = metertools.Meter((4, 4))
>>> graph(four_four_meter)
\end{lstlisting}
\noindent\includegraphics[scale=0.333]{assets/graphviz-08a7fcb5e62e38947325ecc3e2f20393.pdf}
\end{singlespacing}
%%% ABJADBOOK END %%%

\begin{comment}
<abjad>
mutate(staff[1][:]).rewrite_meter(four_four_meter)
show(staff)
</abjad>
\end{comment}

%%% ABJADBOOK START %%%
\begin{singlespacing}
\vspace{-0.5\baselineskip}
\begin{lstlisting}
>>> mutate(staff[1][:]).rewrite_meter(four_four_meter)
>>> show(staff)
\end{lstlisting}
\noindent\includegraphics{assets/lilypond-52ed3c73b623b7b0d9a2c6230084a264.pdf}
\end{singlespacing}
%%% ABJADBOOK END %%%

\begin{comment}
<abjad>
two_two_meter = metertools.Meter((2, 2))
staff = Staff(parseable)
mutate(staff[1][:]).rewrite_meter(two_two_meter)
show(staff)
</abjad>
\end{comment}

%%% ABJADBOOK START %%%
\begin{singlespacing}
\vspace{-0.5\baselineskip}
\begin{lstlisting}
>>> two_two_meter = metertools.Meter((2, 2))
>>> staff = Staff(parseable)
>>> mutate(staff[1][:]).rewrite_meter(two_two_meter)
>>> show(staff)
\end{lstlisting}
\noindent\includegraphics{assets/lilypond-467c7a453dd4de93da0cc1c7acbe0a87.pdf}
\end{singlespacing}
%%% ABJADBOOK END %%%

\subsection{Dot count} %%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%

\begin{comment}
<abjad>
measure = Measure((3, 4), "c'32 d'8 e'8 fs'4...")
show(measure)
</abjad>
\end{comment}

%%% ABJADBOOK START %%%
\begin{singlespacing}
\vspace{-0.5\baselineskip}
\begin{lstlisting}
>>> measure = Measure((3, 4), "c'32 d'8 e'8 fs'4...")
>>> show(measure)
\end{lstlisting}
\noindent\includegraphics{assets/lilypond-8d4bc784b86bdade27d371532ab358a2.pdf}
\end{singlespacing}
%%% ABJADBOOK END %%%

\begin{comment}
<abjad>
mutate(measure[:]).rewrite_meter((3, 4))
show(measure)
</abjad>
\end{comment}

%%% ABJADBOOK START %%%
\begin{singlespacing}
\vspace{-0.5\baselineskip}
\begin{lstlisting}
>>> mutate(measure[:]).rewrite_meter((3, 4))
>>> show(measure)
\end{lstlisting}
\noindent\includegraphics{assets/lilypond-d4d52cf91b08080c4067643d24faaf2a.pdf}
\end{singlespacing}
%%% ABJADBOOK END %%%

\begin{comment}
<abjad>
measure = Measure((3, 4), "c'32 d'8 e'8 fs'4...")
mutate(measure[:]).rewrite_meter((3, 4), maximum_dot_count=2)
show(measure)
</abjad>
\end{comment}

%%% ABJADBOOK START %%%
\begin{singlespacing}
\vspace{-0.5\baselineskip}
\begin{lstlisting}
>>> measure = Measure((3, 4), "c'32 d'8 e'8 fs'4...")
>>> mutate(measure[:]).rewrite_meter((3, 4), maximum_dot_count=2)
>>> show(measure)
\end{lstlisting}
\noindent\includegraphics{assets/lilypond-40b68312fd44f949b40de163b21588c3.pdf}
\end{singlespacing}
%%% ABJADBOOK END %%%

\begin{comment}
<abjad>
measure = Measure((3, 4), "c'32 d'8 e'8 fs'4...")
mutate(measure[:]).rewrite_meter((3, 4), maximum_dot_count=1)
show(measure)
</abjad>
\end{comment}

%%% ABJADBOOK START %%%
\begin{singlespacing}
\vspace{-0.5\baselineskip}
\begin{lstlisting}
>>> measure = Measure((3, 4), "c'32 d'8 e'8 fs'4...")
>>> mutate(measure[:]).rewrite_meter((3, 4), maximum_dot_count=1)
>>> show(measure)
\end{lstlisting}
\noindent\includegraphics{assets/lilypond-5fba6e827130a27fefae4843d2b21248.pdf}
\end{singlespacing}
%%% ABJADBOOK END %%%

\begin{comment}
<abjad>
measure = Measure((3, 4), "c'32 d'8 e'8 fs'4...")
mutate(measure[:]).rewrite_meter((3, 4), maximum_dot_count=0)
show(measure)
</abjad>
\end{comment}

%%% ABJADBOOK START %%%
\begin{singlespacing}
\vspace{-0.5\baselineskip}
\begin{lstlisting}
>>> measure = Measure((3, 4), "c'32 d'8 e'8 fs'4...")
>>> mutate(measure[:]).rewrite_meter((3, 4), maximum_dot_count=0)
>>> show(measure)
\end{lstlisting}
\noindent\includegraphics{assets/lilypond-2ca50ee6f27ae56bae476fb9dc1faafa.pdf}
\end{singlespacing}
%%% ABJADBOOK END %%%

\subsection{Boundary depth} %%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%

\begin{comment}
<abjad>
nine_eight_meter = metertools.Meter((9, 8))
graph(nine_eight_meter)
</abjad>
\end{comment}

%%% ABJADBOOK START %%%
\begin{singlespacing}
\vspace{-0.5\baselineskip}
\begin{lstlisting}
>>> nine_eight_meter = metertools.Meter((9, 8))
>>> graph(nine_eight_meter)
\end{lstlisting}
\noindent\includegraphics[scale=0.333]{assets/graphviz-63c84e9823eef4be1a2ac91cc7cf5a3f.pdf}
\end{singlespacing}
%%% ABJADBOOK END %%%

\begin{comment}
<abjad>
measure = Measure((9, 8), "c'2 d'2 e'8")
show(measure)
</abjad>
\end{comment}

%%% ABJADBOOK START %%%
\begin{singlespacing}
\vspace{-0.5\baselineskip}
\begin{lstlisting}
>>> measure = Measure((9, 8), "c'2 d'2 e'8")
>>> show(measure)
\end{lstlisting}
\noindent\includegraphics{assets/lilypond-f459f8c64dd96ba762e4bdebba6f4680.pdf}
\end{singlespacing}
%%% ABJADBOOK END %%%

\begin{comment}
<abjad>
mutate(measure[:]).rewrite_meter(nine_eight_meter)
show(measure)
</abjad>
\end{comment}

%%% ABJADBOOK START %%%
\begin{singlespacing}
\vspace{-0.5\baselineskip}
\begin{lstlisting}
>>> mutate(measure[:]).rewrite_meter(nine_eight_meter)
>>> show(measure)
\end{lstlisting}
\noindent\includegraphics{assets/lilypond-63f30ee6e2e244440af9d6f1e0f84a02.pdf}
\end{singlespacing}
%%% ABJADBOOK END %%%

\begin{comment}
<abjad>
measure = Measure((9, 8), "c'2 d'2 e'8")
mutate(measure[:]).rewrite_meter(
    nine_eight_meter,
    boundary_depth=1,
    )
show(measure)
</abjad>
\end{comment}

%%% ABJADBOOK START %%%
\begin{singlespacing}
\vspace{-0.5\baselineskip}
\begin{lstlisting}
>>> measure = Measure((9, 8), "c'2 d'2 e'8")
>>> mutate(measure[:]).rewrite_meter(
...     nine_eight_meter,
...     boundary_depth=1,
...     )
>>> show(measure)
\end{lstlisting}
\noindent\includegraphics{assets/lilypond-93c0260083a9ae2ad25a3c7c064e3024.pdf}
\end{singlespacing}
%%% ABJADBOOK END %%%

\subsection{Example: disambiguating 3/4 \& 6/8} %%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%

\begin{comment}
<abjad>
staff = Staff(context_name='RhythmicStaff')
staff.extend("{ c'2 c'4 } { c'4. c'4. } { c'2 ~ c'8 c'8 }")
attach(TimeSignature((3, 4)), staff)
show(staff)
</abjad>
\end{comment}

%%% ABJADBOOK START %%%
\begin{singlespacing}
\vspace{-0.5\baselineskip}
\begin{lstlisting}
>>> staff = Staff(context_name='RhythmicStaff')
>>> staff.extend("{ c'2 c'4 } { c'4. c'4. } { c'2 ~ c'8 c'8 }")
>>> attach(TimeSignature((3, 4)), staff)
>>> show(staff)
\end{lstlisting}
\noindent\includegraphics{assets/lilypond-b4a2116ab0031b6068b1112932629bac.pdf}
\end{singlespacing}
%%% ABJADBOOK END %%%

\begin{comment}
<abjad>
for container in staff:
    mutate(container[:]).rewrite_meter((3, 4), boundary_depth=1)

show(staff)
</abjad>
\end{comment}

%%% ABJADBOOK START %%%
\begin{singlespacing}
\vspace{-0.5\baselineskip}
\begin{lstlisting}
>>> for container in staff:
...     mutate(container[:]).rewrite_meter((3, 4), boundary_depth=1)
...
>>> show(staff)
\end{lstlisting}
\noindent\includegraphics{assets/lilypond-0cef77f45f31e31ad271d15c9c32edf8.pdf}
\end{singlespacing}
%%% ABJADBOOK END %%%

\begin{comment}
<abjad>
staff = Staff(context_name='RhythmicStaff')
staff.extend("{ c'2 c'4 } { c'4. c'4. } { c'2 ~ c'8 c'8 }")
attach(TimeSignature((6, 8)), staff)
for container in staff:
    mutate(container[:]).rewrite_meter((6, 8), boundary_depth=1)

show(staff)
</abjad>
\end{comment}

%%% ABJADBOOK START %%%
\begin{singlespacing}
\vspace{-0.5\baselineskip}
\begin{lstlisting}
>>> staff = Staff(context_name='RhythmicStaff')
>>> staff.extend("{ c'2 c'4 } { c'4. c'4. } { c'2 ~ c'8 c'8 }")
>>> attach(TimeSignature((6, 8)), staff)
>>> for container in staff:
...     mutate(container[:]).rewrite_meter((6, 8), boundary_depth=1)
...
>>> show(staff)
\end{lstlisting}
\noindent\includegraphics{assets/lilypond-58a85c4734fd2a15643aa2409cbff0e5.pdf}
\end{singlespacing}
%%% ABJADBOOK END %%%

\subsection{Recursive meter rewriting} %%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%

\begin{comment}
<abjad>
parseable = "abj: | 4/4 c'16 ~ c'4 d'8. ~ "
parseable += "2/3 { d'8. ~ 3/5 { d'16 e'8 ~ e'16 f'16 ~ } } "
parseable += "f'4 |"
measure = parse(parseable)
show(measure)
</abjad>
\end{comment}

%%% ABJADBOOK START %%%
\begin{singlespacing}
\vspace{-0.5\baselineskip}
\begin{lstlisting}
>>> parseable = "abj: | 4/4 c'16 ~ c'4 d'8. ~ "
>>> parseable += "2/3 { d'8. ~ 3/5 { d'16 e'8 ~ e'16 f'16 ~ } } "
>>> parseable += "f'4 |"
>>> measure = parse(parseable)
>>> show(measure)
\end{lstlisting}
\noindent\includegraphics{assets/lilypond-270f471c0052391c9bf1a5df2ccc4474.pdf}
\end{singlespacing}
%%% ABJADBOOK END %%%

\begin{comment}
<abjad>
mutate(measure[:]).rewrite_meter(
    measure,
    boundary_depth=1,
    )
show(measure)
</abjad>
\end{comment}

%%% ABJADBOOK START %%%
\begin{singlespacing}
\vspace{-0.5\baselineskip}
\begin{lstlisting}
>>> mutate(measure[:]).rewrite_meter(
...     measure,
...     boundary_depth=1,
...     )
>>> show(measure)
\end{lstlisting}
\noindent\includegraphics{assets/lilypond-f7aa660690e64db249ef36ea1eac5ace.pdf}
\end{singlespacing}
%%% ABJADBOOK END %%%

%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
\section{Finding meters}
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%

How can we generate a series of meters?

A meter's weighted-offset pattern can be used as 1-dimensional kernel, or
convolution matrix, to determine how strongly an arbitrary collection of
offsets appears to express that meter.

Abjad's \texttt{metertools} provides a \texttt{MetricAccentKernel} class.

\subsection{Offset counters} %%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%

Before convolving a meter with a collection of offsets, those offsets need to
be extracted. The \texttt{MetricAccentKernel} class'
\texttt{count\_offsets\_in\_expr()} method collects offsets in its input
expression into an \emph{offset counter} -- a mapping of offsets to the number
of times those offsets appear. Offsets which appear multiple times in the input
expression will result in a higher count in the generated offset counter, and
will in turn have a greater influence during the meter convolution process.

Consider the following score example:

\begin{comment}
<abjad>
upper_staff = Staff("c'8 d'4. e'8 f'4.")
lower_staff = Staff(r'\clef bass c4 b,4 a,2')
piano_staff = scoretools.StaffGroup(
    [upper_staff, lower_staff],
    context_name='PianoStaff',
    )
show(piano_staff)
</abjad>
\end{comment}

%%% ABJADBOOK START %%%
\begin{singlespacing}
\vspace{-0.5\baselineskip}
\begin{lstlisting}
>>> upper_staff = Staff("c'8 d'4. e'8 f'4.")
>>> lower_staff = Staff(r'\clef bass c4 b,4 a,2')
>>> piano_staff = scoretools.StaffGroup(
...     [upper_staff, lower_staff],
...     context_name='PianoStaff',
...     )
>>> show(piano_staff)
\end{lstlisting}
\noindent\includegraphics{assets/lilypond-bf3a249e2b4eac93b1884bab1a122a10.pdf}
\end{singlespacing}
%%% ABJADBOOK END %%%

\noindent The offsets found in all of the leaves of the score can be counted by
selecting the score's leaves and passing that selection to
\texttt{count\_offsets\_in\_expr()}.

\begin{comment}
<abjad>
leaves = piano_staff.select_leaves(allow_discontiguous_leaves=True)
piano_staff_counter = metertools.OffsetCounter(leaves)
print(format(piano_staff_counter))
show(piano_staff_counter)
</abjad>
\end{comment}

%%% ABJADBOOK START %%%
\begin{singlespacing}
\vspace{-0.5\baselineskip}
\begin{lstlisting}
>>> leaves = piano_staff.select_leaves(allow_discontiguous_leaves=True)
>>> piano_staff_counter = metertools.OffsetCounter(leaves)
>>> print(format(piano_staff_counter))
metertools.OffsetCounter(
    {
        durationtools.Offset(0, 1): 2,
        durationtools.Offset(1, 8): 2,
        durationtools.Offset(1, 4): 2,
        durationtools.Offset(1, 2): 4,
        durationtools.Offset(5, 8): 2,
        durationtools.Offset(1, 1): 2,
        }
    )
\end{lstlisting}
\begin{lstlisting}
>>> show(piano_staff_counter)
\end{lstlisting}
\noindent\includegraphics{assets/lilypond-e7e0f6dd3388803a5b2918be8cbca787.pdf}
\end{singlespacing}
%%% ABJADBOOK END %%%

\noindent Note that the offset 1/2 shows a count of 4. This is because 1/2 acts
as both the start and stop offset for four separate leaves in the score.

Offset counters can also be generated from timespan inventories, allowing meter
convolution to be used without reference to any score objects at all:

\begin{comment}
<abjad>
timespans = timespantools.TimespanInventory([
    timespantools.Timespan(-1, 10),
    timespantools.Timespan(5, 15),
    timespantools.Timespan(15, 20),
    timespantools.Timespan(10, 15),
    ])
timespan_counter = metertools.OffsetCounter(timespans)
show(timespan_counter)
</abjad>
\end{comment}

%%% ABJADBOOK START %%%
\begin{singlespacing}
\vspace{-0.5\baselineskip}
\begin{lstlisting}
>>> timespans = timespantools.TimespanInventory([
...     timespantools.Timespan(-1, 10),
...     timespantools.Timespan(5, 15),
...     timespantools.Timespan(15, 20),
...     timespantools.Timespan(10, 15),
...     ])
>>> timespan_counter = metertools.OffsetCounter(timespans)
>>> show(timespan_counter)
\end{lstlisting}
\noindent\includegraphics{assets/lilypond-b1bd125d9097c686a9d82b1371c4607b.pdf}
\end{singlespacing}
%%% ABJADBOOK END %%%

\subsection{Metric accent kernels} %%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%

As demonstrated earlier, meters describe a sequence of offsets with varying
degrees of weight, or accentedness, attributed to each offset. Downbeats have a
stronger accent than upbeats, the half-way beat of a 6/8 measure is less strong
than the downbeat but stronger than any of the others, etc.

\begin{comment}
<abjad>
meter = metertools.Meter((4, 4))
kernel_44 = metertools.MetricAccentKernel.from_meter(meter, denominator=8)
for offset, weight in sorted(kernel_44.kernel.items()):
    print('{!s}\t{!s}'.format(offset, weight))

</abjad>
\end{comment}

%%% ABJADBOOK START %%%
\begin{singlespacing}
\vspace{-0.5\baselineskip}
\begin{lstlisting}
>>> meter = metertools.Meter((4, 4))
>>> kernel_44 = metertools.MetricAccentKernel.from_meter(meter, denominator=8)
>>> for offset, weight in sorted(kernel_44.kernel.items()):
...     print('{!s}\t{!s}'.format(offset, weight))
...
0	3/16
1/8	1/16
1/4	1/8
3/8	1/16
1/2	1/8
5/8	1/16
3/4	1/8
7/8	1/16
1	3/16
\end{lstlisting}
\end{singlespacing}
%%% ABJADBOOK END %%%

\noindent The 4/4 metric accent kernel can be called against an offset counter
-- as though it were a function -- to generate a response via a kind of simple
offset-wise convolution. The count at each offset in the input offset counter
is multiplied against the weight at the corresponding offset in the metric
accent kernel. If no corresponding offset exists in the kernel, the weight is
taken as 0. The weighted counts are then added together and returned.

\begin{comment}
<abjad>
response = kernel_44(piano_staff_counter)
float(response)
</abjad>
\end{comment}

%%% ABJADBOOK START %%%
\begin{singlespacing}
\vspace{-0.5\baselineskip}
\begin{lstlisting}
>>> response = kernel_44(piano_staff_counter)
>>> float(response)
0.75
\end{lstlisting}
\end{singlespacing}
%%% ABJADBOOK END %%%

\begin{comment}
<abjad>
total = Multiplier(0, 1)
for offset, count in sorted(piano_staff_counter.items()):
    weight = Multiplier(0, 1)
    if offset in kernel_44.kernel:
        weight = kernel_44.kernel[offset]
    weighted_count = weight * count
    total += weighted_count
    print(offset, count, weight, weighted_count, total)

</abjad>
\end{comment}

%%% ABJADBOOK START %%%
\begin{singlespacing}
\vspace{-0.5\baselineskip}
\begin{lstlisting}
>>> total = Multiplier(0, 1)
>>> for offset, count in sorted(piano_staff_counter.items()):
...     weight = Multiplier(0, 1)
...     if offset in kernel_44.kernel:
...         weight = kernel_44.kernel[offset]
...     weighted_count = weight * count
...     total += weighted_count
...     print(offset, count, weight, weighted_count, total)
...
(Offset(0, 1), 2, Multiplier(3, 16), Multiplier(3, 8), Multiplier(3, 8))
(Offset(1, 8), 2, Multiplier(1, 16), Multiplier(1, 8), Multiplier(1, 2))
(Offset(1, 4), 2, Multiplier(1, 8), Multiplier(1, 4), Multiplier(3, 4))
(Offset(1, 2), 4, Multiplier(1, 8), Multiplier(1, 2), Multiplier(5, 4))
(Offset(5, 8), 2, Multiplier(1, 16), Multiplier(1, 8), Multiplier(11, 8))
(Offset(1, 1), 2, Multiplier(3, 16), Multiplier(3, 8), Multiplier(7, 4))
\end{lstlisting}
\end{singlespacing}
%%% ABJADBOOK END %%%

\noindent Now consider the metric accent kernels for 3/4, 7/8 and 5/4 meters:

\begin{comment}
<abjad>
kernel_34 = metertools.MetricAccentKernel.from_meter((3, 4), denominator=8)
kernel_78 = metertools.MetricAccentKernel.from_meter((7, 8), denominator=8)
kernel_54 = metertools.MetricAccentKernel.from_meter((5, 4), denominator=8)
</abjad>
\end{comment}

%%% ABJADBOOK START %%%
\begin{singlespacing}
\vspace{-0.5\baselineskip}
\begin{lstlisting}
>>> kernel_34 = metertools.MetricAccentKernel.from_meter((3, 4), denominator=8)
>>> kernel_78 = metertools.MetricAccentKernel.from_meter((7, 8), denominator=8)
>>> kernel_54 = metertools.MetricAccentKernel.from_meter((5, 4), denominator=8)
\end{lstlisting}
\end{singlespacing}
%%% ABJADBOOK END %%%

\noindent We can generate an response for each of these kernels against the
piano staff offset counter.

\begin{comment}
<abjad>
float(kernel_34(piano_staff_counter))
float(kernel_78(piano_staff_counter))
float(kernel_54(piano_staff_counter))
</abjad>
\end{comment}

%%% ABJADBOOK START %%%
\begin{singlespacing}
\vspace{-0.5\baselineskip}
\begin{lstlisting}
>>> float(kernel_34(piano_staff_counter))
0.6923076923076923
\end{lstlisting}
\begin{lstlisting}
>>> float(kernel_78(piano_staff_counter))
0.5714285714285714
\end{lstlisting}
\begin{lstlisting}
>>> float(kernel_54(piano_staff_counter))
0.5789473684210527
\end{lstlisting}
\end{singlespacing}
%%% ABJADBOOK END %%%

\noindent Note that the previously recorded response for a 4/4 meter is still
higher than any of these.

\subsection{Meter fitting} %%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%

\begin{comment}
<abjad>
permitted_meters = metertools.MeterInventory([(3, 4), (4, 4), (5, 4)])
show(permitted_meters, range_=(0, 5))
</abjad>
\end{comment}

%%% ABJADBOOK START %%%
\begin{singlespacing}
\vspace{-0.5\baselineskip}
\begin{lstlisting}
>>> permitted_meters = metertools.MeterInventory([(3, 4), (4, 4), (5, 4)])
>>> show(permitted_meters, range_=(0, 5))
\end{lstlisting}
\noindent\includegraphics{assets/lilypond-31dbd605fcbbe87dfbcd07de41bd855c.pdf}
\end{singlespacing}
%%% ABJADBOOK END %%%

\begin{comment}
<abjad>
offsets = [(0, 4), (4, 4), (8, 4), (12, 4), (16, 4)]
fitted_meters = metertools.Meter.fit_meters_to_expr(
    expr=offsets,
    meters=permitted_meters,
    )
show(fitted_meters, range_=(0, 5))
</abjad>
\end{comment}

%%% ABJADBOOK START %%%
\begin{singlespacing}
\vspace{-0.5\baselineskip}
\begin{lstlisting}
>>> offsets = [(0, 4), (4, 4), (8, 4), (12, 4), (16, 4)]
>>> fitted_meters = metertools.Meter.fit_meters_to_expr(
...     expr=offsets,
...     meters=permitted_meters,
...     )
>>> show(fitted_meters, range_=(0, 5))
\end{lstlisting}
\noindent\includegraphics{assets/lilypond-87d6adf99e6b33011031d78cb538bee0.pdf}
\end{singlespacing}
%%% ABJADBOOK END %%%

\begin{comment}
<abjad>
offsets = [(0, 4), (3, 4), (5, 4), (10, 4), (15, 4), (20, 4)]
fitted_meters = metertools.Meter.fit_meters_to_expr(
    expr=offsets,
    meters=permitted_meters,
    )
show(fitted_meters, range_=(0, 5))
</abjad>
\end{comment}

%%% ABJADBOOK START %%%
\begin{singlespacing}
\vspace{-0.5\baselineskip}
\begin{lstlisting}
>>> offsets = [(0, 4), (3, 4), (5, 4), (10, 4), (15, 4), (20, 4)]
>>> fitted_meters = metertools.Meter.fit_meters_to_expr(
...     expr=offsets,
...     meters=permitted_meters,
...     )
>>> show(fitted_meters, range_=(0, 5))
\end{lstlisting}
\noindent\includegraphics{assets/lilypond-0643372c67f34019274214d442a017f5.pdf}
\end{singlespacing}
%%% ABJADBOOK END %%%

\begin{comment}
<abjad>
offsets = [(0, 4), (3, 4), (5, 4), (10, 4), (15, 4), (20, 4)]
fitted_meters = metertools.Meter.fit_meters_to_expr(
    expr=offsets,
    meters=permitted_meters,
    maximum_run_length=1,
    )
show(fitted_meters, range_=(0, 5))
</abjad>
\end{comment}

%%% ABJADBOOK START %%%
\begin{singlespacing}
\vspace{-0.5\baselineskip}
\begin{lstlisting}
>>> offsets = [(0, 4), (3, 4), (5, 4), (10, 4), (15, 4), (20, 4)]
>>> fitted_meters = metertools.Meter.fit_meters_to_expr(
...     expr=offsets,
...     meters=permitted_meters,
...     maximum_run_length=1,
...     )
>>> show(fitted_meters, range_=(0, 5))
\end{lstlisting}
\noindent\includegraphics{assets/lilypond-315840be1333279e3037a5168570f3d2.pdf}
\end{singlespacing}
%%% ABJADBOOK END %%%

\subsection{Example}

\begin{comment}
<abjad>
music_specifiers = collections.OrderedDict([
    ('Voice 1', None),
    ('Voice 2', None),
    ('Voice 3', None),
    ('Voice 4', None),
    ])
target_timespan = timespantools.Timespan(0, (19, 4))
timespan_inventory = talea_timespan_maker(
    music_specifiers=music_specifiers,
    target_timespan=target_timespan,
    )
show(timespan_inventory, key='voice_name')
</abjad>
\end{comment}

%%% ABJADBOOK START %%%
\begin{singlespacing}
\vspace{-0.5\baselineskip}
\begin{lstlisting}
>>> music_specifiers = collections.OrderedDict([
...     ('Voice 1', None),
...     ('Voice 2', None),
...     ('Voice 3', None),
...     ('Voice 4', None),
...     ])
>>> target_timespan = timespantools.Timespan(0, (19, 4))
>>> timespan_inventory = talea_timespan_maker(
...     music_specifiers=music_specifiers,
...     target_timespan=target_timespan,
...     )
>>> show(timespan_inventory, key='voice_name')
\end{lstlisting}
\noindent\includegraphics{assets/lilypond-a056ab693faf200c126ed5415e3dfcc5.pdf}
\end{singlespacing}
%%% ABJADBOOK END %%%

\begin{comment}
<abjad>
permitted_meters = metertools.MeterInventory([
    (5, 8), (3, 4), (6, 8), (7, 8), (4, 4),
    ])
offset_counter = timespan_inventory.count_offsets()
fitted_meters = metertools.Meter.fit_meters_to_expr(
    expr=offset_counter,
    meters=permitted_meters,
    maximum_run_length=1,
    )
for illustratable in (offset_counter, fitted_meters):
    show(illustratable, range_=(0, (19, 4)))

</abjad>
\end{comment}

%%% ABJADBOOK START %%%
\begin{singlespacing}
\vspace{-0.5\baselineskip}
\begin{lstlisting}
>>> permitted_meters = metertools.MeterInventory([
...     (5, 8), (3, 4), (6, 8), (7, 8), (4, 4),
...     ])
>>> offset_counter = timespan_inventory.count_offsets()
>>> fitted_meters = metertools.Meter.fit_meters_to_expr(
...     expr=offset_counter,
...     meters=permitted_meters,
...     maximum_run_length=1,
...     )
>>> for illustratable in (offset_counter, fitted_meters):
...     show(illustratable, range_=(0, (19, 4)))
...
\end{lstlisting}
\noindent\includegraphics{assets/lilypond-be25d981b367563167fb0dc45a384d69.pdf}\\
\noindent\includegraphics{assets/lilypond-aad18416071e17a39304452a4e7610cb.pdf}
\end{singlespacing}
%%% ABJADBOOK END %%%

%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
\section{Implications}
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%

Factories

Timespans allow for large scale phrasing and density structures

A description of what sort of material should appear in approximate locations
is possible.

Timespans also allow for overlap, and have affordances for masking. This allows
timespans to be created by a factories in layers, and those layers resolved
down to a single non-overlapping layer via masking.